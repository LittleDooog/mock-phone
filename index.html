<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æ‰‹æœº - AI èŠå¤©æ¨¡æ‹Ÿå™¨</title>
    
    <style>
        /* 1. æ‰‹æœºå¤–å£³å’Œå±…ä¸­ */
        body {
            /* æ¢å¤å±…ä¸­å¸ƒå±€ï¼Œä»…åœ¨å¤§å±å¹•ä¸‹ç”Ÿæ•ˆ */
            display: flex; 
            justify-content: center;
            align-items: center;
            
            min-height: 100vh;
            margin: 0;
            background-color: #e0e0e0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 100vw; 
        }

        /* 2. æ¨¡æ‹Ÿæ‰‹æœºå±å¹• */
        .phone-screen {
            width: 375px; 
            height: 667px; 
            
            background-color: #f8f8f8;
            border: 1px solid #333; 
            border-radius: 40px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2); 

            position: relative; /* å…³é”®ï¼šç¡®ä¿é•¿æŒ‰èœå•ç»å¯¹å®šä½çš„ä¸Šä¸‹æ–‡ */
            overflow: hidden;
            display: flex; /* å…³é”®ï¼šå¯ç”¨ Flex å¸ƒå±€ */
            flex-direction: column; /* å…³é”®ï¼šå­å…ƒç´ å‚ç›´æ’åˆ— */
        }

        /* åª’ä½“æŸ¥è¯¢ï¼šåœ¨å°å±å¹•ï¼ˆæ‰‹æœºï¼‰ä¸Šåº”ç”¨å…¨å±æ ·å¼ */
        @media screen and (max-width: 768px) {
            .phone-screen {
                width: 100vw;  
                height: 100vh; 
                border: none; 
                border-radius: 0; 
                box-shadow: none; 
            }
        }

        /* 3. é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 30px;
            background-color: #f8f8f8;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #ddd;
        }

        /* 4. å¤´éƒ¨å¯¼èˆª (Home/è¿”å›) */
        .header {
            height: 44px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
            z-index: 10;
            position: relative; 
            width: 100%; 
            box-sizing: border-box;
        }
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            flex-grow: 1;
            text-align: center;
            margin: 0;
            padding: 0 50px; /* å¢åŠ å·¦å³å†…è¾¹è·ï¼Œé˜²æ­¢ä¸æŒ‰é’®é‡å  */
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .back-btn, .home-btn {
            font-size: 16px; 
            color: #007aff;
            cursor: pointer;
            z-index: 20; 
            position: absolute; 
            left: 15px; 
            font-weight: 400; 
        }
        
        /* 5. æ ¸å¿ƒå†…å®¹åŒºåŸŸ (appContainer) */
        .content {
            flex-grow: 1; /* å…³é”®ï¼šç¡®ä¿å æ® phone-screen å‰©ä½™çš„å‚ç›´ç©ºé—´ */
            overflow-y: auto;
            padding: 20px; 
            background-color: #fff;
            position: relative;
        }

        /* 6. ä¸»é¡µå›¾æ ‡ç½‘æ ¼ */
        .app-grid {
            display: flex;
            flex-wrap: wrap;
            padding-top: 20px;
        }
        .app-icon {
            width: 80px;
            height: 80px;
            margin: 10px;
            text-align: center;
            cursor: pointer;
        }
        .app-icon img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-icon p {
            margin: 5px 0 0;
            font-size: 12px;
            color: #333;
        }

        /* 7. API è®¾ç½®é¡µé¢æ ·å¼ */
        .api-settings {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        .api-settings label {
            display: block;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        /* æ–°å¢/ä¿®å¤ï¼šAPI å†…å®¹åŒºåŸŸæ ·å¼ */
        .api-content {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 20px;
            background-color: #fff; 
        }
        .api-settings input[type="text"], .api-settings input[type="password"], .api-settings select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .save-btn {
            width: 100%;
            padding: 12px;
            margin-top: 25px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .save-btn:hover {
            background-color: #0056b3;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            background-color: #f0f0f0;
        }
        .api-content textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            resize: none; 
        }
        
        /* 8. èŠå¤©/è§’è‰²åˆ—è¡¨é¡µé¢æ ·å¼ */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* å…³é”®ï¼šå‚ç›´å¸ƒå±€ */
            overflow: hidden;
            padding: 0;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f8f8;
        }
        .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #fff;
        }
        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 16px;
        }
        .chat-input-area button {
            padding: 10px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        .chat-input-area button:disabled {
            background-color: #a0c4ff;
            cursor: default;
        }

        /* 9. æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
        .message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message.sent {
            background-color: #007aff;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            background-color: #e5e5ea;
            color: black;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .message.thinking {
            background-color: #ffe0b2; 
            color: #333;
            margin-right: auto;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1.0; }
            100% { opacity: 0.6; }
        }
        
        /* 10. è§’è‰²åˆ—è¡¨å’ŒæŒ‰é’®æ ·å¼ */
        .add-model-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .add-role-btn {
            font-size: 24px;
            color: #007aff;
            cursor: pointer;
            z-index: 20;
            position: absolute;
            right: 15px;
            font-weight: 400;
        }
        .role-list-content {
            padding: 0; 
            background-color: #fff;
        }
        .role-card {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .role-card:active {
            background-color: #f0f0f0;
        }
        .role-avatar {
            width: 45px;
            height: 45px;
            background-color: #007aff;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin-right: 15px;
        }
        .role-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .role-info p {
            margin: 2px 0 0;
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }

        /* 11. è§’è‰²æ“ä½œå¼¹å‡ºèœå•æ ·å¼ (ä¿®å¤ Z-Index å’Œå®šä½) */
        #roleActionMenu {
            position: absolute; /* é™åˆ¶åœ¨ phone-screen å†…éƒ¨ */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            /* å…³é”®ä¿®å¤ï¼šé»˜è®¤éšè—ï¼Œä¸å“åº”ç‚¹å‡» */
            visibility: hidden; 
            pointer-events: none; 
            background: rgba(0, 0, 0, 0.4); 
        }
        /* å½“ JS æ¿€æ´»æ—¶ï¼Œæ¢å¤å¯è§æ€§å’Œç‚¹å‡» */
        #roleActionMenu.is-active {
            visibility: visible !important; 
            pointer-events: auto !important; 
        }

        .menu-content {
            position: absolute; /* é™åˆ¶åœ¨ phone-screen å†…éƒ¨ */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 15px;
            z-index: 1001;
            transition: bottom 0.3s ease-out;
            margin-bottom: 20px; 
        }
        .menu-content button {
            width: 100%;
            padding: 15px;
            margin-bottom: 8px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: white;
            color: #007aff;
        }
        .menu-content button#deleteRoleBtn {
            color: #dc3545; 
        }
    </style>
</head>
<body>

    <div class="phone-screen">
        <div class="status-bar">
            <span>9:41 AM</span>
            <span>LTE</span>
            <span>ğŸ”‹ 100%</span>
        </div>

        <div id="appContainer" class="content">
            
            <div id="homeScreen">
                <div class="app-grid">
                    <div class="app-icon" onclick="showApp('api')">
                        <img src="https://img.icons8.com/color/96/key.png" alt="API Key Icon">
                        <p>API</p>
                    </div>
                    <div class="app-icon" onclick="showApp('chat')">
                        <img src="https://img.icons8.com/color/96/speech-bubble--v1.png" alt="èŠå¤©å›¾æ ‡">
                        <p>èŠå¤©</p>
                    </div>
                </div>
            </div>

            <div id="apiScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>API è®¾ç½®</h1>
                </div>
                <div class="api-content"> 
                    <label for="apiUrl">åä»£åœ°å€ (URL):</label>
                    <input type="text" id="apiUrl" placeholder="ä¾‹å¦‚: https://gcli.ggchan.dev">

                    <label for="apiKey">API å¯†é’¥ (Key):</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„ Key">
                    
                    <button class="save-btn" onclick="fetchModelsAndSave()">æ‹‰å–æ¨¡å‹å¹¶ä¿å­˜</button> 

                    <div id="modelSelectionArea" style="display: none; margin-top: 20px;">
                        <label for="modelSelect">é€‰æ‹©æ¨¡å‹:</label>
                        <select id="modelSelect">
                            <option value="">è¯·å…ˆæ‹‰å–æ¨¡å‹...</option>
                        </select>
                        
                        <label for="customModelInput" style="margin-top: 20px;">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°:</label>
                        <input type="text" id="customModelInput" placeholder="ä¾‹å¦‚: gemini-2.5-flash">
                        <button class="add-model-btn" onclick="addCustomModel()">æ·»åŠ å¹¶ä½¿ç”¨</button>
                    </div>

                    <div id="apiStatus" class="status-message" style="margin-top: 20px;">
                        å½“å‰çŠ¶æ€: æœªé…ç½®
                    </div>
                </div>
            </div>

            <div id="roleListScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>æ¶ˆæ¯</h1>
                    <span class="add-role-btn" onclick="showApp('roleManager')">â•</span>
                </div>
                
                <div id="roleList" class="content role-list-content">
                    <div style="text-align: center; color: #888; margin-top: 50px;">
                        æš‚æ— è§’è‰²ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ã€‚
                    </div>
                </div>
            </div>

            <div id="roleManagerScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1>ç®¡ç†è§’è‰²</h1>
                </div>
                <div class="api-content">
                    <label for="roleName">è§’è‰²åç§°:</label>
                    <input type="text" id="roleName" placeholder="ä¾‹å¦‚: å†·é™çš„å®¢æœæœºå™¨äºº">

                    <label for="systemPrompt">ç³»ç»Ÿæç¤ºè¯ (Prompt):</label>
                    <textarea id="systemPrompt" rows="5" placeholder="ä¾‹å¦‚: ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€å†·é™çš„å®¢æœã€‚è¯·ç®€æ´åœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚"></textarea>

                    <label for="roleModelSelect">é€‰æ‹©æ¨¡å‹:</label>
                    <select id="roleModelSelect">
                        </select>
                    
                    <button class="save-btn" onclick="saveRole()">ä¿å­˜è§’è‰²</button> 
                    <button class="delete-btn" onclick="deleteRole()" style="margin-top: 10px; background-color: #dc3545;">åˆ é™¤è§’è‰²</button> 
                </div>
            </div>

            <div id="chatDetailScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1 id="chatDetailTitle">è§’è‰²åç§°</h1>
                </div>
                <div id="chatMessages" class="chat-messages">
                    </div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...">
                    <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>

        </div> <div id="roleActionMenu" style="display: none;">
            <div id="menuContent" class="menu-content">
                <button id="deleteRoleBtn" onclick="confirmDeleteRole()">åˆ é™¤è§’è‰²</button>
                <button onclick="hideRoleActionMenu()">å–æ¶ˆ</button>
            </div>
        </div>
        
    </div> <script>
        // 1. å…¨å±€å˜é‡å’Œåˆå§‹åŒ–
        let currentScreen = 'home';
        const screens = {
            home: document.getElementById('homeScreen'),
            api: document.getElementById('apiScreen'),
            roleList: document.getElementById('roleListScreen'),
            roleManager: document.getElementById('roleManagerScreen'),
            chatDetail: document.getElementById('chatDetailScreen')
        };
        let roles = [];
        let currentRoleId = null;
        
        // åˆå§‹åŠ è½½ï¼šè¯»å–æœ¬åœ°å­˜å‚¨
        window.onload = function() {
            document.getElementById('apiUrl').value = localStorage.getItem('apiUrl') || '';
            document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
            
            if (localStorage.getItem('apiUrl') && localStorage.getItem('apiKey')) {
                useHardcodedModels(); 
                const selectedModel = localStorage.getItem('selectedModel');
                if (selectedModel) {
                    const modelSelect = document.getElementById('modelSelect');
                    if (modelSelect.querySelector(`option[value="${selectedModel}"]`)) {
                        modelSelect.value = selectedModel;
                    } else {
                        const option = document.createElement('option');
                        option.value = selectedModel;
                        option.textContent = selectedModel;
                        modelSelect.appendChild(option);
                        modelSelect.value = selectedModel;
                    }
                }
                document.getElementById('modelSelectionArea').style.display = 'block';
                document.getElementById('apiStatus').style.color = 'gray';
                document.getElementById('apiStatus').textContent = 'å½“å‰çŠ¶æ€: å·²åŠ è½½ä¸Šæ¬¡é…ç½®ï¼Œè¯·ç‚¹å‡»â€œæ‹‰å–æ¨¡å‹â€éªŒè¯ã€‚';
            }
            
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            loadRoleList(); 
        };

        // 2. å±å¹•åˆ‡æ¢å‡½æ•°
        function showScreen(screenName) {
            for (let key in screens) {
                screens[key].style.display = 'none';
            }
            screens[screenName].style.display = 'flex'; 
            currentScreen = screenName;
        }

        function showHomeScreen() {
            document.getElementById('homeScreen').style.display = 'block'; 
            screens['api'].style.display = 'none';
            screens['roleList'].style.display = 'none';
            screens['roleManager'].style.display = 'none';
            screens['chatDetail'].style.display = 'none';
            currentScreen = 'home';
        }
        
        function showApp(appName) {
            screens['home'].style.display = 'none';
            screens['api'].style.display = 'none';
            screens['roleList'].style.display = 'none';
            screens['roleManager'].style.display = 'none';
            screens['chatDetail'].style.display = 'none';

            if (appName === 'roleList') {
                screens['roleList'].style.display = 'flex';
                loadRoleList(); 
            } else if (appName === 'roleManager') {
                screens['roleManager'].style.display = 'flex';
                loadModelSelectForRole(); 
            } else if (appName === 'chatDetail') {
                screens['chatDetail'].style.display = 'flex';
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else if (appName === 'api') {
                screens['api'].style.display = 'flex';
            } else if (appName === 'chat') { 
                showApp('roleList');
            }
        }
        
        // --- API è®¾ç½®æ ¸å¿ƒé€»è¾‘ ---

        // 3. è¾…åŠ©å‡½æ•°ï¼šæä¾›ç¡¬ç¼–ç çš„æ¨¡å‹åˆ—è¡¨ (ä½œä¸ºæ‹‰å–å¤±è´¥çš„å¤‡ç”¨)
        function getHardcodedModels() {
            return {
                provider: "å†…ç½®é€šç”¨æœåŠ¡",
                models: [
                    'gemini-2.5-flash', 
                    'gemini-2.5-pro',
                    'gpt-4o',
                    'gpt-3.5-turbo',
                    'claude-3-sonnet'
                ]
            };
        }
        
        // 4. æ–°å¢ï¼šä½¿ç”¨ç¡¬ç¼–ç æ¨¡å‹åˆ—è¡¨ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
        function useHardcodedModels() {
            const modelSelect = document.getElementById('modelSelect');
            const statusElement = document.getElementById('apiStatus');
            const { models, provider } = getHardcodedModels();
            
            modelSelect.innerHTML = '';
            models.forEach((model, index) => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
                if (index === 0) {
                    modelSelect.value = model;
                    localStorage.setItem('selectedModel', model); 
                }
            });
            document.getElementById('modelSelectionArea').style.display = 'block';
            statusElement.style.color = 'red';
            statusElement.textContent = `ğŸš¨ è­¦å‘Š: æ— æ³•æ‹‰å–æ¨¡å‹ï¼Œå·²ä½¿ç”¨å†…ç½®åˆ—è¡¨ã€‚`;
        }

        // 5. å®šåˆ¶åŒ–å‡½æ•°ï¼šæ‹‰å–æ¨¡å‹å¹¶ä¿å­˜é…ç½®
        async function fetchModelsAndSave() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusElement = document.getElementById('apiStatus');
            const modelSelect = document.getElementById('modelSelect');

            if (!apiUrl || !apiKey) {
                statusElement.style.color = 'red';
                statusElement.textContent = 'å½“å‰çŠ¶æ€: è¯·å¡«å†™ URL å’Œ Keyï¼';
                document.getElementById('modelSelectionArea').style.display = 'none';
                return;
            }
            
            statusElement.style.color = 'orange';
            statusElement.textContent = 'å½“å‰çŠ¶æ€: æ­£åœ¨å‘åä»£æœåŠ¡è¯·æ±‚æ¨¡å‹åˆ—è¡¨...';
            document.getElementById('modelSelectionArea').style.display = 'none'; 
            
            localStorage.setItem('apiUrl', apiUrl);
            localStorage.setItem('apiKey', apiKey);

            try {
                const base = (apiUrl.endsWith('/')) ? apiUrl.slice(0, -1) : apiUrl;
                const testUrls = [`${base}/models`, `${base}/v1/models`];
                let modelsResult = null;
                
                for (const url of testUrls) {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {'Authorization': `Bearer ${apiKey}`}
                    });
                    
                    if (response.ok) {
                        modelsResult = await response.json();
                        break; 
                    }
                }

                if (modelsResult && modelsResult.data && Array.isArray(modelsResult.data)) {
                    
                    const models = modelsResult.data.map(m => m.id);
                    if (models.length === 0) { throw new Error("APIæ¥å£è¿”å›çš„æ¨¡å‹åˆ—è¡¨ä¸ºç©ºã€‚"); }

                    modelSelect.innerHTML = '';
                    models.forEach((model, index) => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                        
                        if (index === 0) {
                            modelSelect.value = model;
                            localStorage.setItem('selectedModel', model); 
                        }
                    });

                    document.getElementById('modelSelectionArea').style.display = 'block';
                    document.getElementById('apiStatus').style.color = 'green';
                    statusElement.textContent = `å½“å‰çŠ¶æ€: æ¨¡å‹åˆ—è¡¨æ‹‰å–æˆåŠŸ (å…± ${models.length} ä¸ª)ï¼`;

                    modelSelect.onchange = function() {
                        localStorage.setItem('selectedModel', modelSelect.value);
                        document.getElementById('apiStatus').textContent = `å½“å‰çŠ¶æ€: å·²é€‰æ‹©æ¨¡å‹ [${modelSelect.value}]ã€‚`;
                    };

                } else {
                    throw new Error("æ¨¡å‹æ¥å£è¿”å›æ ¼å¼éæ ‡å‡†ï¼Œå›é€€åˆ°å†…ç½®åˆ—è¡¨ã€‚");
                }

            } catch (error) {
                useHardcodedModels(); 
                statusElement.style.color = 'red';
                statusElement.textContent = `ğŸš¨ é”™è¯¯: æ— æ³•æ‹‰å–çœŸå®æ¨¡å‹ã€‚å·²å›é€€åˆ°å†…ç½®åˆ—è¡¨ã€‚`;
                console.error("æ¨¡å‹æ‹‰å–å¤±è´¥ï¼ŒåŸå› ï¼š", error);
            }
        }
        
        // 6. æ–°å¢å‡½æ•°ï¼šæ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹
        function addCustomModel() {
            const customInput = document.getElementById('customModelInput');
            const modelSelect = document.getElementById('modelSelect');
            const newModelName = customInput.value.trim();
            const statusElement = document.getElementById('apiStatus');

            if (newModelName) {
                let optionExists = false;
                for (let i = 0; i < modelSelect.options.length; i++) {
                    if (modelSelect.options[i].value === newModelName) {
                        optionExists = true;
                        break;
                    }
                }

                if (!optionExists) {
                    const newOption = document.createElement('option');
                    newOption.value = newModelName;
                    newOption.textContent = newModelName;
                    modelSelect.appendChild(newOption);
                }
                
                modelSelect.value = newModelName;
                localStorage.setItem('selectedModel', newModelName);
                statusElement.style.color = 'green';
                statusElement.textContent = `å½“å‰çŠ¶æ€: å·²æ·»åŠ å¹¶é€‰æ‹©äº†è‡ªå®šä¹‰æ¨¡å‹ [${newModelName}]ã€‚`;
                customInput.value = ''; 
                
            } else {
                alert('è¯·è¾“å…¥è¦æ·»åŠ çš„æ¨¡å‹åç§°ï¼');
            }
        }
        
        // --- è§’è‰²ç®¡ç†é€»è¾‘ ---
        
        // 9. è¾…åŠ©å‡½æ•°ï¼šåŠ è½½è§’è‰²ç®¡ç†é¡µé¢çš„æ¨¡å‹ä¸‹æ‹‰æ¡†
        function loadModelSelectForRole() {
            const roleModelSelect = document.getElementById('roleModelSelect');
            const apiModelSelect = document.getElementById('modelSelect');
            roleModelSelect.innerHTML = ''; 

            let modelOptions = [];

            if (apiModelSelect && apiModelSelect.options.length > 0) {
                 for (let i = 0; i < apiModelSelect.options.length; i++) {
                    if (apiModelSelect.options[i].value) { 
                        modelOptions.push({
                            value: apiModelSelect.options[i].value,
                            text: apiModelSelect.options[i].textContent
                        });
                    }
                }
            } 
            
            if (modelOptions.length === 0) {
                const hardcoded = getHardcodedModels().models; 
                hardcoded.forEach(model => {
                    modelOptions.push({ value: model, text: model });
                });
            }

            modelOptions.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.text;
                roleModelSelect.appendChild(option);
            });
            
            if (roleModelSelect.options.length > 0) {
                 roleModelSelect.value = roleModelSelect.options[0].value;
            }
        }

        // 10. ä¿å­˜è§’è‰²å‡½æ•°
        function saveRole() {
            const name = document.getElementById('roleName').value.trim();
            const prompt = document.getElementById('systemPrompt').value.trim();
            const model = document.getElementById('roleModelSelect').value;

            if (!name || !prompt || !model) {
                alert("è¯·å¡«å†™å®Œæ•´çš„è§’è‰²ä¿¡æ¯!");
                return;
            }

            const newRole = {
                id: Date.now(),
                name: name,
                prompt: prompt,
                model: model,
                history: [] 
            };
            
            roles.push(newRole);
            localStorage.setItem('roles', JSON.stringify(roles));
            
            alert(`è§’è‰² "${name}" å·²ä¿å­˜ï¼`);
            showApp('roleList');
        }
        
        // 11. åŠ è½½è§’è‰²åˆ—è¡¨
        function loadRoleList() {
            const roleListDiv = document.getElementById('roleList');
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            roleListDiv.innerHTML = '';
            
            if (roles.length === 0) {
                 roleListDiv.innerHTML = '<div style="text-align: center; color: #888; margin-top: 50px;">æš‚æ— è§’è‰²ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ã€‚</div>';
                 return;
            }

            roles.forEach(role => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.setAttribute('data-id', role.id);
                
                // é»˜è®¤çš„çŸ­æŒ‰äº‹ä»¶ï¼šå¼€å§‹èŠå¤© (ç»‘å®šåˆ° click äº‹ä»¶)
                card.onclick = (e) => startChat(role.id, e); 
                
                // é•¿æŒ‰ç›‘å¬
                let pressTimer;
                
                const startPress = (e) => {
                    e.preventDefault(); 
                    clearTimeout(pressTimer); 
                    pressTimer = setTimeout(() => {
                        showRoleActionMenu(role.id);
                    }, 500); 
                };

                const cancelPress = () => {
                    clearTimeout(pressTimer);
                };

                card.addEventListener('touchstart', startPress, false);
                card.addEventListener('touchend', cancelPress, false);
                card.addEventListener('mousedown', startPress, false);
                card.addEventListener('mouseup', cancelPress, false);
                card.addEventListener('mouseleave', cancelPress, false); 
                
                const avatar = document.createElement('div');
                avatar.className = 'role-avatar';
                avatar.textContent = role.name[0].toUpperCase();

                const info = document.createElement('div');
                info.className = 'role-info';
                info.innerHTML = `<h3>${role.name}</h3>
                                  <p>æ¨¡å‹: ${role.model} - ${role.prompt.substring(0, 30)}...</p>`;

                card.appendChild(avatar);
                card.appendChild(info);
                roleListDiv.appendChild(card);
            });
        }
        
        // 12. å¼€å§‹èŠå¤© (ä»…åœ¨çŸ­æŒ‰æ—¶è§¦å‘)
        function startChat(roleId, event) {
            // ç¡®ä¿åªåœ¨çŸ­æŒ‰(click)æ—¶æ‰§è¡Œ
            if (event && event.type === 'click') { 
                currentRoleId = roleId;
                const role = roles.find(r => r.id === roleId);
                
                if (!role) {
                     alert("è§’è‰²ä¸å­˜åœ¨ï¼");
                     return;
                }

                document.getElementById('chatDetailTitle').textContent = role.name;
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = ''; 
                appendMessage('ai', `ğŸ‘‹ æ‚¨å¥½ï¼Œæˆ‘æ˜¯ ${role.name}ã€‚æˆ‘çš„ç³»ç»Ÿæç¤ºè¯æ˜¯ï¼šâ€œ${role.prompt}â€`);
                
                showApp('chatDetail');
            }
        }
        
        // 13. æ˜¾ç¤ºè§’è‰²æ“ä½œèœå• (ä¿®å¤ Z-Index é®æŒ¡)
        let roleIdToDelete = null; 
        const menuElement = document.getElementById('roleActionMenu'); 

        function showRoleActionMenu(roleId) {
            roleIdToDelete = roleId;
            menuElement.style.display = 'block'; 
            // æ¿€æ´»å¯è§æ€§å’Œç‚¹å‡»äº‹ä»¶
            menuElement.classList.add('is-active'); 
        }

        // 14. éšè—è§’è‰²æ“ä½œèœå•
        function hideRoleActionMenu() {
            // ç§»é™¤ CSS Class
            menuElement.classList.remove('is-active');
            
            // å»¶è¿Ÿéšè— display: none
            setTimeout(() => {
                menuElement.style.display = 'none'; 
            }, 100); 
            
            roleIdToDelete = null;
        }

        // 15. ç¡®è®¤åˆ é™¤è§’è‰²
        function confirmDeleteRole() {
            if (roleIdToDelete === null) return;
            
            const roleIndex = roles.findIndex(r => r.id === roleIdToDelete);
            if (roleIndex > -1) {
                const roleName = roles[roleIndex].name;
                
                roles.splice(roleIndex, 1);
                localStorage.setItem('roles', JSON.stringify(roles));
                
                alert(`è§’è‰² "${roleName}" å·²åˆ é™¤ã€‚`);
                hideRoleActionMenu();
                loadRoleList(); 
            }
        }


        // --- èŠå¤©æ ¸å¿ƒé€»è¾‘ ---

        // 7. åŠ¨æ€æ·»åŠ æ¶ˆæ¯æ°”æ³¡
        function appendMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = (sender === 'user') ? 'message sent' : 'message received';
            messageDiv.textContent = text;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        // 8. èŠå¤©æ¶ˆæ¯å‘é€å‡½æ•° (è¿æ¥çœŸå® API)
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const messageText = input.value.trim();
            
            if (!messageText) return; 

            const apiUrl = localStorage.getItem('apiUrl');
            const apiKey = localStorage.getItem('apiKey');
            
            const role = roles.find(r => r.id === currentRoleId);
            
            if (!apiUrl || !apiKey || !role) {
                 appendMessage('ai', 'âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨ API APP é…ç½®å¯†é’¥ï¼Œå¹¶åˆ›å»º/é€‰æ‹©ä¸€ä¸ªè§’è‰²ã€‚');
                 return;
            }
            const model = role.model; 
            const systemPrompt = role.prompt;
            
            appendMessage('user', messageText);
            input.value = '';
            
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            const thinkingMessage = document.createElement('div');
            thinkingMessage.className = 'message received thinking';
            thinkingMessage.textContent = 'æ€è€ƒä¸­...';
            document.getElementById('chatMessages').appendChild(thinkingMessage);


            try {
                const fullUrl = (apiUrl.endsWith('/')) ? `${apiUrl}chat/completions` : `${apiUrl}/v1/chat/completions`;
                
                const messages = [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: messageText }
                ];

                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages, 
                        stream: false
                    })
                });

                if(document.getElementById('chatMessages').contains(thinkingMessage)){
                    document.getElementById('chatMessages').removeChild(thinkingMessage);
                }

                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({error: {message: 'APIè¿”å›äº†éJSONé”™è¯¯ä¿¡æ¯ã€‚'}}));
                    const errorMessage = errorJson.error?.message || `API é”™è¯¯ (çŠ¶æ€ç : ${response.status})ã€‚è¯·æ£€æŸ¥ Key æˆ– URLã€‚`;
                    appendMessage('ai', `âŒ API è°ƒç”¨å¤±è´¥: ${errorMessage.substring(0, 150)}`);
                    return;
                }

                const result = await response.json();
                
                const aiResponseText = result.choices?.[0]?.message?.content || "AIæœªè¿”å›æœ‰æ•ˆå†…å®¹ã€‚";
                appendMessage('ai', aiResponseText);

            } catch (error) {
                if(document.getElementById('chatMessages').contains(thinkingMessage)){
                    document.getElementById('chatMessages').removeChild(thinkingMessage);
                }
                appendMessage('ai', `ğŸš¨ è¿æ¥å¤±è´¥ï¼šç½‘ç»œæˆ–è·¨åŸŸ(CORS)é”™è¯¯ã€‚è¯·ç¡®è®¤åä»£æœåŠ¡å·²å¼€å¯ CORSï¼ (${error.message.substring(0, 100)})`);

            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

    </script>
</body>
</html>
