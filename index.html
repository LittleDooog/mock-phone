<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8f8f8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æ‰‹æœº - AI èŠå¤©æ¨¡æ‹Ÿå™¨</title>
    
    <style>
        /* 1. æ‰‹æœºå¤–å£³å’Œå±…ä¸­ */
        body {
            display: flex; 
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 100vw;
        }

        /* 2. æ¨¡æ‹Ÿæ‰‹æœºå±å¹• */
        .phone-screen {
            width: 375px;
            height: 667px; 
            background-color: #f8f8f8;
            border: 1px solid #333; 
            border-radius: 40px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2); 
            position: relative; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* åª’ä½“æŸ¥è¯¢ï¼šåœ¨å°å±å¹•ï¼ˆæ‰‹æœºï¼‰ä¸Šåº”ç”¨å…¨å±æ ·å¼ */
        @media screen and (max-width: 768px) {
            .phone-screen {
                width: 100vw;
                height: 100vh; 
                border: none; 
                border-radius: 0; 
                box-shadow: none; 
            }
            .chat-input-area {
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }

        /* éšè—çŠ¶æ€æ  */
        .status-bar.hidden {
            display: none;
        }

        /* 3. é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 30px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.12), rgba(0,0,0,0.03));
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
            position: relative;
            z-index: 100;
        }

        .status-right { display: inline-flex; gap:8px; align-items:center; }
        .battery { width: 24px; height:11px; border:1px solid white; border-radius:2.5px; position:relative; box-sizing: border-box; display:inline-flex; align-items:center; justify-content: center; padding: 0; overflow: visible; }
        .battery::after { content: ''; position:absolute; right:-4px; top:50%; transform:translateY(-50%); width:2px; height:5px; background: white; border-radius:0 1px 1px 0; }
        .battery-level { display:inline-block; height: 7px; background: white; width: 18px; border-radius:1px; }

        /* 4. å¤´éƒ¨å¯¼èˆª (Home/è¿”å›) */
        .header {
            height: 50px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            padding: 0 15px;
            position: relative;
            flex-shrink: 0;
        }
        .back-btn {
            color: #007aff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 12px;
            user-select: none;
        }
        .back-btn:active {
            opacity: 0.6;
        }
        .header h1 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            pointer-events: none;
        }
        /* 6. ä¸»é¡µå›¾æ ‡ç½‘æ ¼ */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: auto auto;
            gap: 12px;
            padding-top: 8px;
            align-items: start;
            overflow: visible;
        }
        .widget {
            width: 100%;
            height: 100%;
            border-radius: 22px;
            overflow: hidden;
            position: relative;
            background: #eee;
        }
        .widget img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .widget.wide { grid-column: 1 / span 4; grid-row: 1; min-height: 32px; margin-top: -10px; }
        .widget.square { grid-column: span 2; aspect-ratio: 1 / 1; min-height: 38px; }
        .widget.square.left { grid-column: 1 / span 2; grid-row: 2; }
        .font-preview {
            border: 1px dashed #ddd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }
        .font-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .font-sample { font-size: 18px; color: #333; }
        .app-icon {
            grid-column: span 1;
            width: 70px;
            height: 70px;
            margin: 0 auto;
            text-align: center;
            flex-shrink: 0;
            cursor: pointer;
        }
        /* Grid placement for icons to align with widget layout */
        #qq-icon { grid-column: 3 !important; grid-row: 2 !important; z-index: 10; align-self: center; width: 60px; height: 60px; margin: -95px 0 0 0 !important; }
        #qq-icon img { width: 50px; height: 50px; }
        #qq-icon p { margin: 2px 0 0; font-size: 10px; }
        #worldbook-icon { grid-column: 4 !important; grid-row: 2 !important; z-index: 10; align-self: center; width: 60px; height: 60px; margin: -95px 0 0 0 !important; }
        #worldbook-icon img { width: 50px; height: 50px; }
        #worldbook-icon p { margin: 2px 0 0; font-size: 10px; }
        /* Zhihu: æ”¾åœ¨ QQ æ­£ä¸‹æ–¹ï¼ˆç¬¬ä¸‰è¡Œï¼Œç¬¬ä¸‰åˆ—ï¼‰*/
        #zhihu-icon { grid-column: 3 !important; grid-row: 3 !important; z-index: 10; align-self: start; width: 60px; height: 60px; margin: -76px 0 0 0 !important; }
        #zhihu-icon img { width: 50px; height: 50px; }
        #zhihu-icon p { margin: 2px 0 0; font-size: 10px; }
        .app-icon img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-icon p {
            margin: 3px 0 0;
            font-size: 11px;
            color: #333;
        }
        /* Dock æ  */
        .dock {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 30px);
            padding: 10px 14px;
            border-radius: 26px;
            background: rgba(255,255,255,0.65);
            backdrop-filter: blur(14px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.18);
            display: flex;
            justify-content: center;
            gap: 18px;
            z-index: 120;
        }
        .dock .app-icon { margin: 0; width: 60px; height: 60px; }
        .dock .app-icon img { width: 50px; height: 50px; border-radius: 12px; }
        .dock .app-icon p { color: #333; }

        /* å†…å®¹å®¹å™¨å¡«å……æ•´ä¸ªå°æ‰‹æœºåŒºåŸŸ */
        .content {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        /* APPå±å¹•æ— paddingï¼Œé“ºæ»¡å°æ‰‹æœºå±å¹•ï¼Œå¼ºåˆ¶ç™½è‰²èƒŒæ™¯ */
        .content.app-mode {
            padding: 0;
            overflow: hidden;
            font-size: 14px;
            background-color: #fff !important;
            background-image: none !important;
            min-height: 100%;
        }

        /* ä¸»å±å¹•å›åˆ°æ­£å¸¸padding */
        .content.home-mode {
            padding: 20px 20px 140px 20px;
            overflow-y: scroll;
            overflow-x: visible;
        }

        /* 7. API è®¾ç½®é¡µé¢æ ·å¼ */
        .api-settings {
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: #fff;
        }
        .api-settings label {
            display: block;
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        /* æ–°å¢/ä¿®å¤ï¼šAPI å†…å®¹åŒºåŸŸæ ·å¼ */
        .api-content {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 14px;
            background-color: #fff;
            font-size: 13px;
        }
        .api-settings input[type="text"], .api-settings input[type="password"], .api-settings select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .save-btn {
            width: 100%;
            padding: 12px;
            margin-top: 25px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .save-btn:hover {
            background-color: #0056b3;
        }
        /* Beautify é¡µé¢æ“ä½œæŒ‰é’®ï¼šæ”¶çª„å®½åº¦ä¸å­—å·ï¼Œæå‡è§‚æ„Ÿ */
        #beautifyScreen .api-content .save-btn {
            width: auto;
            min-width: 80px;
            padding: 8px 14px;
            font-size: 14px;
            border-radius: 12px;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            background-color: #f0f0f0;
        }
        .api-content textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            resize: none;
        }
        
        /* 8. èŠå¤©/è§’è‰²åˆ—è¡¨é¡µé¢æ ·å¼ */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column; 
            overflow: hidden;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            max-height: 100%;
            position: relative;
        }
        .chat-messages {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 10px 10px 20px 10px;
            background-color: #f8f8f8;
            min-height: 0;
        }
        .chat-input-area {
            display: flex;
            padding: 10px 10px 15px 10px;
            border-top: 1px solid #ddd;
            background-color: #fff;
            flex-shrink: 0;
            flex-grow: 0;
            position: relative;
            box-sizing: border-box;
        }
        .chat-input-area input[type="text"] {
            flex: 1 1 auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 16px;
            box-sizing: border-box;
            min-width: 0;
        }
        .chat-input-area button {
            padding: 10px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            flex-shrink: 0;
        }
        .chat-input-area button:disabled {
            background-color: #a0c4ff;
            cursor: default;
        }

        /* 9. æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
        .message-bubble {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        
        .message-bubble.sent {
            justify-content: flex-end;
        }
        
        .message-bubble.received {
            justify-content: flex-start;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message {
            max-width: 65%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message.sent {
            background-color: #007aff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            background-color: #e5e5ea;
            color: black;
            border-bottom-left-radius: 4px;
        }
        .message.thinking {
            background-color: #ffe0b2;
            color: #333;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1.0; }
            100% { opacity: 0.6; }
        }
        
        /* 10. è§’è‰²åˆ—è¡¨å’ŒæŒ‰é’®æ ·å¼ */
        .add-model-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .add-role-btn {
            font-size: 24px;
            color: #007aff;
            cursor: pointer;
            z-index: 20;
            position: absolute;
            right: 15px;
            font-weight: 400;
        }
        .role-list-content {
            padding: 0;
            background-color: #fff;
        }
        .role-card {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .role-card:active {
            background-color: #f0f0f0;
        }
        .role-avatar {
            width: 45px;
            height: 45px;
            background-color: #007aff;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin-right: 15px;
        }
        .role-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .role-info p {
            margin: 2px 0 0;
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }

        /* 11. è§’è‰²æ“ä½œå¼¹å‡ºèœå•æ ·å¼ (ä¿®å¤ Z-Index å’Œå®šä½) */
        #roleActionMenu {
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            /* å…³é”®ä¿®å¤ï¼šé»˜è®¤éšè—ï¼Œä¸å“åº”ç‚¹å‡» */
            visibility: hidden;
            pointer-events: none; 
            background: rgba(0, 0, 0, 0.4); 
        }
        /* å½“ JS æ¿€æ´»æ—¶ï¼Œæ¢å¤å¯è§æ€§å’Œç‚¹å‡» */
        #roleActionMenu.is-active {
            visibility: visible !important;
            pointer-events: auto !important; 
        }

        .menu-content {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 15px;
            z-index: 1001;
            transition: bottom 0.3s ease-out;
            margin-bottom: 20px;
        }
        .menu-content button {
            width: 100%;
            padding: 15px;
            margin-bottom: 8px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: white;
            color: #007aff;
        }
        .menu-content button#deleteRoleBtn {
            color: #dc3545;
        }
        .menu-content button#clearHistoryBtn {
            color: #ff9500;
        }

        /* 12. èŠå¤©è®¾ç½®æ¨¡æ€æ¡† */
        #avatarSettingsModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            pointer-events: none;
        }

        #avatarSettingsModal.is-active {
            display: flex !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        .avatar-modal-content {
            background: white;
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 320px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 5px 40px rgba(0, 0, 0, 0.3);
        }

        .avatar-modal-content h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .settings-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .settings-tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: color 0.3s;
        }

        .settings-tab-btn.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ddd;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            overflow: hidden;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-section input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .avatar-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .avatar-modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .avatar-modal-buttons button.save {
            background-color: #007aff;
            color: white;
        }

        .avatar-modal-buttons button.cancel {
            background-color: #f0f0f0;
            color: #333;
        }

        /* 13. åˆ›å»ºä¸–ç•Œä¹¦å’Œæ·»åŠ å†…å®¹æ¨¡æ€æ¡†æ ·å¼ */
        #createWorldbookModal, #addWorldbookContentModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            pointer-events: none;
        }

        #createWorldbookModal.is-active, #addWorldbookContentModal.is-active {
            display: flex !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        /* 14. åº•éƒ¨æ ‡ç­¾æ æ ·å¼ */
        .bottom-tab-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background-color: #fff;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 13px;
            color: #888;
            padding: 5px 0;
            transition: color 0.3s;
        }
        .tab-item.active {
            color: #007aff;
            font-weight: 600;
        }
        .tab-item:active {
            opacity: 0.6;
        }

        /* 15. æœ‹å‹åœˆ/åŠ¨æ€æ ·å¼ */
        .moment-header {
            position: relative;
            width: 100%;
            height: 260px; /* æé«˜é«˜åº¦ï¼Œä¿è¯èƒŒæ™¯å’Œå¤´åƒéƒ½åœ¨ header å†… */
            background-color: transparent;
            background-size: cover;
            background-position: center center;
            cursor: pointer;
            z-index: 2;
            display: block;
            box-shadow: none;
            overflow: hidden;
        }
        .moment-avatar {
            position: absolute;
            right: 16px; /* å³ä¾§æ‚¬æµ® */
            bottom: 12px; /* åœ¨ header å†…åº•éƒ¨å¯è§ */
            width: 64px;
            height: 64px;
            border-radius: 10px; /* æ–¹å½¢å¸¦åœ†è§’ */
            border: 2px solid rgba(255,255,255,0.95);
            background-color: #fff;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            box-shadow: 0 6px 12px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .moment-list {
            padding: 15px 15px 60px 15px;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .moment-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .moment-item:last-child {
            border-bottom: none;
        }
        .moment-user {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .moment-user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            background-color: #ddd;
            margin-right: 10px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .moment-user-info {
            flex: 1;
        }
        .moment-user-name {
            font-size: 15px;
            font-weight: 600;
            color: #576b95;
            margin-bottom: 5px;
        }
        .moment-content {
            font-size: 15px;
            line-height: 1.5;
            color: #333;
            margin-bottom: 10px;
        }
        .moment-image {
            width: 100%;
            max-width: 200px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        .moment-time {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        .moment-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        .moment-action-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            user-select: none;
        }
        .moment-action-icon {
            width: 18px;
            height: 18px;
            display: inline-block;
            vertical-align: middle;
            fill: #888;
        }
        .moment-action-count {
            font-size: 13px;
            color: #666;
            margin-left: 4px;
        }
        .moment-action-btn:active {
            opacity: 0.6;
        }
        .moment-action-btn.liked {
            color: #ff6b6b;
        }
        .moment-action-btn.liked .moment-action-icon { fill: #ff6b6b; }
        .moment-action-btn:hover { background-color: rgba(0,0,0,0.02); border-radius: 8px; padding: 6px; }
        .moment-likes {
            font-size: 13px;
            color: #576b95;
            margin-top: 8px;
            background-color: #f7f7f7;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .moment-likes .moment-action-icon { width: 14px; height: 14px; vertical-align: middle; margin-right: 6px; fill: #ff6b6b; }
        .moment-comments {
            margin-top: 8px;
            background-color: #f7f7f7;
            padding: 8px 10px;
            border-radius: 4px;
        }
        .moment-comment {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 5px;
        }
        .moment-comment:last-child {
            margin-bottom: 0;
        }
        .comment-user {
            color: #576b95;
            font-weight: 600;
        }
        .comment-text {
            color: #333;
        }
        .camera-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 30;
        }
    </style>
</head>
<body>

    <div class="phone-screen">
        <div class="status-bar">
            <span id="statusTime">9:41 AM</span>
            <span class="status-right">
                <span class="battery" title="100%">
                    <span class="battery-level" style="width:100%"></span>
                </span>
            </span>
        </div>

        <div id="appContainer" class="content">
            
            <div id="homeScreen">
                <div class="app-grid">
                    <div class="widget wide">
                        <img src="https://i.postimg.cc/xdTz1PDb/IMG-4890.jpg" alt="é•¿æ–¹å½¢å›¾ç‰‡">
                    </div>
                    <div class="widget square left">
                        <img src="https://i.postimg.cc/pXb5Fvb3/IMG-4891.jpg" alt="æ­£æ–¹å½¢å›¾ç‰‡1">
                    </div>
                    <!-- QQ icon -->
                    <div class="app-icon" id="qq-icon" onclick="showApp('chat')">
                        <img src="https://i.postimg.cc/VLx3BSZk/IMG-4884.jpg" alt="QQ å›¾æ ‡" data-app="chat">
                        <p>QQ</p>
                    </div>
                    <!-- Worldbook icon -->
                    <div class="app-icon" id="worldbook-icon" onclick="showApp('worldbook')">
                        <img src="https://i.postimg.cc/bJV5Gd2y/IMG-4883.jpg" alt="ä¸–ç•Œä¹¦å›¾æ ‡" data-app="worldbook">
                        <p>ä¸–ç•Œä¹¦</p>
                    </div>
                    <!-- Zhihu icon -->
                    <div class="app-icon" id="zhihu-icon" onclick="showApp('zhihu')">
                        <img src="https://i.postimg.cc/tgp46TnT/IMG-4904.jpg" alt="çŸ¥ä¹ å›¾æ ‡" data-app="zhihu">
                        <p>çŸ¥ä¹</p>
                    </div>
                </div>
            </div>

            <div id="dock" class="dock">
                <div class="app-icon" id="api-icon" onclick="showApp('api')">
                    <img src="https://i.postimg.cc/5NXVmWxq/IMG-4886.jpg" alt="API å›¾æ ‡" data-app="api">
                    <p>API</p>
                </div>
                <div class="app-icon" id="beautify-icon" onclick="showApp('beautify')">
                    <img src="https://i.postimg.cc/ZqV7g0H3/IMG-4885.jpg" alt="ç¾åŒ–å›¾æ ‡" data-app="beautifyApp">
                    <p>ç¾åŒ–</p>
                </div>
                <div class="app-icon" id="font-icon" onclick="showApp('font')">
                    <img src="https://i.postimg.cc/t498M0bK/IMG-4888.jpg" alt="å­—ä½“å›¾æ ‡" data-app="font">
                    <p>å­—ä½“</p>
                </div>
            </div>

            <div id="apiScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>API è®¾ç½®</h1>
                </div>
                <div class="api-content"> 
                    <label for="apiUrl">åä»£åœ°å€ (URL):</label>
                    <input type="text" id="apiUrl" placeholder="ä¾‹å¦‚: https://gcli.ggchan.dev">

                    <label for="apiKey">API å¯†é’¥ (Key):</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„ Key">
                    
                    <button class="save-btn" onclick="fetchModelsAndSave()">æ‹‰å–æ¨¡å‹å¹¶ä¿å­˜</button> 

                    <div id="modelSelectionArea" style="display: none; margin-top: 20px;">
                        <label for="modelSelect">é€‰æ‹©æ¨¡å‹:</label>
                        <select id="modelSelect">
                            <option value="">è¯·å…ˆæ‹‰å–æ¨¡å‹...</option>
                        </select>
                        
                        <label for="customModelInput" style="margin-top: 20px;">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°:</label>
                        <input type="text" id="customModelInput" placeholder="ä¾‹å¦‚: gemini-2.5-flash">
                        <button class="add-model-btn" onclick="addCustomModel()">æ·»åŠ å¹¶ä½¿ç”¨</button>
                    </div>

                    <div id="apiStatus" class="status-message" style="margin-top: 20px;">
                        å½“å‰çŠ¶æ€: æœªé…ç½®
                    </div>
                </div>
            </div>

            <div id="beautifyScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>ç¾åŒ–</h1>
                </div>
                <div class="api-content">
                    <label for="backgroundUrl">æ‰‹æœºèƒŒæ™¯å›¾ç‰‡ URL:</label>
                    <input type="text" id="backgroundUrl" placeholder="ä¾‹å¦‚: https://example.com/bg.jpg">

                    <label for="targetAppSelect">é€‰æ‹©è¦æ›¿æ¢çš„å›¾æ ‡:</label>
                    <select id="targetAppSelect">
                        <option value="home-bg">æ‰‹æœºèƒŒæ™¯</option>
                        <option value="api">API å›¾æ ‡</option>
                        <option value="chat">QQ å›¾æ ‡</option>
                        <option value="beautifyApp">ç¾åŒ– APP å›¾æ ‡</option>
                        <option value="worldbook">ä¸–ç•Œä¹¦ å›¾æ ‡</option>
                        <option value="font">å­—ä½“ å›¾æ ‡</option>
                    </select>

                    <label for="iconUrl" style="margin-top: 15px;">å›¾æ ‡å›¾ç‰‡ URL:</label>
                    <input type="text" id="iconUrl" placeholder="ä¾‹å¦‚: https://example.com/icon.png">

                    <div style="margin-top: 15px; display:flex; gap:10px; align-items:center;">
                        <button class="save-btn" onclick="applyAndSaveBeautify()">åº”ç”¨å¹¶ä¿å­˜</button>
                        <button class="save-btn" style="background:#6c757d;" onclick="previewBeautify(true)">é¢„è§ˆ</button>
                        <button class="save-btn" style="background:#adb5bd;" onclick="previewBeautify(false)">å–æ¶ˆé¢„è§ˆ</button>
                        <button class="save-btn" style="background:#e53e3e;" onclick="restoreBeautifyDefaults()">æ¢å¤é»˜è®¤</button>
                    </div>

                    <div id="beautifyPreview" style="margin-top:20px; display:flex; gap:12px; align-items:center;">
                        <div style="flex:1">
                            <div style="font-weight:600; margin-bottom:6px;">é¢„è§ˆ</div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <img id="previewIcon" src="" style="width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid #ddd;display:none;">
                                <div id="previewText" style="color:#666;">åœ¨æ­¤æ˜¾ç¤ºé¢„è§ˆ</div>
                            </div>
                        </div>
                    </div>
                    <hr style="margin:20px 0; border:none; border-top:1px solid #eee;">
                    <div style="font-weight:700; margin-bottom:8px;">ä¸»å±è£…é¥°å—å›¾ç‰‡ï¼ˆå¤§é•¿æ–¹å½¢ä¸æ­£æ–¹å½¢ï¼‰</div>
                    <label for="beautifyWidgetWide">å¤§é•¿æ–¹å½¢å›¾ç‰‡ï¼ˆä¸Šä¼ æˆ–é€‰æ‹©ï¼‰:</label>
                    <input type="file" id="beautifyWidgetWideFile" accept="image/*" style="display:block; margin-bottom:8px;">
                    <input type="text" id="beautifyWidgetWide" placeholder="æˆ–è¾“å…¥å›¾ç‰‡ URL" style="width:100%; margin-bottom:12px;">
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                        <button class="save-btn" onclick="previewWidgetImage('wide')">é¢„è§ˆå¤§é•¿æ–¹å½¢</button>
                        <button class="save-btn" onclick="saveWidgetImage('wide')">ä¿å­˜å¤§é•¿æ–¹å½¢</button>
                    </div>

                    <label for="beautifyWidgetSquare">æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆä¸Šä¼ æˆ–é€‰æ‹©ï¼‰:</label>
                    <input type="file" id="beautifyWidgetSquareFile" accept="image/*" style="display:block; margin-bottom:8px;">
                    <input type="text" id="beautifyWidgetSquare" placeholder="æˆ–è¾“å…¥å›¾ç‰‡ URL" style="width:100%; margin-bottom:12px;">
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                        <button class="save-btn" onclick="previewWidgetImage('square')">é¢„è§ˆæ­£æ–¹å½¢</button>
                        <button class="save-btn" onclick="saveWidgetImage('square')">ä¿å­˜æ­£æ–¹å½¢</button>
                    </div>
                    <div id="beautifyStatus" class="status-message" style="margin-top:20px;">å½“å‰çŠ¶æ€: æœªä¿å­˜</div>

                    <hr style="margin:20px 0; border:none; border-top:1px solid #eee;">
                    <div style="font-weight:700; margin-bottom:8px;">èŠå¤©é¡µè‡ªå®šä¹‰èƒŒæ™¯</div>
                    <label for="beautifyChatBgColor">èŠå¤©èƒŒæ™¯è‰²:</label>
                    <input type="color" id="beautifyChatBgColor" value="#f8f8f8" style="width: 60px; height: 36px; padding: 0; border: none; background: transparent;">

                    <label for="beautifyChatBgImage" style="margin-top: 12px;">èŠå¤©èƒŒæ™¯å›¾ URLï¼ˆå¯é€‰ï¼‰:</label>
                    <input type="text" id="beautifyChatBgImage" placeholder="ä¾‹å¦‚: https://example.com/chat-bg.jpg æˆ– data:...">

                    <div style="margin-top: 12px; display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                        <button class="save-btn" onclick="previewBeautifyChatBackground()" style="min-width:110px;">é¢„è§ˆèŠå¤©èƒŒæ™¯</button>
                        <button class="save-btn" onclick="saveBeautifyChatBackground()" style="min-width:110px;">ä¿å­˜èŠå¤©èƒŒæ™¯</button>
                        <button class="save-btn" onclick="resetBeautifyChatBackground()" style="background:#ccc; color:#000; min-width:110px;">æ¢å¤é»˜è®¤</button>
                    </div>
                    <div style="color:#888; font-size:12px; margin-top:8px;">æç¤ºï¼šé¢„è§ˆéœ€è¿›å…¥â€œèŠå¤©â€é¡µæŸ¥çœ‹æ•ˆæœï¼›ä¿å­˜åå°†å¯¹æ‰€æœ‰èŠå¤©ç”Ÿæ•ˆã€‚</div>
                </div>
            </div>

            <!-- Zhihu App: ç©ºç™½å ä½é¡µé¢ -->
            <div id="zhihuScreen" class="api-settings" style="display:none; position:relative;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>çŸ¥ä¹</h1>
                </div>
                <div class="api-content" id="zhihuContent" style="padding:12px; overflow:auto; height:calc(100% - 60px); box-sizing:border-box;">
                    <div id="zhihuPosts" style="display:flex; flex-direction:column; gap:12px; align-items:stretch;">
                        <!-- posts will be inserted here -->
                    </div>
                </div>

                <!-- bottom toolbar: Home | + | Messages -->
                <div id="zhihuBottomBar" style="position:absolute; left:12px; right:12px; bottom:12px; height:56px; border-radius:28px; background:rgba(255,255,255,0.95); display:flex; align-items:center; justify-content:space-around; box-shadow:0 6px 18px rgba(0,0,0,0.12); z-index:60;">
                    <button id="zhihuHomeBtn" style="background:transparent;border:none;color:#444;font-size:13px;">é¦–é¡µ</button>
                    <button id="zhihuAddBtn" style="width:46px;height:46px;border-radius:999px;background:#007aff;color:#fff;border:none;font-size:24px;line-height:46px;">+</button>
                    <button id="zhihuMsgBtn" style="background:transparent;border:none;color:#444;font-size:13px;">æ¶ˆæ¯</button>
                </div>

                <!-- modal for creating post -->
                <div id="zhihuModal" style="display:none; position:absolute; left:12px; right:12px; bottom:84px; background:rgba(255,255,255,0.98); border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,0.18);">
                    <textarea id="zhihuInput" placeholder="å†™ç‚¹ä»€ä¹ˆ..." style="width:100%; height:90px; padding:10px; box-sizing:border-box; border:1px solid #eee; border-radius:8px; resize:none;"></textarea>
                    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                        <button class="save-btn" onclick="closeZhihuModal()" style="background:#adb5bd;">å–æ¶ˆ</button>
                        <button class="save-btn" onclick="postToZhihu()" style="background:#007aff;">å‘å¸ƒ</button>
                    </div>
                </div>
            </div>

            <!-- Zhihu Messages Screen (empty placeholder) -->
            <div id="zhihuMessagesScreen" class="api-settings" style="display:none; position:relative;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('zhihu')">è¿”å›</span>
                    <h1>æ¶ˆæ¯</h1>
                </div>
                <div class="api-content" style="padding:12px; box-sizing:border-box; height:calc(100% - 60px); overflow:auto;">
                    <!-- top quick actions -->
                    <div style="display:flex; gap:12px; padding:10px 4px; justify-content:space-between; background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.03); margin-bottom:12px;">
                        <div style="flex:1; text-align:center; padding:8px;">
                            <div style="width:44px;height:44px;margin:0 auto;border-radius:10px;background:#fafafa;display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ’¬</div>
                            <div style="font-size:12px;margin-top:6px;color:#333;">è¯„è®ºè½¬å‘</div>
                        </div>
                        <div style="flex:1; text-align:center; padding:8px;">
                            <div style="width:44px;height:44px;margin:0 auto;border-radius:10px;background:#fafafa;display:flex;align-items:center;justify-content:center;font-size:20px;">â¤ï¸</div>
                            <div style="font-size:12px;margin-top:6px;color:#333;">èµåŒå–œæ¬¢</div>
                        </div>
                        <div style="flex:1; text-align:center; padding:8px;">
                            <div style="width:44px;height:44px;margin:0 auto;border-radius:10px;background:#fafafa;display:flex;align-items:center;justify-content:center;font-size:20px;">â­</div>
                            <div style="font-size:12px;margin-top:6px;color:#333;">æ”¶è—äº†æˆ‘</div>
                        </div>
                        <div style="flex:1; text-align:center; padding:8px;">
                            <div style="width:44px;height:44px;margin:0 auto;border-radius:10px;background:#fafafa;display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ‘ï¸</div>
                            <div style="font-size:12px;margin-top:6px;color:#333;">å…³æ³¨è®¢é˜…</div>
                        </div>
                    </div>

                    <!-- private messages list -->
                    <div id="zhihuMessageList" style="display:flex; flex-direction:column; gap:10px;">
                        <!-- messages will be rendered here -->
                    </div>
                </div>
            </div>

            <div id="fontScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>å­—ä½“</h1>
                </div>
                <div class="api-content">
                    <label style="font-weight:700;">æœ¬åœ°å­—ä½“æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆï¼‰</label>
                    <input id="fontFileInput" type="file" accept=".woff,.woff2,.ttf,.otf" onchange="handleFontFileSelection(event)" style="margin-top:8px;" />

                    <label style="font-weight:700; margin-top:12px; display:block;">æˆ–å­—ä½“ URL</label>
                    <input id="fontUrlInput" class="font-input" type="text" placeholder="https://.../yourfont.ttf" style="margin-top:8px;" />

                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="save-btn" style="flex:1;" onclick="previewFont()">é¢„è§ˆ</button>
                        <button class="save-btn" style="flex:1;" onclick="saveFontAndApply()">ä¿å­˜å¹¶åº”ç”¨</button>
                        <button class="save-btn" style="flex:1; background:#ccc; color:#000;" onclick="clearFont()">æ¸…é™¤</button>
                    </div>

                    <div id="fontPreview" class="font-preview">
                        <div id="fontPreviewText" class="font-sample">ç¤ºä¾‹ï¼šå¤©åœ°ç„é»„ï¼Œå®‡å®™æ´ªè’</div>
                    </div>
                    <div id="fontStatus" style="margin-top:10px; color:#666; font-size:13px;"></div>
                </div>
            </div>

            <div id="roleListScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>æ¶ˆæ¯</h1>
                    <span class="add-role-btn" onclick="showApp('roleManager')">â•</span> </div>
                
                <div id="roleList" class="content role-list-content" style="padding-bottom: 60px;">
                    <div style="text-align: center; color: #888; margin-top: 50px;">
                        æš‚æ— è§’è‰²ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ã€‚ </div>
                </div>
                
                <div class="bottom-tab-bar">
                    <div class="tab-item active" onclick="switchTab('message')">
                        <span>æ¶ˆæ¯</span>
                    </div>
                    <div class="tab-item" onclick="switchTab('moment')">
                        <span>åŠ¨æ€</span>
                    </div>
                </div>
            </div>

            <div id="momentScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1>åŠ¨æ€</h1>
                    <img src="https://i.postimg.cc/tTBZJyY2/9266855a3j0ac4e02b69e9cbdba5805e.png" class="camera-btn" onclick="showPostMomentModal()">
                </div>
                
                <div class="content" style="padding: 0; background-color: #f0f0f0; overflow-y: auto; flex: 1; padding-bottom: 60px;">
                    <div class="moment-header" id="momentHeaderBg" onclick="changeMomentBg()" style="background-image: url('https://i.postimg.cc/K8K84gkL/IMG-4887.jpg');">
                        <div class="moment-avatar" id="momentAvatar" onclick="event.stopPropagation(); changeMomentAvatar();" style="background-image: url('https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg');"></div>
                    </div>
                    
                    <div class="moment-list" id="momentList">
                        <div style="text-align: center; color: #999; padding: 40px 20px;">
                            <p>æš‚æ— åŠ¨æ€</p>
                            <p style="font-size: 13px; margin-top: 5px;">ç‚¹å‡»å³ä¸Šè§’ç›¸æœºå‘å¸ƒåŠ¨æ€</p>
                        </div>
                    </div>
                </div>
                
                <div class="bottom-tab-bar">
                    <div class="tab-item" onclick="switchTab('message')">
                        <span>æ¶ˆæ¯</span>
                    </div>
                    <div class="tab-item active" onclick="switchTab('moment')">
                        <span>åŠ¨æ€</span>
                    </div>
                </div>
            </div>

            <div id="roleManagerScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1>ç®¡ç†è§’è‰²</h1>
                </div>
                <div class="api-content">
                    <label for="roleName">è§’è‰²åç§°:</label>
                    <input type="text" id="roleName" placeholder="ä¾‹å¦‚: å†·é™çš„å®¢æœæœºå™¨äºº">

                    <label for="systemPrompt">ç³»ç»Ÿæç¤ºè¯ (Prompt):</label>
                    <textarea id="systemPrompt" rows="5" placeholder="ä¾‹å¦‚: ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€å†·é™çš„å®¢æœã€‚è¯·ç®€æ´åœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚"></textarea>

                    <label for="roleModelSelect">é€‰æ‹©æ¨¡å‹:</label>
                    <select id="roleModelSelect">
                        </select>
                    
                    <button class="save-btn" onclick="saveRole()">ä¿å­˜è§’è‰²</button> 
                    <button class="delete-btn" onclick="deleteRole()" style="margin-top: 10px; background-color: #dc3545;">åˆ é™¤è§’è‰²</button> 
                </div>
            </div>

            <div id="chatDetailScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1 id="chatDetailTitle">è§’è‰²åç§°</h1>
                    <span style="cursor: pointer; z-index: 20; position: absolute; right: 50px; display: flex; align-items: center;" onclick="showMemorySummary()"><img src="https://i.postimg.cc/zDy407qq/65dbd6a85hbe62e1111d0e1222f78ab1.png" style="width: 60px; height: 60px; object-fit: contain;"></span>
                    <span style="font-size: 24px; color: #007aff; cursor: pointer; z-index: 20; position: absolute; right: 15px; font-weight: 400;" onclick="showAvatarSettings()">â‹®</span> </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...">
                    <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>

            <div id="worldbookListScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>ä¸–ç•Œä¹¦</h1>
                    <span class="add-role-btn" onclick="showCreateWorldbookModal()">â•</span>
                </div>
                <div id="worldbookList" class="content role-list-content">
                    <div style="text-align: center; color: #888; margin-top: 50px;">
                        æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• åˆ›å»ºã€‚
                    </div>
                </div>
            </div>

            <div id="worldbookDetailScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('worldbook')">è¿”å›</span>
                    <h1 id="worldbookDetailTitle">ä¸–ç•Œä¹¦</h1>
                </div>
                <div id="worldbookContent" class="content" style="background-color: #fff; overflow-y: auto; padding: 15px; flex-grow: 1;">
                    <div id="worldbookContentList"></div>
                </div>
                <div style="padding: 10px; background-color: #fff; border-top: 1px solid #ddd;">
                    <button onclick="showAddWorldbookContentModal()" style="width: 100%; padding: 12px; background-color: #007aff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">æ·»åŠ å†…å®¹</button>
                </div>
            </div>

        </div> <div id="roleActionMenu" style="display: none;">
            <div id="menuContent" class="menu-content">
                <button id="clearHistoryBtn" onclick="confirmClearHistory()" style="color: #ff9500;">æ¸…ç©ºèŠå¤©è®°å½•</button>
                <button id="deleteRoleBtn" onclick="confirmDeleteRole()">åˆ é™¤è§’è‰²</button>
                <button onclick="hideRoleActionMenu()">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="createWorldbookModal" style="display: none;" onclick="event.target.id === 'createWorldbookModal' && closeCreateWorldbookModal();">
            <div class="avatar-modal-content" style="max-width: 300px;">
                <h3>åˆ›å»ºä¸–ç•Œä¹¦</h3>
                <div class="avatar-section">
                    <label>ä¸–ç•Œä¹¦åç§°</label>
                    <input type="text" id="worldbookNameInput" placeholder="è¾“å…¥ä¸–ç•Œä¹¦åç§°..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 15px;">
                </div>
                <div class="avatar-modal-buttons">
                    <button class="save" onclick="createWorldbook()">ç¡®å®š</button>
                    <button class="cancel" onclick="closeCreateWorldbookModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div id="addWorldbookContentModal" style="display: none;" onclick="event.target.id === 'addWorldbookContentModal' && closeAddWorldbookContentModal();">
            <div class="avatar-modal-content" style="max-width: 300px;">
                <h3>æ·»åŠ å†…å®¹</h3>
                <div class="avatar-section">
                    <label>å†…å®¹æ–‡æœ¬</label>
                    <textarea id="worldbookContentInput" placeholder="è¾“å…¥ä¸–ç•Œä¹¦å†…å®¹..." rows="6" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 15px; resize: none;"></textarea>
                </div>
                <div class="avatar-modal-buttons">
                    <button class="save" onclick="addWorldbookContent()">ç¡®å®š</button>
                    <button class="cancel" onclick="closeAddWorldbookContentModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div id="memorySummaryModal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; visibility: hidden; pointer-events: none;">
            <div class="avatar-modal-content" style="max-width: 350px;">
                <h3>ğŸ“ è®°å¿†æ€»ç»“</h3>
                <div style="margin-bottom: 15px;">
                    <p style="font-size: 13px; color: #666; margin: 0 0 10px;">AIæ ¹æ®æœ€è¿‘çš„å¯¹è¯ç”Ÿæˆçš„è®°å¿†æ€»ç»“ï¼š</p>
                    <div id="memorySummaryContent" style="background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #333;">
                        <p style="text-align: center; color: #999;">åŠ è½½ä¸­...</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="generateMemorySummary()" style="flex: 1; padding: 10px; background-color: #007aff; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">é‡æ–°ç”Ÿæˆ</button>
                    <button onclick="closeMemorySummary()" style="flex: 1; padding: 10px; background-color: #f0f0f0; color: #333; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>

        <div id="postMomentModal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center; visibility: hidden; pointer-events: none;">
            <div class="avatar-modal-content" style="max-width: 350px;">
                <h3>å‘å¸ƒåŠ¨æ€</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #333;">åŠ¨æ€å†…å®¹</label>
                    <textarea id="momentContentInput" placeholder="åˆ†äº«æ–°é²œäº‹..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; resize: none; min-height: 100px;"></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="momentWithImage" onchange="toggleImageDescription()" style="width: auto; margin-right: 8px;">
                        <span style="font-size: 14px;">å¸¦å›¾å‘å¸ƒ</span>
                    </label>
                </div>
                <div id="imageDescriptionSection" style="display: none; margin-bottom: 15px;">
                    <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #333;">å›¾ç‰‡æè¿°</label>
                    <textarea id="imageDescriptionInput" placeholder="æè¿°è¿™å¼ å›¾ç‰‡..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; resize: none; min-height: 60px;"></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="postMoment()" style="flex: 1; padding: 10px; background-color: #007aff; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">å‘å¸ƒ</button>
                    <button onclick="closePostMomentModal()" style="flex: 1; padding: 10px; background-color: #f0f0f0; color: #333; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div id="imageViewModal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 2500; justify-content: center; align-items: center; visibility: hidden; pointer-events: none;" onclick="closeImageView()">
            <div style="max-width: 90%; max-height: 80%; display: flex; flex-direction: column; align-items: center;">
                <img id="viewedImage" src="" style="max-width: 100%; max-height: 60vh; border-radius: 8px; margin-bottom: 20px;">
                <div id="imageDescriptionView" style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; max-width: 100%; color: #333; font-size: 14px; line-height: 1.6;"></div>
            </div>
        </div>

        <div id="avatarSettingsModal" style="display: none;">
            <div class="avatar-modal-content">
                <h3>èŠå¤©è®¾ç½®</h3>
                
                <div class="settings-tabs">
                    <button class="settings-tab-btn active" onclick="switchSettingsTab('avatar')">å¤´åƒ</button>
                    <button class="settings-tab-btn" onclick="switchSettingsTab('nickname')">æ˜µç§°</button>
                    <button class="settings-tab-btn" onclick="switchSettingsTab('background')">èƒŒæ™¯</button>
                    <button class="settings-tab-btn" onclick="switchSettingsTab('role')">è§’è‰²</button>
                </div>

                <div id="avatarTab" class="settings-tab-content active">
                    <div class="avatar-section">
                        <label>æˆ‘çš„å¤´åƒ</label>
                        <div class="avatar-preview" id="userAvatarPreview"></div>
                        <input type="text" id="userAvatarUrl" placeholder="è¾“å…¥å¤´åƒ URL æˆ–è¾“å…¥Emoji..." oninput="updateAvatarPreview('user')" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;">æˆ–é€‰æ‹©æœ¬åœ°å›¾ç‰‡ï¼š</div>
                        <input type="file" id="userAvatarFile" accept="image/*" onchange="handleAvatarFileUpload('user')" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 12px;">
                    </div>

                    <div class="avatar-section">
                        <label>å¯¹æ–¹å¤´åƒ</label>
                        <div class="avatar-preview" id="aiAvatarPreview"></div>
                        <input type="text" id="aiAvatarUrl" placeholder="è¾“å…¥å¤´åƒ URL æˆ–è¾“å…¥Emoji..." oninput="updateAvatarPreview('ai')" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;">æˆ–é€‰æ‹©æœ¬åœ°å›¾ç‰‡ï¼š</div>
                        <input type="file" id="aiAvatarFile" accept="image/*" onchange="handleAvatarFileUpload('ai')" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 12px;">
                    </div>
                </div>

                <div id="nicknameTab" class="settings-tab-content">
                    <div class="avatar-section">
                        <label>æˆ‘çš„æ˜µç§°</label>
                        <input type="text" id="userNickname" placeholder="è¾“å…¥æ‚¨çš„æ˜µç§°..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section">
                        <label>å¯¹æ–¹æ˜µç§°</label>
                        <input type="text" id="aiNickname" placeholder="è¾“å…¥AIçš„æ˜µç§°..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>
                </div>

                <div id="backgroundTab" class="settings-tab-content">
                    <div class="avatar-section">
                        <label>èŠå¤©èƒŒæ™¯é¢œè‰²</label>
                        <input type="color" id="chatBgColor" style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section">
                        <label>èƒŒæ™¯å›¾ç‰‡ URL</label>
                        <input type="text" id="chatBgImage" placeholder="è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section" style="font-size: 12px; color: #999;">
                        æç¤ºï¼šé¢œè‰²å’Œå›¾ç‰‡éƒ½è®¾ç½®æ—¶ï¼Œå›¾ç‰‡ä¼˜å…ˆæ˜¾ç¤º
                    </div>
                    
                    <div class="avatar-section" style="border-top:1px solid #f0f0f0; padding-top:12px;">
                        <label>èŠå¤©æ°”æ³¡ä¸»é¢˜</label>
                        <div id="bubbleThemeList" style="display:flex; flex-direction:column; gap:8px;">
                            <label style="display:flex; align-items:center; gap:8px;">
                                <input type="radio" name="bubbleTheme" value="pink-yellow">
                                <span>ç²‰é»„ï¼ˆå¯¹æ–¹ ç²‰è‰² / æˆ‘ é»„è‰²ï¼‰</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px;">
                                <input type="radio" name="bubbleTheme" value="deep-blue">
                                <span>æ·±è“ï¼ˆå¯¹æ–¹ æµ…è“ / æˆ‘ æ·±è“ï¼‰</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px;">
                                <input type="radio" name="bubbleTheme" value="green-gray">
                                <span>ç»¿ç°ï¼ˆå¯¹æ–¹ ç»¿è‰² / æˆ‘ ç°è‰²ï¼‰</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:8px;">
                                <input type="radio" name="bubbleTheme" value="classic">
                                <span>ç»å…¸ï¼ˆå¯¹æ–¹ ç° / æˆ‘ è“ï¼‰</span>
                            </label>
                        </div>
                    </div>

                    <div class="avatar-section">
                        <label>è‡ªå®šä¹‰ CSSï¼ˆç”¨äºæ°”æ³¡æˆ–ç•Œé¢æ ·å¼ï¼‰</label>
                        <textarea id="customBubbleCss" placeholder="åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰ CSSï¼Œä¾‹å¦‚ .message.received{background:#fce4ec;}" style="width:100%; height:80px; padding:8px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box; font-size:12px;"></textarea>
                    </div>

                    <div class="avatar-section">
                        <label>å­—ä½“å¤§å°</label>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <input type="range" id="chatFontSize" min="12" max="24" value="14" style="flex:1;">
                            <div id="chatFontSizeDisplay" style="width:36px; text-align:center; font-size:12px; color:#333;">14px</div>
                        </div>
                    </div>
                </div>

                <div id="roleTab" class="settings-tab-content">
                    <div class="avatar-section">
                        <label>è§’è‰²åç§°</label>
                        <input type="text" id="editRoleName" placeholder="è§’è‰²åç§°" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section">
                        <label>ç³»ç»Ÿæç¤ºè¯</label>
                        <textarea id="editSystemPrompt" placeholder="ç³»ç»Ÿæç¤ºè¯..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 12px; height: 100px; resize: none; margin-bottom: 8px;"></textarea>
                    </div>

                    <div class="avatar-section">
                        <label>æ¨¡å‹</label>
                        <select id="editRoleModel" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;"></select>
                    </div>

                    <div class="avatar-section">
                        <label>å…³è”ä¸–ç•Œä¹¦</label>
                        <div id="worldbookSelectorContainer" style="background-color: #f9f9f9; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; border: 1px solid #eee;">
                            <!-- ä¸–ç•Œä¹¦å°†åœ¨æ­¤ä»¥æ»šåŠ¨å‹¾é€‰æ–¹å¼æ˜¾ç¤ºï¼ˆä»…æ˜¾ç¤ºä¹¦åï¼‰ -->
                        </div>
                    </div>

                    <div class="avatar-section">
                        <label>å¯ç”¨ç‹¬ç«‹åå°æ´»åŠ¨</label>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="enableIndependentBackground">
                            <span style="font-size:12px; color:#666;">å¼€å¯å AI å¯åœ¨åå°å•ç‹¬æ‰§è¡Œä»»åŠ¡</span>
                        </div>
                    </div>

                    <div class="avatar-section">
                        <label>ç‹¬ç«‹è¡ŒåŠ¨å†·å´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="independentCooldown" min="0" value="0" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;">
                    </div>

                    <div class="avatar-section">
                        <label>çŸ­æœŸè®°å¿†æ¡æ•°</label>
                        <input type="number" id="shortTermMemoryCount" min="0" value="0" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;">
                    </div>

                    <div class="avatar-section">
                        <label>è‡ªåŠ¨æ€»ç»“é•¿æœŸè®°å¿†</label>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="autoSummarizeLongTerm">
                            <span style="font-size:12px; color:#666;">å¼€å¯åç³»ç»Ÿä¼šè‡ªåŠ¨æ€»ç»“å¹¶å‹ç¼©é•¿æœŸè®°å¿†</span>
                        </div>
                    </div>

                    <div class="avatar-section">
                        <label>è‡ªåŠ¨æ€»ç»“é—´éš”ï¼ˆæ¡ï¼‰</label>
                        <input type="number" id="autoSummarizeInterval" min="1" value="10" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;">
                    </div>

                    <div class="avatar-section">
                        <label>æœ€å¤šå›å¤æ¡æ•°</label>
                        <input type="number" id="maxReplyMessages" min="1" max="10" value="1" placeholder="1-10æ¡" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;">
                        <p style="font-size: 12px; color: #888; margin: 5px 0 0;">è®¾ç½®AIæœ€å¤šåˆ†å‡ æ¡æ¶ˆæ¯å‘é€ï¼Œæ›´åƒçœŸäººèŠå¤©</p>
                    </div>
                </div>

                <div class="avatar-modal-buttons">
                    <button class="save" onclick="saveAllSettings()">ä¿å­˜</button>
                    <button class="cancel" onclick="closeAvatarSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
    </div> <script>
        // 1. å…¨å±€å˜é‡å’Œåˆå§‹åŒ–
        let currentScreen = 'home';
        const screens = {
            home: document.getElementById('homeScreen'),
            api: document.getElementById('apiScreen'),
            beautify: document.getElementById('beautifyScreen'),
            zhihu: document.getElementById('zhihuScreen'),
            zhihuMessages: document.getElementById('zhihuMessagesScreen'),
            font: document.getElementById('fontScreen'),
            roleList: document.getElementById('roleListScreen'),
            roleManager: document.getElementById('roleManagerScreen'),
            chatDetail: document.getElementById('chatDetailScreen'),
            worldbook: document.getElementById('worldbookListScreen'),
            worldbookDetail: document.getElementById('worldbookDetailScreen')
        };
        let roles = [];
        let currentRoleId = null;
        let worldbooks = [];
        let currentWorldbookId = null;
        
        // åˆå§‹åŠ è½½ï¼šè¯»å–æœ¬åœ°å­˜å‚¨
        window.onload = function() {
            document.getElementById('apiUrl').value = localStorage.getItem('apiUrl') || '';
            document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
            
            if (localStorage.getItem('apiUrl') && localStorage.getItem('apiKey')) {
                useHardcodedModels();
                const selectedModel = localStorage.getItem('selectedModel');
                if (selectedModel) {
                    const modelSelect = document.getElementById('modelSelect');
                    if (modelSelect.querySelector(`option[value="${selectedModel}"]`)) {
                        modelSelect.value = selectedModel;
                    } else {
                        const option = document.createElement('option');
                        option.value = selectedModel;
                        option.textContent = selectedModel;
                        modelSelect.appendChild(option);
                        modelSelect.value = selectedModel;
                    }
                }
                document.getElementById('modelSelectionArea').style.display = 'block';
                document.getElementById('apiStatus').style.color = 'gray';
                document.getElementById('apiStatus').textContent = 'å½“å‰çŠ¶æ€: å·²åŠ è½½ä¸Šæ¬¡é…ç½®ï¼Œè¯·ç‚¹å‡»â€œæ‹‰å–æ¨¡å‹â€éªŒè¯ã€‚';
            }
            
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            worldbooks = JSON.parse(localStorage.getItem('worldbooks') || '[]');
            loadRoleList();
            loadWorldbookList();
            loadBeautifySettings();
            // åº”ç”¨æ°”æ³¡ä¸»é¢˜ä¸å­—ä½“ï¼ˆå…¨å±€ï¼‰
            applyChatTheme();
            applyChatFontSize();
            // åº”ç”¨è‡ªå®šä¹‰å­—ä½“ï¼ˆå¦‚æœæœ‰ï¼‰
            applyFont();
            // åˆå§‹åŒ–ï¼šä¸»å±å¹•æ·»åŠ  home-mode class
            document.getElementById('appContainer').classList.add('home-mode');
            // å¯åŠ¨æ—¶é’Ÿå¹¶æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            updateClock();
            setInterval(updateClock, 60000);
        };

        // åœ¨å°æ‰‹æœºå†…éƒ¨æ˜¾ç¤ºçŸ­æ¶ˆæ¯æ›¿ä»£æµè§ˆå™¨ alertï¼ˆè‡ªé€‚åº”æ‰‹æœºå®½åº¦ï¼‰
        function showPhoneAlert(msg, timeout = 2500) {
            let existing = document.getElementById('phoneAlert');
            if (existing) existing.remove();
            const alertEl = document.createElement('div');
            alertEl.id = 'phoneAlert';
            alertEl.style.position = 'absolute';
            alertEl.style.left = '50%';
            alertEl.style.bottom = '30px';
            alertEl.style.transform = 'translateX(-50%)';
            alertEl.style.maxWidth = '320px';
            alertEl.style.width = '80%';
            alertEl.style.padding = '10px 14px';
            alertEl.style.background = 'rgba(0,0,0,0.8)';
            alertEl.style.color = '#fff';
            alertEl.style.borderRadius = '12px';
            alertEl.style.fontSize = '14px';
            alertEl.style.textAlign = 'center';
            alertEl.style.zIndex = '9999';
            alertEl.textContent = msg;
            document.querySelector('.phone-screen').appendChild(alertEl);
            if (timeout > 0) setTimeout(() => { alertEl.remove(); }, timeout);
        }

        // ----- IndexedDB è¾…åŠ©ï¼šå­˜å–å­—ä½“ Blob -----
        function openFontDB() {
            return new Promise((resolve, reject) => {
                try {
                    const req = indexedDB.open('SmallPhoneFonts', 1);
                    req.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('fonts')) db.createObjectStore('fonts');
                    };
                    req.onsuccess = (e) => resolve(e.target.result);
                    req.onerror = (e) => reject(e.target.error);
                } catch (err) {
                    reject(err);
                }
            });
        }

        async function saveFontBlobToIDB(key, blob) {
            const db = await openFontDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('fonts', 'readwrite');
                const store = tx.objectStore('fonts');
                const req = store.put(blob, key);
                req.onsuccess = () => resolve(true);
                req.onerror = () => reject(req.error || new Error('IDB put failed'));
            });
        }

        async function getFontBlobFromIDB(key) {
            try {
                const db = await openFontDB();
                return await new Promise((resolve, reject) => {
                    const tx = db.transaction('fonts', 'readonly');
                    const store = tx.objectStore('fonts');
                    const req = store.get(key);
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => reject(req.error || new Error('IDB get failed'));
                });
            } catch (e) {
                return null;
            }
        }

        async function deleteFontFromIDB(key) {
            try {
                const db = await openFontDB();
                return await new Promise((resolve, reject) => {
                    const tx = db.transaction('fonts', 'readwrite');
                    const store = tx.objectStore('fonts');
                    const req = store.delete(key);
                    req.onsuccess = () => resolve(true);
                    req.onerror = () => reject(req.error || new Error('IDB delete failed'));
                });
            } catch (e) {
                return false;
            }
        }

        function dataURLToBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8 = new Uint8Array(n);
            while (n--) u8[n] = bstr.charCodeAt(n);
            return new Blob([u8], { type: mime });
        }

        // 2. å±å¹•åˆ‡æ¢å‡½æ•°
        function showScreen(screenName) {
            for (let key in screens) {
                screens[key].style.display = 'none';
            }
            screens[screenName].style.display = 'flex'; 
            currentScreen = screenName;
        }

        function showHomeScreen() {
            // æ¢å¤ä¸ºä¸»å±å¹•å¹¶æ˜¾ç¤ºçŠ¶æ€æ 
            screens['home'].style.display = 'flex';
            screens['api'].style.display = 'none';
            screens['font'].style.display = 'none';
            screens['roleList'].style.display = 'none';
            screens['roleManager'].style.display = 'none';
            screens['chatDetail'].style.display = 'none';
            screens['beautify'].style.display = 'none';
            screens['worldbook'].style.display = 'none';
            screens['zhihu'] && (screens['zhihu'].style.display = 'none');
            screens['worldbookDetail'].style.display = 'none';
            document.querySelector('.status-bar').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('app-mode');
            document.getElementById('appContainer').classList.add('home-mode');
            const dock = document.getElementById('dock');
            if (dock) dock.style.display = 'flex';
            
            // ç¡®ä¿å†…å®¹èƒŒæ™¯æ­£ç¡®æ˜¾ç¤º
            const bg = localStorage.getItem('beautify_background');
            if (bg) {
                document.getElementById('appContainer').style.background = 'transparent';
                document.getElementById('appContainer').style.backgroundImage = 'none';
            } else {
                document.getElementById('appContainer').style.background = '#fff';
                document.getElementById('appContainer').style.backgroundImage = 'none';
            }
            
            currentScreen = 'home';

            // æ¢å¤æ‰‹æœºå£çº¸ï¼ˆä¸»å±æ˜¾ç¤ºå£çº¸ï¼‰
            try { loadBeautifySettings(); } catch (e) {}
        }

        // -------- çŸ¥ä¹ é¡µé¢åŠŸèƒ½ --------
        function openZhihuModal() {
            document.getElementById('zhihuModal').style.display = 'block';
            document.getElementById('zhihuInput').value = '';
            document.getElementById('zhihuInput').focus();
        }

        function closeZhihuModal() {
            document.getElementById('zhihuModal').style.display = 'none';
            document.getElementById('zhihuInput').value = '';
        }

        function getZhihuPosts() {
            try { return JSON.parse(localStorage.getItem('zhihu_posts') || '[]'); } catch (e) { return []; }
        }

        function saveZhihuPosts(posts) {
            localStorage.setItem('zhihu_posts', JSON.stringify(posts || []));
        }

        function renderZhihuPosts() {
            const container = document.getElementById('zhihuPosts');
            if (!container) return;
            const posts = getZhihuPosts();
            container.innerHTML = '';
            if (posts.length === 0) {
                const empty = document.createElement('div');
                empty.style.color = '#888';
                empty.style.textAlign = 'center';
                empty.style.padding = '24px 12px';
                empty.textContent = 'è¿˜æ²¡æœ‰å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹ + å‘è¡¨ç¬¬ä¸€æ¡';
                container.appendChild(empty);
                return;
            }
            posts.slice().reverse().forEach(p => {
                const card = document.createElement('div');
                card.style.background = '#fff';
                card.style.borderRadius = '10px';
                card.style.padding = '10px';
                card.style.boxShadow = '0 2px 10px rgba(0,0,0,0.05)';
                card.style.color = '#222';
                const txt = document.createElement('div');
                txt.style.whiteSpace = 'pre-wrap';
                txt.style.lineHeight = '1.45';
                txt.textContent = p.text || '';
                const meta = document.createElement('div');
                meta.style.fontSize = '11px';
                meta.style.color = '#999';
                meta.style.marginTop = '8px';
                meta.textContent = new Date(p.ts).toLocaleString();
                card.appendChild(txt);
                card.appendChild(meta);
                container.appendChild(card);
            });
        }

        function postToZhihu() {
            const text = (document.getElementById('zhihuInput')?.value || '').trim();
            if (!text) { alert('è¯·è¾“å…¥å†…å®¹åå†å‘å¸ƒ'); return; }
            const posts = getZhihuPosts();
            posts.push({ text, ts: Date.now() });
            saveZhihuPosts(posts);
            closeZhihuModal();
            renderZhihuPosts();
            showPhoneAlert('å·²å‘å¸ƒåˆ°çŸ¥ä¹');
        }

        // bind zhihu bottom toolbar buttons when DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('zhihuAddBtn');
            if (btn) btn.addEventListener('click', openZhihuModal);
            const homeBtn = document.getElementById('zhihuHomeBtn');
            if (homeBtn) homeBtn.addEventListener('click', () => { showApp('zhihu'); renderZhihuPosts(); });
            const msgBtn = document.getElementById('zhihuMsgBtn');
            if (msgBtn) msgBtn.addEventListener('click', () => { showApp('zhihuMessages'); });
            // ensure posts render when entering zhihu
            renderZhihuPosts();
        });

        // ----- Zhihu messages renderer (simulated private messages) -----
        function getSampleMessages() {
            return [
                { id:1, name:'å®˜æ–¹è´¦å·æ¶ˆæ¯', preview:'', time:'10-21', unread:0 },
                { id:2, name:'ç”¨ç ”å°åŠ©æ‰‹', preview:'', time:'09-29', unread:0 },
                { id:3, name:'ç³»ç»Ÿæ¶ˆæ¯', preview:'', time:'03-23', unread:0 }
            ];
        }

        function renderZhihuMessages() {
            const list = document.getElementById('zhihuMessageList');
            if (!list) return;
            list.innerHTML = '';
            const items = getSampleMessages();
            items.forEach(it => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '12px';
                row.style.padding = '10px';
                row.style.background = '#fff';
                row.style.borderRadius = '8px';
                row.style.boxShadow = '0 2px 6px rgba(0,0,0,0.03)';

                const avatar = document.createElement('div');
                avatar.style.width = '46px';
                avatar.style.height = '46px';
                avatar.style.borderRadius = '50%';
                avatar.style.background = '#e9f0ff';
                avatar.style.flex = '0 0 46px';
                avatar.style.display = 'flex';
                avatar.style.alignItems = 'center';
                avatar.style.justifyContent = 'center';
                avatar.style.fontSize = '18px';
                avatar.textContent = it.name[0] || '?';

                const body = document.createElement('div');
                body.style.flex = '1';
                const title = document.createElement('div');
                title.textContent = it.name;
                title.style.fontWeight = '700';
                title.style.color = '#222';
                const preview = document.createElement('div');
                preview.textContent = it.preview;
                preview.style.fontSize = '13px';
                preview.style.color = '#777';
                preview.style.marginTop = '6px';
                body.appendChild(title);
                body.appendChild(preview);

                const meta = document.createElement('div');
                meta.style.textAlign = 'right';
                const time = document.createElement('div');
                time.textContent = it.time;
                time.style.fontSize = '12px';
                time.style.color = '#999';
                meta.appendChild(time);
                // no unread badge by default

                row.appendChild(avatar);
                row.appendChild(body);
                row.appendChild(meta);
                list.appendChild(row);
            });
        }
        
        function showApp(appName) {
            // è¿›å…¥ APP æ—¶éšè—çŠ¶æ€æ ï¼Œè®©APPå†…å®¹é“ºæ»¡å°æ‰‹æœºå±å¹•
            if (appName && appName !== 'home') {
                document.querySelector('.status-bar').classList.add('hidden');
                document.getElementById('appContainer').classList.add('app-mode');
                document.getElementById('appContainer').classList.remove('home-mode');
                // å¼ºåˆ¶APPå®¹å™¨èƒŒæ™¯ä¸ºç™½è‰²
                document.getElementById('appContainer').style.background = '#ffffff';
                document.getElementById('appContainer').style.backgroundImage = 'none';
                // è¿›å…¥ APP æ—¶ç¦ç”¨æ‰‹æœºå£çº¸ï¼Œé¿å…è¾¹ç¼˜é€å‡º
                const phone = document.querySelector('.phone-screen');
                if (phone) {
                    phone.style.backgroundImage = 'none';
                    phone.style.backgroundColor = '#ffffff';
                }
                const dock = document.getElementById('dock');
                if (dock) dock.style.display = 'none';
            }

            screens['home'].style.display = 'none';
            screens['api'].style.display = 'none';
            screens['font'].style.display = 'none';
            screens['roleList'].style.display = 'none';
            screens['roleManager'].style.display = 'none';
            screens['chatDetail'].style.display = 'none';
            screens['beautify'].style.display = 'none';
            screens['worldbook'].style.display = 'none';
            screens['zhihu'] && (screens['zhihu'].style.display = 'none');
            screens['zhihuMessages'] && (screens['zhihuMessages'].style.display = 'none');
            screens['worldbookDetail'].style.display = 'none';
            const momentScreen = document.getElementById('momentScreen');
            if (momentScreen) momentScreen.style.display = 'none';

            // å¼ºåˆ¶æ‰€æœ‰å†…å®¹åŒºåŸŸä¸ºç™½è‰²èƒŒæ™¯
            document.querySelectorAll('.content, .api-settings, .chat-container').forEach(c => {
                c.style.background = '#ffffff !important';
                c.style.backgroundImage = 'none !important';
            });
            // ä¹Ÿç¡®ä¿æ¶ˆæ¯åŒºæ˜¯ç™½åº•ï¼ˆè‹¥å­˜åœ¨ï¼‰
            const chatMessagesEl = document.getElementById('chatMessages');
            if (chatMessagesEl) {
                chatMessagesEl.style.background = '#f8f8f8';
                chatMessagesEl.style.backgroundImage = 'none';
            }

            if (appName === 'roleList') {
                screens['roleList'].style.display = 'flex';
                loadRoleList(); 
            } else if (appName === 'roleManager') {
                screens['roleManager'].style.display = 'flex';
                loadModelSelectForRole(); 
            } else if (appName === 'chatDetail') {
                screens['chatDetail'].style.display = 'flex';
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                // ç¡®ä¿èŠå¤©èƒŒæ™¯åœ¨åŠ è½½å®Œæˆååº”ç”¨ï¼ˆä½†å› ä¸ºæˆ‘ä»¬åœ¨èŠå¤©ç•Œé¢å¼ºåˆ¶ç™½åº•ï¼Œè¿™é‡Œå»¶è¿Ÿåº”ç”¨ä¹Ÿä¸ä¼šè¦†ç›–ç™½è‰²ï¼‰
                setTimeout(() => applyChatsBackground(), 50);
            } else if (appName === 'beautify') {
                screens['beautify'].style.display = 'flex';
                // å°†å·²ä¿å­˜å€¼å¡«å……åˆ°è¾“å…¥æ¡†
                const bg = localStorage.getItem('beautify_background') || '';
                const iconApi = localStorage.getItem('beautify_icon_api') || '';
                const iconChat = localStorage.getItem('beautify_icon_chat') || '';
                const iconBeautify = localStorage.getItem('beautify_icon_beautifyApp') || '';
                document.getElementById('backgroundUrl').value = bg;
                document.getElementById('iconUrl').value = '';
                document.getElementById('beautifyStatus').textContent = 'å½“å‰çŠ¶æ€: æœªä¿å­˜';
                // å¡«å……èŠå¤©èƒŒæ™¯è®¾ç½®
                const chatBgColor = localStorage.getItem('chat_bg_color') || '#f8f8f8';
                const chatBgImage = localStorage.getItem('chat_bg_image') || '';
                const c1 = document.getElementById('beautifyChatBgColor');
                const c2 = document.getElementById('beautifyChatBgImage');
                if (c1) c1.value = chatBgColor;
                if (c2) c2.value = chatBgImage;
            } else if (appName === 'font') {
                // æ‰“å¼€å­—ä½“è®¾ç½®é¡µé¢
                screens['font'].style.display = 'flex';
                const saved = localStorage.getItem('custom_font_url') || '';
                const input = document.getElementById('fontUrlInput');
                if (input) input.value = saved;
                // æ›´æ–°é¢„è§ˆ
                try { previewFont(); } catch (e) { /* ignore */ }
            } else if (appName === 'api') {
                screens['api'].style.display = 'flex';
            } else if (appName === 'chat') { 
                showApp('roleList');
            } else if (appName === 'worldbook') {
                screens['worldbook'].style.display = 'flex';
                loadWorldbookList();
            } else if (appName === 'zhihu') {
                screens['zhihu'].style.display = 'flex';
                // render posts when entering the Zhihu app
                try { renderZhihuPosts(); } catch (e) { console.warn('æ¸²æŸ“çŸ¥ä¹å¸–å­å¤±è´¥', e); }
            } else if (appName === 'zhihuMessages') {
                screens['zhihuMessages'].style.display = 'flex';
                try { renderZhihuMessages(); } catch (e) { console.warn('æ¸²æŸ“çŸ¥ä¹æ¶ˆæ¯å¤±è´¥', e); }
            } else if (appName === 'worldbookDetail') {
                screens['worldbookDetail'].style.display = 'flex';
                loadWorldbookDetail();
            } else if (!appName || appName === 'home') {
                const dock = document.getElementById('dock');
                if (dock) dock.style.display = 'flex';
            }
        }
        
        // --- API è®¾ç½®æ ¸å¿ƒé€»è¾‘ ---

        // 3. è¾…åŠ©å‡½æ•°ï¼šæä¾›ç¡¬ç¼–ç çš„æ¨¡å‹åˆ—è¡¨ (ä½œä¸ºæ‹‰å–å¤±è´¥çš„å¤‡ç”¨)
        function getHardcodedModels() {
            return {
                provider: "å†…ç½®é€šç”¨æœåŠ¡",
                models: [
                    'gemini-2.5-flash', 
                    'gemini-2.5-pro',
                    'gpt-4o',
                    'gpt-3.5-turbo',
                    'claude-3-sonnet'
                ]
            };
        }
        
        // 4. æ–°å¢ï¼šä½¿ç”¨ç¡¬ç¼–ç æ¨¡å‹åˆ—è¡¨ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
        function useHardcodedModels() {
            const modelSelect = document.getElementById('modelSelect');
            const statusElement = document.getElementById('apiStatus');
            const { models, provider } = getHardcodedModels();
            
            modelSelect.innerHTML = '';
            models.forEach((model, index) => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
                if (index === 0) {
                    modelSelect.value = model;
                    localStorage.setItem('selectedModel', model); 
                }
            });
            document.getElementById('modelSelectionArea').style.display = 'block';
            statusElement.style.color = 'red';
            statusElement.textContent = `ğŸš¨ è­¦å‘Š: æ— æ³•æ‹‰å–æ¨¡å‹ï¼Œå·²ä½¿ç”¨å†…ç½®åˆ—è¡¨ã€‚`;
        }

        // 5. å®šåˆ¶åŒ–å‡½æ•°ï¼šæ‹‰å–æ¨¡å‹å¹¶ä¿å­˜é…ç½®
        async function fetchModelsAndSave() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusElement = document.getElementById('apiStatus');
            const modelSelect = document.getElementById('modelSelect');

            if (!apiUrl || !apiKey) {
                statusElement.style.color = 'red';
                statusElement.textContent = 'å½“å‰çŠ¶æ€: è¯·å¡«å†™ URL å’Œ Keyï¼';
                document.getElementById('modelSelectionArea').style.display = 'none';
                return;
            }
            
            statusElement.style.color = 'orange';
            statusElement.textContent = 'å½“å‰çŠ¶æ€: æ­£åœ¨å‘åä»£æœåŠ¡è¯·æ±‚æ¨¡å‹åˆ—è¡¨...';
            document.getElementById('modelSelectionArea').style.display = 'none'; 
            
            localStorage.setItem('apiUrl', apiUrl);
            localStorage.setItem('apiKey', apiKey);

            try {
                const base = (apiUrl.endsWith('/')) ? apiUrl.slice(0, -1) : apiUrl;
                const testUrls = [`${base}/models`, `${base}/v1/models`];
                let modelsResult = null;
                
                for (const url of testUrls) {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {'Authorization': `Bearer ${apiKey}`}
                    });
                    
                    if (response.ok) {
                        modelsResult = await response.json();
                        break; 
                    }
                }

                if (modelsResult && modelsResult.data && Array.isArray(modelsResult.data)) {
                    
                    const models = modelsResult.data.map(m => m.id);
                    if (models.length === 0) { throw new Error("APIæ¥å£è¿”å›çš„æ¨¡å‹åˆ—è¡¨ä¸ºç©ºã€‚"); }

                    modelSelect.innerHTML = '';
                    models.forEach((model, index) => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                        
                        if (index === 0) {
                            modelSelect.value = model;
                            localStorage.setItem('selectedModel', model); 
                        }
                    });

                    document.getElementById('modelSelectionArea').style.display = 'block';
                    document.getElementById('apiStatus').style.color = 'green';
                    statusElement.textContent = `å½“å‰çŠ¶æ€: æ¨¡å‹åˆ—è¡¨æ‹‰å–æˆåŠŸ (å…± ${models.length} ä¸ª)ï¼`;

                    modelSelect.onchange = function() {
                        localStorage.setItem('selectedModel', modelSelect.value);
                        document.getElementById('apiStatus').textContent = `å½“å‰çŠ¶æ€: å·²é€‰æ‹©æ¨¡å‹ [${modelSelect.value}]ã€‚`;
                    };

                } else {
                    throw new Error("æ¨¡å‹æ¥å£è¿”å›æ ¼å¼éæ ‡å‡†ï¼Œå›é€€åˆ°å†…ç½®åˆ—è¡¨ã€‚");
                }

            } catch (error) {
                useHardcodedModels(); 
                statusElement.style.color = 'red';
                statusElement.textContent = `ğŸš¨ é”™è¯¯: æ— æ³•æ‹‰å–çœŸå®æ¨¡å‹ã€‚å·²å›é€€åˆ°å†…ç½®åˆ—è¡¨ã€‚`;
                console.error("æ¨¡å‹æ‹‰å–å¤±è´¥ï¼ŒåŸå› ï¼š", error);
            }
        }
        
        // 6. æ–°å¢å‡½æ•°ï¼šæ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹
        function addCustomModel() {
            const customInput = document.getElementById('customModelInput');
            const modelSelect = document.getElementById('modelSelect');
            const newModelName = customInput.value.trim();
            const statusElement = document.getElementById('apiStatus');

            if (newModelName) {
                let optionExists = false;
                for (let i = 0; i < modelSelect.options.length; i++) {
                    if (modelSelect.options[i].value === newModelName) {
                        optionExists = true;
                        break;
                    }
                }

                if (!optionExists) {
                    const newOption = document.createElement('option');
                    newOption.value = newModelName;
                    newOption.textContent = newModelName;
                    modelSelect.appendChild(newOption);
                }
                
                modelSelect.value = newModelName;
                localStorage.setItem('selectedModel', newModelName);
                statusElement.style.color = 'green';
                statusElement.textContent = `å½“å‰çŠ¶æ€: å·²æ·»åŠ å¹¶é€‰æ‹©äº†è‡ªå®šä¹‰æ¨¡å‹ [${newModelName}]ã€‚`;
                customInput.value = ''; 
                
            } else {
                alert('è¯·è¾“å…¥è¦æ·»åŠ çš„æ¨¡å‹åç§°ï¼');
            }
        }

        // 6.1 ç¾åŒ–åŠŸèƒ½ï¼šåŠ è½½/åº”ç”¨/é¢„è§ˆ/ä¿å­˜è®¾ç½®
        function loadBeautifySettings() {
            const phone = document.querySelector('.phone-screen');
            const bg = localStorage.getItem('beautify_background');
            const defaultBg = 'https://i.postimg.cc/K8K84gkL/IMG-4887.jpg';
            if (bg) {
                phone.style.backgroundImage = `url(${bg})`;
                phone.style.backgroundSize = 'cover';
                phone.style.backgroundPosition = 'center';
            } else {
                phone.style.backgroundImage = `url(${defaultBg})`;
                phone.style.backgroundSize = 'cover';
                phone.style.backgroundPosition = 'center';
            }

            // å¦‚æœè®¾ç½®äº†èƒŒæ™¯ï¼ˆåŒ…æ‹¬é»˜è®¤èƒŒæ™¯ï¼‰ï¼Œå°†å†…éƒ¨ content åŒºåŸŸèƒŒæ™¯è®¾ä¸ºé€æ˜ä»¥æ˜¾ç¤ºèƒŒæ™¯å›¾
            const contents = document.querySelectorAll('.content');
            if (phone.style.backgroundImage && phone.style.backgroundImage !== '') {
                contents.forEach(c => c.style.background = 'transparent');
            } else {
                contents.forEach(c => c.style.background = '#fff');
            }

            const defaultIcons = {
                api: 'https://i.postimg.cc/5NXVmWxq/IMG-4886.jpg',
                chat: 'https://i.postimg.cc/VLx3BSZk/IMG-4884.jpg',
                worldbook: 'https://i.postimg.cc/bJV5Gd2y/IMG-4883.jpg',
                beautifyApp: 'https://i.postimg.cc/ZqV7g0H3/IMG-4885.jpg',
                font: 'https://i.postimg.cc/t498M0bK/IMG-4888.jpg'
                ,zhihu: 'https://i.postimg.cc/tgp46TnT/IMG-4904.jpg'
            };

            const applyIcon = (dataApp, key) => {
                const img = document.querySelector(`.app-icon img[data-app="${dataApp}"]`);
                const saved = localStorage.getItem(key);
                if (img) {
                    if (saved) img.src = saved;
                    else if (defaultIcons[dataApp]) img.src = defaultIcons[dataApp];
                }
            };

            applyIcon('api', 'beautify_icon_api');
            applyIcon('chat', 'beautify_icon_chat');
            applyIcon('beautifyApp', 'beautify_icon_beautifyApp');
            applyIcon('worldbook', 'beautify_icon_worldbook');
            applyIcon('zhihu', 'beautify_icon_zhihu');
            applyIcon('font', 'beautify_icon_font');

            // Load widget images if set
            try { loadBeautifyWidgetImages(); } catch (e) { console.warn('åŠ è½½è£…é¥°å—å›¾ç‰‡å¤±è´¥', e); }
        }

        // 6.2 çŠ¶æ€æ æ—¶é’Ÿï¼šæ›´æ–°ä¸»å±å¹•å·¦ä¸Šè§’æ—¶é—´
        function updateClock() {
            const el = document.getElementById('statusTime');
            if (!el) return;
            const now = new Date();
            let h = now.getHours();
            const m = now.getMinutes();
            const ampm = h >= 12 ? 'PM' : 'AM';
            let displayH = h % 12;
            if (displayH === 0) displayH = 12;
            el.textContent = `${displayH}:${m.toString().padStart(2,'0')} ${ampm}`;
        }

        function previewBeautify(isPreview) {
            const target = document.getElementById('targetAppSelect').value;
            const iconUrl = document.getElementById('iconUrl').value.trim();
            const bgUrl = document.getElementById('backgroundUrl').value.trim();

            if (isPreview) {
                if (target === 'home-bg') {
                    if (!bgUrl) { alert('è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL ä»¥é¢„è§ˆ'); return; }
                    document.querySelector('.phone-screen').style.backgroundImage = `url(${bgUrl})`;
                    document.querySelector('.phone-screen').style.backgroundSize = 'cover';
                    document.querySelectorAll('.content').forEach(c => c.style.background = 'transparent');
                    document.getElementById('beautifyStatus').textContent = 'å·²é¢„è§ˆèƒŒæ™¯ï¼ˆæœªä¿å­˜ï¼‰';
                } else {
                    if (!iconUrl) { alert('è¯·è¾“å…¥å›¾æ ‡å›¾ç‰‡ URL ä»¥é¢„è§ˆ'); return; }
                    const targetImg = document.querySelector(`.app-icon img[data-app="${target}"]`);
                    if (targetImg) targetImg.src = iconUrl;
                    const previewIcon = document.getElementById('previewIcon');
                    previewIcon.src = iconUrl;
                    previewIcon.style.display = 'block';
                    document.getElementById('previewText').textContent = '';
                    document.getElementById('beautifyStatus').textContent = 'å·²é¢„è§ˆå›¾æ ‡ï¼ˆæœªä¿å­˜ï¼‰';
                }
            } else {
                loadBeautifySettings();
                const previewIcon = document.getElementById('previewIcon');
                previewIcon.style.display = 'none';
                document.getElementById('previewText').textContent = 'åœ¨æ­¤æ˜¾ç¤ºé¢„è§ˆ';
                document.getElementById('beautifyStatus').textContent = 'é¢„è§ˆå·²å–æ¶ˆ';
            }
        }

        function applyAndSaveBeautify() {
            const target = document.getElementById('targetAppSelect').value;
            const iconUrl = document.getElementById('iconUrl').value.trim();
            const bgUrl = document.getElementById('backgroundUrl').value.trim();

            if (target === 'home-bg') {
                if (!bgUrl) { alert('è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL'); return; }
                localStorage.setItem('beautify_background', bgUrl);
                document.querySelectorAll('.content').forEach(c => c.style.background = 'transparent');
            } else {
                if (!iconUrl) { alert('è¯·è¾“å…¥å›¾æ ‡å›¾ç‰‡ URL'); return; }
                const key = `beautify_icon_${target}`;
                localStorage.setItem(key, iconUrl);
            }

            loadBeautifySettings();
            document.getElementById('beautifyStatus').style.color = 'green';
            document.getElementById('beautifyStatus').textContent = 'å½“å‰çŠ¶æ€: ä¿å­˜æˆåŠŸï¼';
            alert('å·²ä¿å­˜ç¾åŒ–è®¾ç½®');
        }

        // æ¢å¤é»˜è®¤ç¾åŒ–è®¾ç½®ï¼šåˆ é™¤è‡ªå®šä¹‰èƒŒæ™¯å’Œå›¾æ ‡è®¾ç½®ï¼Œæ¢å¤å†…ç½®é»˜è®¤
        function restoreBeautifyDefaults() {
            const keys = [
                'beautify_background',
                'beautify_icon_api',
                'beautify_icon_chat',
                'beautify_icon_beautifyApp',
                'beautify_icon_worldbook',
                'beautify_icon_font'
            ];
            keys.forEach(k => localStorage.removeItem(k));
            // æ¸…ç©ºè¾“å…¥æ¡†
            const bgInput = document.getElementById('backgroundUrl'); if (bgInput) bgInput.value = '';
            const iconInput = document.getElementById('iconUrl'); if (iconInput) iconInput.value = '';
            // é‡æ–°åº”ç”¨é»˜è®¤æ ·å¼
            loadBeautifySettings();
            document.getElementById('beautifyStatus').style.color = 'orange';
            document.getElementById('beautifyStatus').textContent = 'å·²æ¢å¤é»˜è®¤ç¾åŒ–';
            showPhoneAlert('å·²æ¢å¤é»˜è®¤ç¾åŒ–');
        }

        // â€”â€” ç¾åŒ–é¡µï¼šèŠå¤©èƒŒæ™¯è®¾ç½® â€”â€”
        function previewBeautifyChatBackground() {
            const color = (document.getElementById('beautifyChatBgColor')?.value || '#f8f8f8');
            const image = (document.getElementById('beautifyChatBgImage')?.value || '').trim();
            const chat = document.getElementById('chatMessages');
            if (!chat) {
                showPhoneAlert('è¯·å…ˆè¿›å…¥â€œèŠå¤©â€é¡µæŸ¥çœ‹é¢„è§ˆ');
                return;
            }
            chat.style.backgroundColor = color || '#f8f8f8';
            if (image) {
                chat.style.backgroundImage = `url(${image})`;
                chat.style.backgroundSize = 'cover';
                chat.style.backgroundPosition = 'center';
            } else {
                chat.style.backgroundImage = 'none';
            }
            document.getElementById('beautifyStatus').style.color = 'gray';
            document.getElementById('beautifyStatus').textContent = 'å·²é¢„è§ˆèŠå¤©èƒŒæ™¯ï¼ˆæœªä¿å­˜ï¼‰';
        }

        function saveBeautifyChatBackground() {
            const color = (document.getElementById('beautifyChatBgColor')?.value || '#f8f8f8');
            const image = (document.getElementById('beautifyChatBgImage')?.value || '').trim();
            localStorage.setItem('chat_bg_color', color);
            localStorage.setItem('chat_bg_image', image);
            try { applyChatsBackground(); } catch (e) {}
            document.getElementById('beautifyStatus').style.color = 'green';
            document.getElementById('beautifyStatus').textContent = 'å½“å‰çŠ¶æ€: å·²ä¿å­˜èŠå¤©èƒŒæ™¯ï¼';
            showPhoneAlert('å·²ä¿å­˜èŠå¤©èƒŒæ™¯è®¾ç½®');
        }

        // â€”â€” æ–°å¢ï¼šä¸»å±è£…é¥°å—å›¾ç‰‡å¤„ç† â€”â€”
        function readFileInputAsDataUrl(fileInput, callback) {
            const f = fileInput?.files?.[0];
            if (!f) { callback(null); return; }
            const reader = new FileReader();
            reader.onload = function(e) { callback(e.target.result); };
            reader.onerror = function() { callback(null); };
            reader.readAsDataURL(f);
        }

        function previewWidgetImage(kind) {
            const fileEl = document.getElementById(`beautifyWidget${kind === 'wide' ? 'WideFile' : 'SquareFile'}`);
            const urlEl = document.getElementById(`beautifyWidget${kind === 'wide' ? 'Wide' : 'Square'}`);
            const previewUrl = urlEl.value.trim();
            if (fileEl && fileEl.files && fileEl.files.length > 0) {
                readFileInputAsDataUrl(fileEl, dataUrl => {
                    if (dataUrl) applyWidgetToPreview(kind, dataUrl, false);
                    else showPhoneAlert('è¯»å–å›¾ç‰‡å¤±è´¥');
                });
            } else if (previewUrl) {
                applyWidgetToPreview(kind, previewUrl, false);
            } else {
                showPhoneAlert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡æˆ–è¾“å…¥å›¾ç‰‡ URL');
            }
        }

        function applyWidgetToPreview(kind, imageUrl, persist) {
            // Apply to the actual home screen preview widgets if present
            const selector = kind === 'wide' ? '.widget.wide' : '.widget.square';
            document.querySelectorAll(selector).forEach(el => {
                el.style.backgroundImage = `url('${imageUrl}')`;
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                const img = el.querySelector('img'); if (img) img.style.display = 'none';
            });
            if (persist) {
                const key = kind === 'wide' ? 'beautify_widget_wide' : 'beautify_widget_square';
                localStorage.setItem(key, imageUrl);
                document.getElementById('beautifyStatus').style.color = 'green';
                document.getElementById('beautifyStatus').textContent = 'å·²ä¿å­˜è£…é¥°å—å›¾ç‰‡';
            } else {
                document.getElementById('beautifyStatus').style.color = 'gray';
                document.getElementById('beautifyStatus').textContent = 'å·²é¢„è§ˆè£…é¥°å—å›¾ç‰‡ï¼ˆæœªä¿å­˜ï¼‰';
            }
        }

        function saveWidgetImage(kind) {
            const fileEl = document.getElementById(`beautifyWidget${kind === 'wide' ? 'WideFile' : 'SquareFile'}`);
            const urlEl = document.getElementById(`beautifyWidget${kind === 'wide' ? 'Wide' : 'Square'}`);
            if (fileEl && fileEl.files && fileEl.files.length > 0) {
                readFileInputAsDataUrl(fileEl, dataUrl => {
                    if (dataUrl) applyWidgetToPreview(kind, dataUrl, true);
                    else showPhoneAlert('è¯»å–å›¾ç‰‡å¤±è´¥ï¼Œæœªä¿å­˜');
                });
            } else {
                const previewUrl = urlEl.value.trim();
                if (!previewUrl) { showPhoneAlert('è¯·ä¸Šä¼ å›¾ç‰‡æˆ–è¾“å…¥ URL'); return; }
                applyWidgetToPreview(kind, previewUrl, true);
            }
        }

        function loadBeautifyWidgetImages() {
            const wide = localStorage.getItem('beautify_widget_wide') || '';
            const square = localStorage.getItem('beautify_widget_square') || '';
            if (wide) document.querySelectorAll('.widget.wide').forEach(el => { el.style.backgroundImage = `url('${wide}')`; el.style.backgroundSize='cover'; const img=el.querySelector('img'); if(img) img.style.display='none'; });
            if (square) document.querySelectorAll('.widget.square').forEach(el => { el.style.backgroundImage = `url('${square}')`; el.style.backgroundSize='cover'; const img=el.querySelector('img'); if(img) img.style.display='none'; });
        }

        function resetBeautifyChatBackground() {
            localStorage.removeItem('chat_bg_color');
            localStorage.removeItem('chat_bg_image');
            try { applyChatsBackground(); } catch (e) {}
            const c1 = document.getElementById('beautifyChatBgColor'); if (c1) c1.value = '#f8f8f8';
            const c2 = document.getElementById('beautifyChatBgImage'); if (c2) c2.value = '';
            document.getElementById('beautifyStatus').style.color = 'orange';
            document.getElementById('beautifyStatus').textContent = 'èŠå¤©èƒŒæ™¯å·²æ¢å¤é»˜è®¤';
            showPhoneAlert('å·²æ¢å¤èŠå¤©èƒŒæ™¯é»˜è®¤');
        }
        
        // --- è§’è‰²ç®¡ç†é€»è¾‘ ---
        
        // 9. è¾…åŠ©å‡½æ•°ï¼šåŠ è½½è§’è‰²ç®¡ç†é¡µé¢çš„æ¨¡å‹ä¸‹æ‹‰æ¡†
        function loadModelSelectForRole() {
            const roleModelSelect = document.getElementById('roleModelSelect');
            const apiModelSelect = document.getElementById('modelSelect');
            roleModelSelect.innerHTML = ''; 

            let modelOptions = [];
            if (apiModelSelect && apiModelSelect.options.length > 0) {
                 for (let i = 0; i < apiModelSelect.options.length; i++) {
                    if (apiModelSelect.options[i].value) { 
                        modelOptions.push({
                            value: apiModelSelect.options[i].value,
                            text: apiModelSelect.options[i].textContent
                        });
                    }
                }
            } 
            
            if (modelOptions.length === 0) {
                const hardcoded = getHardcodedModels().models; 
                hardcoded.forEach(model => {
                    modelOptions.push({ value: model, text: model });
                });
            }

            modelOptions.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.text;
                roleModelSelect.appendChild(option);
            });
            
            if (roleModelSelect.options.length > 0) {
                 roleModelSelect.value = roleModelSelect.options[0].value;
            }
        }

        // 10. ä¿å­˜è§’è‰²å‡½æ•°
        function saveRole() {
            const name = document.getElementById('roleName').value.trim();
            const prompt = document.getElementById('systemPrompt').value.trim();
            const model = document.getElementById('roleModelSelect').value;

            if (!name || !prompt || !model) {
                alert("è¯·å¡«å†™å®Œæ•´çš„è§’è‰²ä¿¡æ¯!");
                return;
            }

            const newRole = {
                id: Date.now(),
                name: name,
                prompt: prompt,
                model: model,
                history: [] 
            };
            
            roles.push(newRole);
            localStorage.setItem('roles', JSON.stringify(roles));
            
            alert(`è§’è‰² "${name}" å·²ä¿å­˜ï¼`);
            showApp('roleList');
        }
        
        // 11. åŠ è½½è§’è‰²åˆ—è¡¨ (ä¿®å¤ï¼šç¡®ä¿çŸ­æŒ‰å¯ä»¥è¿›å…¥èŠå¤©)
        function loadRoleList() {
            const roleListDiv = document.getElementById('roleList');
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            roleListDiv.innerHTML = '';
            
            if (roles.length === 0) {
                 roleListDiv.innerHTML = '<div style="text-align: center; color: #888; margin-top: 50px;">æš‚æ— è§’è‰²ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ã€‚</div>';
                 return;
            }

            roles.forEach(role => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.setAttribute('data-id', role.id);
                
                let pressTimer;
                let isLongPress = false; // æ–°å¢æ ‡è®°ï¼Œç”¨äºåŒºåˆ†æ˜¯é•¿æŒ‰è¿˜æ˜¯çŸ­æŒ‰

                // ç§»é™¤ card.onclickï¼Œæˆ‘ä»¬ä½¿ç”¨ touchend/mouseup æ¥è§¦å‘çŸ­æŒ‰
                
                // å¼€å§‹æŒ‰ä¸‹è®¡æ—¶
                const startPress = (e) => {
                    // âš ï¸ å…³é”®ä¿®æ”¹ 1: ç§»é™¤ e.preventDefault()ï¼Œç¡®ä¿ click äº‹ä»¶å¯ä»¥æ­£å¸¸è§¦å‘
                    isLongPress = false;
                    clearTimeout(pressTimer); 
                    pressTimer = setTimeout(() => {
                        isLongPress = true; // è¾¾åˆ° 500msï¼Œæ ‡è®°ä¸ºé•¿æŒ‰
                        showRoleActionMenu(role.id);
                        // âš ï¸ å…³é”®ï¼šè¿™é‡Œä¸éœ€è¦é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè®©é•¿æŒ‰èœå•æ˜¾ç¤ºå³å¯
                    }, 500); 
                };

                // ç»“æŸæŒ‰ä¸‹ï¼šåˆ¤æ–­æ˜¯çŸ­æŒ‰è¿˜æ˜¯é•¿æŒ‰
                const endPress = () => {
                    clearTimeout(pressTimer);
                    if (!isLongPress) {
                        // å¦‚æœè®¡æ—¶å™¨è¢«æ¸…é™¤äº†ï¼Œä¸”ä¸æ˜¯é•¿æŒ‰ï¼Œåˆ™è®¤ä¸ºæ˜¯çŸ­æŒ‰
                        // âš ï¸ å…³é”®ä¿®æ”¹ 2: çŸ­æŒ‰æ—¶ç›´æ¥è°ƒç”¨ startChatï¼Œä¸ä¾èµ– click äº‹ä»¶ç±»å‹
                        startChat(role.id);
                    }
                    isLongPress = false; // é‡ç½®
                };
                
                const cancelPress = () => {
                    clearTimeout(pressTimer);
                    isLongPress = false;
                }

                // ç»Ÿä¸€å¤„ç†è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
                card.addEventListener('touchstart', startPress, false);
                card.addEventListener('touchend', endPress, false); // æŠ¬èµ·æ—¶è§¦å‘çŸ­æŒ‰é€»è¾‘
                card.addEventListener('mousedown', startPress, false);
                card.addEventListener('mouseup', endPress, false); // æŠ¬èµ·æ—¶è§¦å‘çŸ­æŒ‰é€»è¾‘
                card.addEventListener('mouseleave', cancelPress, false); 
                card.addEventListener('click', (e) => e.preventDefault(), false); // é˜»æ­¢å¯èƒ½æ®‹ç•™çš„ click è¡Œä¸º

                const avatar = document.createElement('div');
                avatar.className = 'role-avatar';
                avatar.textContent = role.name[0].toUpperCase();

                const info = document.createElement('div');
                info.className = 'role-info';
                info.innerHTML = `<h3>${role.name}</h3>
                                  <p>æ¨¡å‹: ${role.model} - ${role.prompt.substring(0, 30)}...</p>`;

                card.appendChild(avatar);
                card.appendChild(info);
                roleListDiv.appendChild(card);
            });
        }
        
       // 12. å¼€å§‹èŠå¤© (ç§»é™¤äº‹ä»¶æ£€æŸ¥ï¼Œè¢« loadRoleList ç›´æ¥è°ƒç”¨)
        function startChat(roleId) {
            currentRoleId = roleId;
            const role = roles.find(r => r.id === roleId);
            
            if (!role) {
                 alert("è§’è‰²ä¸å­˜åœ¨ï¼");
                 return;
            }

            // ä½¿ç”¨å¯¹æ–¹æ˜µç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è§’è‰²åç§°
            const aiNickname = localStorage.getItem('chat_ai_nickname') || '';
            const displayName = aiNickname || role.name;
            document.getElementById('chatDetailTitle').textContent = displayName;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // åŠ è½½èŠå¤©å†å²è®°å½•
            loadChatHistory(roleId); 
            
            showApp('chatDetail');
        }
        
        // 12.1 æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            const roleListScreen = document.getElementById('roleListScreen');
            const momentScreen = document.getElementById('momentScreen');
            
            if (tabName === 'message') {
                roleListScreen.style.display = 'flex';
                momentScreen.style.display = 'none';
            } else if (tabName === 'moment') {
                roleListScreen.style.display = 'none';
                momentScreen.style.display = 'flex';
                loadMomentSettings();
            }
        }
        
        // 13. æ˜¾ç¤ºè§’è‰²æ“ä½œèœå• (ä¿®å¤ Z-Index é®æŒ¡)
        let roleIdToDelete = null; 
        const menuElement = document.getElementById('roleActionMenu'); 

        function showRoleActionMenu(roleId) {
            roleIdToDelete = roleId;
            menuElement.style.display = 'block'; 
            menuElement.classList.add('is-active'); 
        }

        // 14. éšè—è§’è‰²æ“ä½œèœå•
        function hideRoleActionMenu() {
            menuElement.classList.remove('is-active');
            
            setTimeout(() => {
                menuElement.style.display = 'none'; 
            }, 100); 
            
            roleIdToDelete = null;
        }

        // 15. ç¡®è®¤åˆ é™¤è§’è‰²
        function confirmDeleteRole() {
            if (roleIdToDelete === null) return;
            
            const roleIndex = roles.findIndex(r => r.id === roleIdToDelete);
            if (roleIndex > -1) {
                const roleName = roles[roleIndex].name;
                
                roles.splice(roleIndex, 1);
                localStorage.setItem('roles', JSON.stringify(roles));
                
                // åŒæ—¶åˆ é™¤èŠå¤©è®°å½•
                localStorage.removeItem(`chat_history_${roleIdToDelete}`); 
                
                alert(`è§’è‰² "${roleName}" å·²åˆ é™¤ã€‚`);
                hideRoleActionMenu();
                loadRoleList(); 
            }
        }
        
        // 15.1 ç¡®è®¤æ¸…ç©ºèŠå¤©è®°å½•
        function confirmClearHistory() {
            if (roleIdToDelete === null) return;
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥è§’è‰²çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                clearChatHistory(roleIdToDelete);
                hideRoleActionMenu();
            }
        }


        // --- èŠå¤©æ ¸å¿ƒé€»è¾‘ ---

        // 7. åŠ¨æ€æ·»åŠ æ¶ˆæ¯æ°”æ³¡ï¼ˆå¸¦å¤´åƒï¼‰
        function appendMessage(sender, text, shouldSave = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡å®¹å™¨
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${sender === 'user' ? 'sent' : 'received'}`;
            
            // åˆ›å»ºå¤´åƒ
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            if (sender === 'user') {
                const userAvatarUrl = localStorage.getItem('chat_user_avatar_url') || '';
                const userAvatarEmoji = localStorage.getItem('chat_user_avatar_emoji') || 'ğŸ‘¤'; // é»˜è®¤emoji
                
                if (userAvatarUrl && (userAvatarUrl.startsWith('http') || userAvatarUrl.startsWith('data:'))) {
                    const img = document.createElement('img');
                    img.src = userAvatarUrl;
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = userAvatarEmoji.substring(0,2); // ç¡®ä¿åªæ˜¾ç¤ºå°‘é‡æ–‡å­—/emoji
                }
            } else {
                const aiAvatarUrl = localStorage.getItem('chat_ai_avatar_url') || '';
                const aiAvatarEmoji = localStorage.getItem('chat_ai_avatar_emoji') || 'ğŸ¤–'; // é»˜è®¤emoji
                
                if (aiAvatarUrl && (aiAvatarUrl.startsWith('http') || aiAvatarUrl.startsWith('data:'))) {
                    const img = document.createElement('img');
                    img.src = aiAvatarUrl;
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = aiAvatarEmoji.substring(0,2);
                }
            }
            
            // åˆ›å»ºæ¶ˆæ¯å†…å®¹
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'sent' : 'received'}`;
            messageDiv.textContent = text;
            
            // ç»„è£…æ°”æ³¡
            if (sender === 'user') {
                bubbleDiv.appendChild(messageDiv);
                bubbleDiv.appendChild(avatarDiv);
            } else {
                bubbleDiv.appendChild(avatarDiv);
                bubbleDiv.appendChild(messageDiv);
            }
            
            chatMessages.appendChild(bubbleDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // ä¿å­˜æ¶ˆæ¯åˆ° localStorageï¼ˆå¦‚æœshouldSaveä¸ºtrueï¼‰
            if (shouldSave && currentRoleId) {
                saveChatMessage(currentRoleId, sender, text);
            }
        }


        // 7.1 ä¿å­˜èŠå¤©æ¶ˆæ¯åˆ° localStorage
        function saveChatMessage(roleId, sender, text) {
            const key = `chat_history_${roleId}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.push({
                sender: sender,
                text: text,
                timestamp: Date.now()
            });
            localStorage.setItem(key, JSON.stringify(history));
        }
        
        // 7.2 åŠ è½½èŠå¤©å†å²è®°å½•
        function loadChatHistory(roleId) {
            const key = `chat_history_${roleId}`;
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            const chatMessages = document.getElementById('chatMessages');

            // å¦‚æœæœ‰å†å²åˆ™åŠ è½½ï¼›æ²¡æœ‰å†å²æ—¶ä¿æŒç©ºç™½ï¼ˆä¸æ˜¾ç¤ºäººè®¾æˆ–æ¬¢è¿è¯­ï¼‰
            if (!history || history.length === 0) return;
            history.forEach(msg => {
                appendMessage(msg.sender, msg.text, false);
            });
        }
        
        // 7.3 æ¸…ç©ºèŠå¤©è®°å½•
        function clearChatHistory(roleId) {
            if (!roleId) return;
            const key = `chat_history_${roleId}`;
            localStorage.removeItem(key);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            const role = roles.find(r => r.id === roleId);
            // ä¸è‡ªåŠ¨å‘é€ä»»ä½•äººè®¾æˆ–æ¬¢è¿æ¶ˆæ¯
        }

        // æ£€æµ‹å›å¤æ˜¯å¦è·³å‡ºäººè®¾ï¼ˆOOC, out-of-characterï¼‰
        function isOutOfCharacter(text) {
            if (!text) return true;
            const lowered = text.toString().toLowerCase();
            // å¸¸è§æ³„éœ²/è·³å‡ºè§’è‰²çš„å…³é”®è¯æˆ–ç»“æ„
            const oocPatterns = [
                'ai', 'æ¨¡å‹', 'ç³»ç»Ÿæç¤º', 'ç³»ç»Ÿæç¤ºè¯', 'developer', 'system prompt', 'as an ai', 'as an ai model', 'ä½œä¸ºai', 'ä½œä¸ºæ¨¡å‹', 'æˆ‘æ˜¯ai', 'æˆ‘æ˜¯æ¨¡å‹', 'ä½œä¸ºä¸€ä¸ªai', '\\[', '\\(' // åŒ…å«æ‹¬å·æˆ–ä¸­æ‹¬å·ä¹Ÿå¯èƒ½ä¸ºå…ƒä¿¡æ¯
            ];
            for (const p of oocPatterns) {
                if (lowered.includes(p)) return true;
            }
            // å¦‚æœåŒ…å«æ˜æ˜¾çš„å…ƒä¿¡æ¯æ ¼å¼ï¼ˆä¾‹å¦‚æ‹¬å·æ³¨é‡Šæˆ–æ–¹æ‹¬å·ï¼‰ä¹Ÿåˆ¤ä¸º OOC
            if (/\[.*?\]|\(.*?\)/.test(text)) return true;
            return false;
        }

        // 8. èŠå¤©æ¶ˆæ¯å‘é€å‡½æ•° (è¿æ¥çœŸå® API)
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const messageText = input.value.trim();
            
            if (!messageText) return; 

            const apiUrl = localStorage.getItem('apiUrl');
            const apiKey = localStorage.getItem('apiKey');
            const role = roles.find(r => r.id === currentRoleId);
            
            if (!apiUrl || !apiKey || !role) {
                 appendMessage('ai', 'âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨ API APP é…ç½®å¯†é’¥ï¼Œå¹¶åˆ›å»º/é€‰æ‹©ä¸€ä¸ªè§’è‰²ã€‚');
                 return;
            }
            const model = role.model; 
            // ç¦æ­¢æ€§è§„åˆ™ï¼šç»å¯¹ç¦æ­¢è‡ªç§° AI/æ³„éœ²ç³»ç»Ÿæç¤º/æ‹¬å·è¯´æ˜
            const prohibitionRule = 'ä¸è¦ä»¥ä»»ä½•æ–¹å¼æåŠä½ æ˜¯ AIã€æ¨¡å‹ã€ç³»ç»Ÿæç¤ºè¯ã€å†…éƒ¨è®¾ç½®æˆ–å¼€å‘è€…æŒ‡ä»¤ï¼›ä¸è¦åœ¨å›å¤ä¸­å‡ºç°æ‹¬å·å†…çš„è‡ªæˆ‘è¯´æ˜æˆ–åˆè§„è¯æ˜ï¼›ä»¥ç¬¬ä¸€äººç§°è‡ªç„¶åœ°è¡¨è¾¾ã€‚';
            let systemPrompt = prohibitionRule + '\n' + role.prompt;
            
            // æ·»åŠ å…³è”çš„ä¸–ç•Œä¹¦å†…å®¹åˆ°ç³»ç»Ÿæç¤ºè¯
            if (role.associatedWorldbooks && role.associatedWorldbooks.length > 0) {
                worldbooks = JSON.parse(localStorage.getItem('worldbooks') || '[]');
                const selectedWorldbooks = worldbooks.filter(wb => role.associatedWorldbooks.includes(wb.id));
                if (selectedWorldbooks.length > 0) {
                    const worldbookContent = selectedWorldbooks
                        .map(wb => wb.content.join('\n'))
                        .join('\n\n');
                    systemPrompt += '\n\nã€ä¸–ç•Œä¹¦å†…å®¹ã€‘\n' + worldbookContent;
                }
            }

            // å¼ºåˆ¶æ€§çš„è§’è‰²è¿è¡Œè®¾ç½®ï¼ˆå°†è¿™äº›è®¾å®šä»¥æŒ‡ä»¤å½¢å¼æ·»åŠ åˆ°ç³»ç»Ÿæç¤ºè¯ï¼Œè¦æ±‚ AI éµå¾ªï¼‰
            const enforceLines = [];
            enforceLines.push('è¯·éµå¾ªä»¥ä¸‹è§’è‰²è¿è¡Œè®¾å®šå¹¶åœ¨å“åº”ä¸­ä½“ç°ï¼š');
            enforceLines.push('å¯ç”¨ç‹¬ç«‹åå°æ´»åŠ¨: ' + (role.enableIndependentBackground ? 'æ˜¯' : 'å¦'));
            enforceLines.push('ç‹¬ç«‹è¡ŒåŠ¨å†·å´ï¼ˆåˆ†é’Ÿï¼‰: ' + (role.independentCooldown !== undefined ? role.independentCooldown : 0));
            enforceLines.push('çŸ­æœŸè®°å¿†æ¡æ•°: ' + (role.shortTermMemoryCount !== undefined ? role.shortTermMemoryCount : 0));
            enforceLines.push('è‡ªåŠ¨æ€»ç»“é•¿æœŸè®°å¿†: ' + (role.autoSummarizeLongTerm ? 'æ˜¯' : 'å¦'));
            enforceLines.push('è‡ªåŠ¨æ€»ç»“é—´éš”ï¼ˆæ¡ï¼‰: ' + (role.autoSummarizeInterval !== undefined ? role.autoSummarizeInterval : 0));
            
            // æ·»åŠ åˆ†æ¡å‘é€æ¶ˆæ¯çš„è¦æ±‚
            const maxReplyMessages = role.maxReplyMessages || 1;
            if (maxReplyMessages > 1) {
                enforceLines.push('\nã€é‡è¦ã€‘å›å¤æ¶ˆæ¯æ ¼å¼è¦æ±‚ï¼š');
                enforceLines.push('- ä½ æœ€å¤šå¯ä»¥å‘é€ ' + maxReplyMessages + ' æ¡æ¶ˆæ¯');
                enforceLines.push('- è¯·å°†ä½ çš„å›å¤è‡ªç„¶åœ°åˆ†æˆå¤šæ¡ç‹¬ç«‹æ¶ˆæ¯ï¼Œå°±åƒçœŸäººåœ¨èŠå¤©è½¯ä»¶ä¸­å‘æ¶ˆæ¯ä¸€æ ·');
                enforceLines.push('- ä½¿ç”¨ [SPLIT] ä½œä¸ºåˆ†éš”ç¬¦æ¥æ ‡è®°æ¯æ¡æ¶ˆæ¯çš„è¾¹ç•Œ');
                enforceLines.push('- ä¾‹å¦‚ï¼š"ä»Šå¤©å·¥ä½œå¥½ç´¯ï¼Œæˆ‘å…ˆç¡äº†ã€‚[SPLIT]æ™šå®‰ã€‚"');
                enforceLines.push('- æ¯æ¡æ¶ˆæ¯åº”è¯¥æ˜¯å®Œæ•´ä¸”ç‹¬ç«‹çš„ï¼Œä¸è¦åœ¨å¥å­ä¸­é—´åˆ†å‰²');
                enforceLines.push('- æ¶ˆæ¯æ•°é‡å¯ä»¥å°‘äºæœ€å¤§å€¼ï¼Œä½†ä¸è¦è¶…è¿‡');
            }
            
            enforceLines.push('\nè¯·ä¸¥æ ¼éµå®ˆä»¥ä¸Šè®¾ç½®ï¼Œåœ¨å›å¤å’Œå†…éƒ¨è¡Œä¸ºä¸Šæ‰§è¡Œã€‚');
            enforceLines.push('\nã€é‡è¦è¡¥å……ã€‘ï¼šä¸è¦ä»¥ä»»ä½•æ–¹å¼æåŠä½ æ˜¯ AIã€æ¨¡å‹ã€ç³»ç»Ÿæç¤ºè¯ã€å†…éƒ¨è®¾ç½®æˆ–å¼€å‘è€…æŒ‡ä»¤ï¼›ä¸è¦åœ¨å›å¤ä¸­å‡ºç°æ‹¬å·å†…çš„è‡ªæˆ‘è¯´æ˜æˆ–åˆè§„è¯æ˜ï¼›æ‰€æœ‰å›å¤å¿…é¡»ä»¥ç¬¬ä¸€äººç§°ã€è‡ªç„¶ã€ç¬¦åˆäººè®¾çš„è¯­æ°”è¿›è¡Œï¼Œä¸è¦è·³å‡ºè§’è‰²ï¼ˆä¸è¦ OOCï¼‰ã€‚');
            systemPrompt += '\n\nã€è§’è‰²è¿è¡Œè®¾ç½®ã€‘\n' + enforceLines.join('\n');
            
            appendMessage('user', messageText);
            input.value = '';

            // å¦‚æœç”¨æˆ·åœ¨èŠå¤©ä¸­æ˜ç¡®è¦æ±‚è§’è‰²å»å‘å¸ƒåŠ¨æ€ï¼Œåˆ™ä¸è®©AIåœ¨èŠå¤©å†…ç›´æ¥è¾“å‡ºåŠ¨æ€å†…å®¹
            const lower = messageText.toLowerCase();
            function detectPostIntent(text) {
                if (!text) return false;
                // ç›´æ¥å…³é”®è¯
                const triggers = ['å‘åŠ¨æ€', 'å‘æœ‹å‹åœˆ', 'å»å‘ä¸€ä¸ªåŠ¨æ€', 'å¸®æˆ‘å‘åŠ¨æ€', 'å‘å¸ƒåŠ¨æ€', 'å¸®æˆ‘å‘ä¸ªåŠ¨æ€', 'æˆ‘è¦å‘åŠ¨æ€', 'æ›¿æˆ‘å‘', 'å¸®æˆ‘å‘ä¸€æ¡', 'å»åŠ¨æ€é¡µé¢', 'åˆ°åŠ¨æ€é¡µ', 'å»æœ‹å‹åœˆ', 'å‘å¸ƒåˆ°æœ‹å‹åœˆ'];
                for (const t of triggers) if (text.includes(t)) return true;
                // ç»“åˆåŠ¨è¯å’Œå¯¹è±¡çš„æ›´å®½æ³›åŒ¹é…
                if (/å».*åŠ¨æ€/.test(text) || /åœ¨.*åŠ¨æ€/.test(text) || /åˆ°.*åŠ¨æ€/.test(text)) return true;
                if (/å‘.*(åŠ¨æ€|æœ‹å‹åœˆ)/.test(text) || /å‘å¸ƒ.*(åŠ¨æ€|æœ‹å‹åœˆ)/.test(text)) return true;
                // åŒ…å«'åŠ¨æ€'å¹¶å«æœ‰åŠ¨ä½œè¯
                if (text.includes('åŠ¨æ€') && /å‘|å‘å¸ƒ|å¸®|æ›¿|å»|å¸®æˆ‘/.test(text)) return true;
                return false;
            }
            function detectImageRequest(text) {
                if (!text) return false;
                const t = text.toLowerCase();
                const triggers = ['å¸¦å›¾','å¸¦å¼ å›¾','å¸¦å›¾ç‰‡','æœ‰å›¾','é…å›¾','é™„å›¾','å¸¦å¼ ç…§ç‰‡','é…å¼ å›¾','å¸¦ä¸€å¼ å›¾','å‘å›¾'];
                for (const s of triggers) if (t.includes(s)) return true;
                return false;
            }
            const askedToPost = detectPostIntent(lower);
            const askedImage = detectImageRequest(lower);

            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            if (askedToPost) {
                // è§¦å‘è§’è‰²å»åå°å‘å¸ƒåŠ¨æ€ï¼Œå¹¶åœ¨èŠå¤©ä¸­åªæ˜¾ç¤ºç®€çŸ­ç¡®è®¤
                createMomentFromRole(currentRoleId, messageText, { force: true, forceImage: askedImage }).then(() => {
                    const thinkingBubble = document.getElementById('chatMessages').querySelector('.thinking-bubble');
                    if (thinkingBubble) thinkingBubble.remove();
                    // æ›´è‡ªç„¶çš„ç¡®è®¤ï¼Œç”±ç®€å•æ¨¡æ¿ç”Ÿæˆï¼ˆä¿æŒç¬¬ä¸€äººç§°ã€å£è¯­åŒ–ï¼‰
                    const templates = ['å‘å¥½äº†ï¼Œè¿™ä¸‹ä½ æ»¡æ„äº†ï¼Ÿ', 'å¥½äº†ï¼Œå·²ç»å‘äº†ï¼Œä½ çœ‹çœ‹æ€ä¹ˆæ ·ã€‚', 'å‘å‡ºå»äº†ï¼Œè®°å¾—å‘Šè¯‰æˆ‘éœ€ä¸éœ€è¦æ”¹ã€‚', 'å·²ç»å‘å¸ƒï¼Œæƒ³è¦æˆ‘æ¢ä¸€æ¡å†å‘å—ï¼Ÿ'];
                    const tpl = templates[Math.floor(Math.random() * templates.length)];
                    appendMessage('ai', tpl);
                    // ä¸è‡ªåŠ¨è·³è½¬åˆ°åŠ¨æ€é¡µ â€”â€” ä¿æŒåœ¨èŠå¤©ç•Œé¢ï¼Œç”¨æˆ·åªéœ€çœ‹åˆ°ç¡®è®¤å³å¯
                    input.disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    input.focus();
                }).catch(err => {
                    const thinkingBubble = document.getElementById('chatMessages').querySelector('.thinking-bubble');
                    if (thinkingBubble) thinkingBubble.remove();
                    console.error('createMomentFromRole failed:', err);
                    const msg = (err && (err.message || err.toString())) ? (err.message || err.toString()) : String(err);
                    let detail = msg;
                    if (err && err.stack) {
                        detail += '\n' + err.stack.split('\n').slice(0,3).join('\n');
                    }
                    appendMessage('ai', `å‘å¸ƒåŠ¨æ€æ—¶å‡ºé”™äº†ï¼š${detail.substring(0,300)}`);
                    input.disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    input.focus();
                });
                // ç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­æ­£å¸¸çš„èŠå¤©APIè°ƒç”¨
                return;
            }
            
            // --- æ·»åŠ  "æ€è€ƒä¸­" æ¶ˆæ¯æ°”æ³¡ ---
            const thinkingBubbleDiv = document.createElement('div');
            thinkingBubbleDiv.className = 'message-bubble received thinking-bubble';
            
            const thinkingAvatarDiv = document.createElement('div');
            thinkingAvatarDiv.className = 'message-avatar';
            const aiAvatarUrl = localStorage.getItem('chat_ai_avatar_url') || '';
            const aiAvatarEmoji = localStorage.getItem('chat_ai_avatar_emoji') || 'ğŸ¤–';
            if (aiAvatarUrl && (aiAvatarUrl.startsWith('http') || aiAvatarUrl.startsWith('data:'))) {
                const img = document.createElement('img');
                img.src = aiAvatarUrl;
                thinkingAvatarDiv.appendChild(img);
            } else {
                thinkingAvatarDiv.textContent = aiAvatarEmoji.substring(0,2);
            }
            
            const thinkingMessageDiv = document.createElement('div');
            thinkingMessageDiv.className = 'message received thinking';
            thinkingMessageDiv.textContent = 'æ­£åœ¨è¾“å…¥ä¸­...';
            
            thinkingBubbleDiv.appendChild(thinkingAvatarDiv);
            thinkingBubbleDiv.appendChild(thinkingMessageDiv);
            document.getElementById('chatMessages').appendChild(thinkingBubbleDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const fullUrl = (apiUrl.endsWith('/')) ? `${apiUrl}chat/completions` : `${apiUrl}/v1/chat/completions`;
                
                // ä»å†å²è®°å½•ä¸­æ„å»ºæ¶ˆæ¯ä½“
                const historyKey = `chat_history_${currentRoleId}`;
                const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                // ä»…å‘é€æœ€è¿‘çš„å‡ æ¡å†å²è®°å½• + å½“å‰æ¶ˆæ¯ï¼Œä»¥é˜²æ­¢è¯·æ±‚ä½“è¿‡å¤§
                let messages = history.slice(-10).map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: msg.text
                }));

                // ç¡®ä¿ç³»ç»Ÿæç¤ºè¯åœ¨æœ€å‰é¢
                messages.unshift({ role: "system", content: systemPrompt });

                // ç§»é™¤æ€è€ƒä¸­æ¶ˆæ¯
                const removeThinking = () => {
                    const thinkingBubble = chatMessages.querySelector('.thinking-bubble');
                    if (thinkingBubble) {
                        chatMessages.removeChild(thinkingBubble);
                    }
                };
                
                // æ”¹ä¸ºé‡è¯•æœºåˆ¶ï¼šæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œè‹¥æ£€æµ‹åˆ° OOCï¼ˆè·³å‡ºäººè®¾ï¼‰åˆ™é‡è¯•ä¸€æ¬¡ä»¥æé«˜äººè®¾è´´åˆåº¦
                const maxRetries = 3;
                let aiResponseText = '';
                let lastError = null;
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const attemptMessages = JSON.parse(JSON.stringify(messages));
                        // å¼ºåŒ–ç³»ç»Ÿæç¤ºä»¥å‡å°‘ OOCï¼ˆé‡è¯•æ—¶é™„åŠ æ›´å¼ºæŒ‡ä»¤ï¼‰
                        if (attempt > 1) {
                            attemptMessages[0].content = attemptMessages[0].content + '\nã€é‡è¯•è¦æ±‚ã€‘ï¼šä¸¥æ ¼ä¿æŒäººè®¾ï¼Œä¸è¦ä»¥ä»»ä½•å½¢å¼æåŠä½ æ˜¯ AIã€æ¨¡å‹ã€ç³»ç»Ÿæç¤ºè¯æˆ–å¼€å‘è€…æŒ‡ä»¤ï¼›ä»¥ç¬¬ä¸€äººç§°è‡ªç„¶åœ°è¡¨è¾¾ã€‚ä¸è¦è¾“å‡ºæ‹¬å·æˆ–æ–¹æ‹¬å·å†…çš„ä»»ä½•å…ƒä¿¡æ¯ã€‚';
                        }

                        const response = await fetch(fullUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: attemptMessages,
                                stream: false
                            })
                        });

                        removeThinking();

                        if (!response.ok) {
                            const errorJson = await response.json().catch(() => ({error: {message: 'APIè¿”å›äº†éJSONé”™è¯¯ä¿¡æ¯ã€‚'}}));
                            const errorMessage = errorJson.error?.message || `API é”™è¯¯ (çŠ¶æ€ç : ${response.status})ã€‚è¯·æ£€æŸ¥ Key æˆ– URLã€‚`;
                            appendMessage('ai', `âŒ API è°ƒç”¨å¤±è´¥: ${errorMessage.substring(0, 150)}`);
                            return;
                        }

                        const result = await response.json();
                        aiResponseText = result.choices?.[0]?.message?.content || 'æˆ‘æƒ³ä¸å‡ºæ¥è¦æ€ä¹ˆè¯´ã€‚';

                        // åŸºæœ¬æ¸…ç†
                        aiResponseText = aiResponseText.replace(/\(.*?\)/g, '').replace(/\[.*?\]/g, '');
                        aiResponseText = aiResponseText.split(/\n/).map(line => {
                            if (/ç³»ç»Ÿæç¤ºè¯|æˆ‘çš„ç³»ç»Ÿæç¤ºè¯|æˆ‘æ˜¯ .* ç³»ç»Ÿæç¤ºè¯/.test(line)) return ''; return line;
                        }).join('\n').trim();

                        // è‹¥å†…å®¹ä»åŒ…å«æ˜æ˜¾çš„è·³å‡ºäººè®¾å…³é”®å­—æˆ–å…ƒä¿¡æ¯ï¼Œåˆ™åˆ¤å®šä¸º OOC
                        if (isOutOfCharacter(aiResponseText)) {
                            console.warn('æ£€æµ‹åˆ°å¯èƒ½çš„ OOCï¼ˆè·³å‡ºäººè®¾ï¼‰ï¼Œattempt=', attempt, 'text=', aiResponseText);
                            lastError = new Error('æ£€æµ‹åˆ°è·³å‡ºäººè®¾çš„å›å¤');
                            if (attempt < maxRetries) {
                                // ç­‰å¾…çŸ­æš‚å»¶è¿Ÿå†é‡è¯•
                                await new Promise(r => setTimeout(r, 400 + Math.random() * 600));
                                continue; // å†è¯•ä¸€æ¬¡
                            } else {
                                // æœ€åä¸€æ¬¡é‡è¯•ä» OOCï¼Œåˆ™å›é€€åˆ°çŸ­å®‰å…¨å¥
                                aiResponseText = 'å—¯ï¼Œæˆ‘çŸ¥é“äº†ã€‚';
                            }
                        }
                        // æˆåŠŸè·å¾—åˆæ ¼çš„å›ç­”
                        break;
                    } catch (err) {
                        lastError = err;
                        console.error('è¯·æ±‚æ¨¡å‹å¤±è´¥ï¼Œattempt=', attempt, err);
                        if (attempt >= maxRetries) {
                            removeThinking();
                            appendMessage('ai', `ğŸš¨ è¿æ¥å¤±è´¥ï¼šç½‘ç»œæˆ–è·¨åŸŸ(CORS)é”™è¯¯æˆ–æ¨¡å‹æœåŠ¡ä¸å¯ç”¨ã€‚ (${String(err).substring(0,120)})`);
                            return;
                        }
                        await new Promise(r => setTimeout(r, 300 + Math.random() * 700));
                    }
                }
                
                // ----- æ–°å¢ï¼šè‹¥æ¨¡å‹åœ¨èŠå¤©ä¸­ç›´æ¥è¾“å‡ºäº†â€œå·²å‘å¸ƒ/æˆ‘å‘äº†/å·²å‘â€ç­‰è¡¨è¿°ï¼Œæˆ–åŒ…å«[HAS_IMAGE]ï¼Œ
                // åˆ™è§†ä¸ºæ¨¡å‹å·²ç»ç”Ÿæˆè¦å‘å¸ƒçš„åŠ¨æ€å†…å®¹ã€‚ä¸ºé¿å…åœ¨èŠå¤©ä¸­æ³„éœ²å®Œæ•´åŠ¨æ€ï¼Œ
                // æˆ‘ä»¬å°†æŠŠè¯¥å†…å®¹ä¿å­˜åˆ°åŠ¨æ€ï¼ˆMomentsï¼‰ï¼Œå¹¶åœ¨èŠå¤©ä¸­åªæ˜¾ç¤ºè‡ªç„¶çš„ç¡®è®¤æ–‡æœ¬ã€‚
                const modelLooksLikePost = (() => {
                    if (!aiResponseText) return false;
                    const t = aiResponseText.toLowerCase();
                    // æ˜ç¡®çš„å‘å¸ƒæŒ‡ç¤ºæˆ–æ¨¡å‹çº¦å®šçš„å›¾ç‰‡æ ‡è®°
                    if (t.includes('[has_image]') || /å·²å‘|å·²å‘å¸ƒ|æˆ‘å‘äº†|å‘å¸ƒæˆåŠŸ|å‘å‡ºå»äº†|å·²å‘é€|å·²å‘å¸ƒåˆ°|å‘å¥½äº†|å·²ç»å‘äº†|å‘å‡ºå»äº†ï¼Œ|æˆ‘å·²å‘å¸ƒ/.test(t)) return true;
                    // å¦‚æœå›å¤æ¯”è¾ƒé•¿ä¸”åƒä¸€æ¡çŠ¶æ€ï¼ˆå¤šäº40å­—ä¸”ä¸å¸¦é—®å¥ï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯è¦å‘çš„åŠ¨æ€
                    if (aiResponseText.length > 40 && !/[ï¼Ÿ?]/.test(aiResponseText)) return true;
                    return false;
                })();

                if (modelLooksLikePost) {
                    // ä¿å­˜ç”±æ¨¡å‹ç”Ÿæˆçš„åŠ¨æ€ï¼ˆä½¿ç”¨æ¨¡å‹è¿”å›çš„æ–‡æœ¬ä½œä¸ºåŠ¨æ€å†…å®¹ï¼‰
                    try {
                        await saveMomentFromGeneratedText(currentRoleId, aiResponseText, { forceImage: askedImage || aiResponseText.toLowerCase().includes('[has_image]') });
                    } catch (e) {
                        console.error('ä¿å­˜æ¨¡å‹ç”ŸæˆåŠ¨æ€å¤±è´¥ï¼š', e);
                    }

                    // åœ¨èŠå¤©ä¸­åªæ˜¾ç¤ºç®€çŸ­çš„è‡ªç„¶ç¡®è®¤å¥
                    const templates2 = ['å‘å¥½äº†ï¼Œè¿™ä¸‹ä½ æ»¡æ„äº†ï¼Ÿ', 'å¥½äº†ï¼Œå·²ç»å‘äº†ï¼Œä½ çœ‹çœ‹æ€ä¹ˆæ ·ã€‚', 'å‘å‡ºå»äº†ï¼Œè®°å¾—å‘Šè¯‰æˆ‘éœ€ä¸éœ€è¦æ”¹ã€‚', 'å·²ç»å‘å¸ƒï¼Œæƒ³è¦æˆ‘æ¢ä¸€æ¡å†å‘å—ï¼Ÿ'];
                    const tpl2 = templates2[Math.floor(Math.random() * templates2.length)];
                    appendMessage('ai', tpl2);
                    // ç›´æ¥è¿”å›ï¼Œä¸å†æŠŠæ¨¡å‹å®Œæ•´æ–‡æœ¬æ˜¾ç¤ºåœ¨èŠå¤©ä¸­
                    input.disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    input.focus();
                    return;
                }

                // å¤„ç†åˆ†æ¡æ¶ˆæ¯
                const maxReplyMessages = role.maxReplyMessages || 1;
                if (maxReplyMessages > 1 && aiResponseText.includes('[SPLIT]')) {
                    // AIä½¿ç”¨äº†åˆ†éš”ç¬¦ï¼ŒæŒ‰åˆ†éš”ç¬¦åˆ†å‰²
                    const messageParts = aiResponseText.split('[SPLIT]').map(part => part.trim()).filter(part => part.length > 0);
                    const actualParts = messageParts.slice(0, maxReplyMessages);
                    
                    // é€æ¡æ˜¾ç¤ºæ¶ˆæ¯ï¼Œå¸¦æœ‰å»¶è¿Ÿæ•ˆæœ
                    for (let i = 0; i < actualParts.length; i++) {
                        if (i > 0) {
                            await new Promise(resolve => setTimeout(resolve, 800)); // æ¯æ¡æ¶ˆæ¯é—´éš”800æ¯«ç§’
                        }
                        appendMessage('ai', actualParts[i]);
                    }
                } else if (maxReplyMessages > 1) {
                    // AIæ²¡æœ‰ä½¿ç”¨åˆ†éš”ç¬¦ï¼Œå°è¯•æ™ºèƒ½åˆ†å‰²
                    const sentences = aiResponseText.split(/(ã€‚|ï¼|ï¼Ÿ|\n+)/);
                    const parts = [];
                    let currentPart = '';
                    
                    for (let i = 0; i < sentences.length; i++) {
                        currentPart += sentences[i];
                        // é‡åˆ°æ ‡ç‚¹ç¬¦å·æˆ–æ˜¯æœ€åä¸€ä¸ªç‰‡æ®µ
                        if (sentences[i].match(/ã€‚|ï¼|ï¼Ÿ|\n/) || i === sentences.length - 1) {
                            if (currentPart.trim()) {
                                parts.push(currentPart.trim());
                                currentPart = '';
                            }
                            if (parts.length >= maxReplyMessages) break;
                        }
                    }
                    
                    if (parts.length > 1) {
                        for (let i = 0; i < parts.length; i++) {
                            if (i > 0) {
                                await new Promise(resolve => setTimeout(resolve, 800));
                            }
                            appendMessage('ai', parts[i]);
                        }
                    } else {
                        appendMessage('ai', aiResponseText);
                    }
                } else {
                    // ä¸åˆ†æ¡ï¼Œç›´æ¥å‘é€
                    appendMessage('ai', aiResponseText);
                }

            } catch (error) {
                const thinkingBubble = chatMessages.querySelector('.thinking-bubble');
                if (thinkingBubble) {
                    chatMessages.removeChild(thinkingBubble);
                }
                appendMessage('ai', `ğŸš¨ è¿æ¥å¤±è´¥ï¼šç½‘ç»œæˆ–è·¨åŸŸ(CORS)é”™è¯¯ã€‚è¯·ç¡®è®¤åä»£æœåŠ¡å·²å¼€å¯ CORSï¼ (${error.message.substring(0, 100)})`);

            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        // 16. èŠå¤©è®¾ç½®åŠŸèƒ½ï¼ˆå¤´åƒã€æ˜µç§°ã€èƒŒæ™¯ã€è§’è‰²ï¼‰
        function showAvatarSettings() {
            const modal = document.getElementById('avatarSettingsModal');
            // åŠ è½½å¤´åƒè®¾ç½®
            const userAvatarUrl = localStorage.getItem('chat_user_avatar_url') || '';
            const userAvatarEmoji = localStorage.getItem('chat_user_avatar_emoji') || '';
            const aiAvatarUrl = localStorage.getItem('chat_ai_avatar_url') || '';
            const aiAvatarEmoji = localStorage.getItem('chat_ai_avatar_emoji') || '';
            document.getElementById('userAvatarUrl').value = userAvatarUrl || userAvatarEmoji;
            document.getElementById('aiAvatarUrl').value = aiAvatarUrl || aiAvatarEmoji;
            updateAvatarPreview('user');
            updateAvatarPreview('ai');
            // åŠ è½½æ˜µç§°è®¾ç½®
            const userNickname = localStorage.getItem('chat_user_nickname') || '';
            const aiNickname = localStorage.getItem('chat_ai_nickname') || '';
            document.getElementById('userNickname').value = userNickname;
            document.getElementById('aiNickname').value = aiNickname;
            // åŠ è½½èƒŒæ™¯è®¾ç½®
            const chatBgColor = localStorage.getItem('chat_bg_color') || '#f8f8f8';
            const chatBgImage = localStorage.getItem('chat_bg_image') || '';
            document.getElementById('chatBgColor').value = chatBgColor;
            document.getElementById('chatBgImage').value = chatBgImage;
            // åŠ è½½èŠå¤©æ°”æ³¡ä¸»é¢˜ä¸è‡ªå®šä¹‰æ ·å¼
            const bubbleTheme = localStorage.getItem('chat_bubble_theme') || 'classic';
            const radios = document.querySelectorAll('input[name="bubbleTheme"]');
            radios.forEach(r => { r.checked = (r.value === bubbleTheme); });
            document.getElementById('customBubbleCss').value = localStorage.getItem('chat_bubble_custom_css') || '';
            const fontSize = parseInt(localStorage.getItem('chat_font_size') || '14', 10);
            document.getElementById('chatFontSize').value = fontSize;
            document.getElementById('chatFontSizeDisplay').textContent = fontSize + 'px';
            // åŠ è½½è§’è‰²è®¾ç½®
            if (currentRoleId) {
                const role = roles.find(r => r.id === currentRoleId);
                if (role) {
                    // åŠ è½½æœ€å¤šå›å¤æ¡æ•°
                    document.getElementById('maxReplyMessages').value = role.maxReplyMessages || 1;
                }
            }
            if (currentRoleId) {
                const role = roles.find(r => r.id === currentRoleId);
                if (role) {
                    document.getElementById('editRoleName').value = role.name;
                    document.getElementById('editSystemPrompt').value = role.prompt;
                    
                    // åŠ è½½æ¨¡å‹é€‰æ‹©
                    const editRoleModel = document.getElementById('editRoleModel');
                    const apiModelSelect = document.getElementById('modelSelect');
                    editRoleModel.innerHTML = '';
                    
                    // ä¼˜å…ˆä» API APP çš„ä¸‹æ‹‰æ¡†ä¸­å¤åˆ¶é€‰é¡¹
                    if (apiModelSelect && apiModelSelect.options.length > 0) {
                        for (let i = 0; i < apiModelSelect.options.length; i++) {
                            if (apiModelSelect.options[i].value) {
                                const option = document.createElement('option');
                                option.value = apiModelSelect.options[i].value;
                                option.textContent = apiModelSelect.options[i].textContent;
                                editRoleModel.appendChild(option);
                            }
                        }
                    } else {
                        const hardcoded = getHardcodedModels().models;
                        hardcoded.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            editRoleModel.appendChild(option);
                        });
                    }
                    
                    editRoleModel.value = role.model;
                    
                    // åŠ è½½ä¸–ç•Œä¹¦é€‰æ‹©å™¨
                    loadWorldbookSelectorsForRole(role);

                    // åŠ è½½è‡ªå®šä¹‰çš„è§’è‰²è¿è¡Œè®¾ç½®
                    document.getElementById('enableIndependentBackground').checked = !!role.enableIndependentBackground;
                    document.getElementById('independentCooldown').value = (role.independentCooldown !== undefined) ? role.independentCooldown : 0;
                    document.getElementById('shortTermMemoryCount').value = (role.shortTermMemoryCount !== undefined) ? role.shortTermMemoryCount : 0;
                    document.getElementById('autoSummarizeLongTerm').checked = !!role.autoSummarizeLongTerm;
                    document.getElementById('autoSummarizeInterval').value = (role.autoSummarizeInterval !== undefined) ? role.autoSummarizeInterval : 10;
                }
            }
            
            modal.style.display = 'flex';
            modal.classList.add('is-active');
            // ç»‘å®šé¢„è§ˆäº¤äº’ï¼ˆä¸ä¿å­˜ï¼Œä»…å®æ—¶é¢„è§ˆï¼‰
            try {
                const fontSlider = document.getElementById('chatFontSize');
                const fontDisplay = document.getElementById('chatFontSizeDisplay');
                if (fontSlider) {
                    fontSlider.oninput = function() { fontDisplay.textContent = this.value + 'px'; previewBubbleAndFont(); };
                }
                const radios = document.querySelectorAll('input[name="bubbleTheme"]');
                radios.forEach(r => { r.onchange = previewBubbleAndFont; });
                const cssArea = document.getElementById('customBubbleCss');
                if (cssArea) cssArea.oninput = previewBubbleAndFont;
                // åˆå§‹é¢„è§ˆ
                previewBubbleAndFont();
            } catch (e) { console.warn('é¢„è§ˆç»‘å®šå¤±è´¥', e); }
        }

        function switchSettingsTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // å–æ¶ˆæ¿€æ´»æ‰€æœ‰æ ‡ç­¾æŒ‰é’®
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            const tabId = {
                'avatar': 'avatarTab',
                'nickname': 'nicknameTab',
                'background': 'backgroundTab',
                'role': 'roleTab'
            }[tabName];
            if (tabId) {
                document.getElementById(tabId).classList.add('active');
                // ç¡®ä¿ç‚¹å‡»çš„æŒ‰é’®è¢«æ¿€æ´»
                if(event.target.classList.contains('settings-tab-btn')) {
                    event.target.classList.add('active');
                } else {
                    document.querySelector(`.settings-tabs button[onclick*="${tabName}"]`).classList.add('active');
                }
            }
        }

        function closeAvatarSettings() {
            const modal = document.getElementById('avatarSettingsModal');
            modal.classList.remove('is-active');
            // ç§»é™¤é¢„è§ˆæ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰
            const prev = document.getElementById('previewBubbleStyle');
            if (prev) prev.remove();
            // ä¸ç«‹å³éšè—displayï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                if (!modal.classList.contains('is-active')) {
                    modal.style.display = 'none';
                }
            }, 300);
        }

        function handleAvatarFileUpload(type) {
            const fileInputId = type === 'user' ? 'userAvatarFile' : 'aiAvatarFile';
            const inputId = type === 'user' ? 'userAvatarUrl' : 'aiAvatarUrl';
            
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            
            if (!file) return;
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º 1MBï¼‰
            if (file.size > 1024 * 1024) {
                alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 1MB çš„å›¾ç‰‡');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                // å°† Data URL ä¿å­˜åˆ°è¾“å…¥æ¡†
                document.getElementById(inputId).value = dataUrl;
                // æ›´æ–°é¢„è§ˆ
                updateAvatarPreview(type);
            };
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        function updateAvatarPreview(type) {
            const inputId = type === 'user' ? 'userAvatarUrl' : 'aiAvatarUrl';
            const previewId = type === 'user' ? 'userAvatarPreview' : 'aiAvatarPreview';
            
            const value = document.getElementById(inputId).value.trim();
            const preview = document.getElementById(previewId);
            
            preview.innerHTML = '';
            
            if (value && (value.startsWith('http') || value.startsWith('data:'))) {
                const img = document.createElement('img');
                img.src = value;
                img.onerror = function() {
                    preview.textContent = 'âŒ'; 
                };
                preview.appendChild(img);
            } else if (value) {
                preview.textContent = value.substring(0,2);
                preview.style.fontSize = '32px';
            } else {
                preview.textContent = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                preview.style.fontSize = '32px';
            }
        }

        function loadWorldbookSelectorsForRole(role) {
            const container = document.getElementById('worldbookSelectorContainer');
            worldbooks = JSON.parse(localStorage.getItem('worldbooks') || '[]');
            
            container.innerHTML = '';
            
            if (worldbooks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; font-size: 12px;">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåˆ›å»ºã€‚</p>';
                return;
            }
            
            // è·å–è§’è‰²å·²å…³è”çš„ä¸–ç•Œä¹¦
            const associatedWorldbooks = role.associatedWorldbooks || [];
            
            worldbooks.forEach(worldbook => {
                // ä¸ºæ¯ä¸ªä¸–ç•Œä¹¦åˆ›å»ºä¸€ä¸ªå¤é€‰æ¡†é¡¹
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 10px; padding: 8px; border-radius: 6px; background-color: #fff; border: 1px solid #eee;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `worldbook_${worldbook.id}`;
                checkbox.style.cssText = 'margin-right: 10px; cursor: pointer; width: 18px; height: 18px;';
                checkbox.dataset.worldbookId = worldbook.id;
                checkbox.checked = associatedWorldbooks.includes(worldbook.id);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.style.cssText = 'font-size: 14px; color: #333; cursor: pointer; flex: 1; margin: 0;';
                label.textContent = `${worldbook.name} (${worldbook.content.length})`;
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                container.appendChild(checkboxDiv);
            });
        }

        function saveAllSettings() {
            // ä¿å­˜å¤´åƒ
            const userValue = document.getElementById('userAvatarUrl').value.trim();
            const aiValue = document.getElementById('aiAvatarUrl').value.trim();
            
            if (!userValue || !aiValue) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å¤´åƒä¿¡æ¯ï¼');
                return;
            }
            
            // åŒºåˆ†URLã€Data URLï¼ˆæœ¬åœ°ä¸Šä¼ ï¼‰å’ŒEmoji
            if (userValue.startsWith('http') || userValue.startsWith('data:')) {
                localStorage.setItem('chat_user_avatar_url', userValue);
                localStorage.removeItem('chat_user_avatar_emoji');
            } else {
                localStorage.setItem('chat_user_avatar_emoji', userValue);
                localStorage.removeItem('chat_user_avatar_url');
            }
            
            if (aiValue.startsWith('http') || aiValue.startsWith('data:')) {
                localStorage.setItem('chat_ai_avatar_url', aiValue);
                localStorage.removeItem('chat_ai_avatar_emoji');
                // åŒæ­¥åˆ°åŠ¨æ€é¡µå¤´éƒ¨å’Œå·²æœ‰åŠ¨æ€ä¸­è¯¥è§’è‰²çš„å¤´åƒ
                try {
                    const headerAvatarEl = document.getElementById('momentAvatar');
                    if (headerAvatarEl) headerAvatarEl.style.backgroundImage = `url('${aiValue}')`;
                } catch (e) {}
                try {
                    const moments = JSON.parse(localStorage.getItem('moments') || '[]');
                    // å¦‚æœå½“å‰æ­£åœ¨ç¼–è¾‘è§’è‰²ä¸”è§’è‰²åå¯ç”¨ï¼Œåˆ™æŠŠè¯¥è§’è‰²ååŒ¹é…çš„åŠ¨æ€å¤´åƒæ›´æ–°
                    if (currentRoleId) {
                        const role = roles.find(r => r.id === currentRoleId);
                        if (role && role.name) {
                            let changed = false;
                            moments.forEach(m => {
                                if (m.userName === role.name) {
                                    m.userAvatar = aiValue;
                                    changed = true;
                                }
                            });
                            if (changed) localStorage.setItem('moments', JSON.stringify(moments));
                        }
                    }
                } catch (e) { console.warn('æ›´æ–°åŠ¨æ€å¤´åƒå¤±è´¥', e); }
            } else {
                localStorage.setItem('chat_ai_avatar_emoji', aiValue);
                localStorage.removeItem('chat_ai_avatar_url');
                try {
                    const headerAvatarEl = document.getElementById('momentAvatar');
                    if (headerAvatarEl) {
                        headerAvatarEl.style.backgroundImage = '';
                        headerAvatarEl.textContent = aiValue.substring(0,2);
                        headerAvatarEl.style.fontSize = '28px';
                        headerAvatarEl.style.display = 'flex';
                        headerAvatarEl.style.alignItems = 'center';
                        headerAvatarEl.style.justifyContent = 'center';
                    }
                } catch (e) {}
                try {
                    const moments = JSON.parse(localStorage.getItem('moments') || '[]');
                    if (currentRoleId) {
                        const role = roles.find(r => r.id === currentRoleId);
                        if (role && role.name) {
                            let changed = false;
                            moments.forEach(m => {
                                if (m.userName === role.name) {
                                    m.userAvatar = aiValue; // emoji stored in userAvatar for now
                                    changed = true;
                                }
                            });
                            if (changed) localStorage.setItem('moments', JSON.stringify(moments));
                        }
                    }
                } catch (e) { console.warn('æ›´æ–°åŠ¨æ€å¤´åƒå¤±è´¥', e); }
            }
            
            // ä¿å­˜æ˜µç§°
            const userNickname = document.getElementById('userNickname').value.trim();
            const aiNickname = document.getElementById('aiNickname').value.trim();
            localStorage.setItem('chat_user_nickname', userNickname);
            localStorage.setItem('chat_ai_nickname', aiNickname);
            
            // å¦‚æœåœ¨èŠå¤©ç•Œé¢ï¼Œæ›´æ–°é¡¶éƒ¨æ˜¾ç¤ºçš„æ˜µç§°
            if (currentRoleId && currentScreen === 'chatDetail') {
                const displayName = aiNickname || document.getElementById('chatDetailTitle').textContent;
                document.getElementById('chatDetailTitle').textContent = displayName;
            }
            
            // ä¿å­˜èƒŒæ™¯
            const chatBgColor = document.getElementById('chatBgColor').value;
            const chatBgImage = document.getElementById('chatBgImage').value.trim();
            localStorage.setItem('chat_bg_color', chatBgColor);
            localStorage.setItem('chat_bg_image', chatBgImage);

            // ä¿å­˜èŠå¤©æ°”æ³¡ä¸»é¢˜ä¸è‡ªå®šä¹‰æ ·å¼åŠå­—ä½“å¤§å°
            const selectedThemeEl = document.querySelector('input[name="bubbleTheme"]:checked');
            const selectedTheme = selectedThemeEl ? selectedThemeEl.value : 'classic';
            localStorage.setItem('chat_bubble_theme', selectedTheme);
            const customCss = document.getElementById('customBubbleCss').value || '';
            localStorage.setItem('chat_bubble_custom_css', customCss);
            const fontSizeVal = parseInt(document.getElementById('chatFontSize').value) || 14;
            localStorage.setItem('chat_font_size', String(fontSizeVal));
            
            // ä¿å­˜è§’è‰²è®¾ç½®
            if (currentRoleId) {
                const newName = document.getElementById('editRoleName').value.trim();
                const newPrompt = document.getElementById('editSystemPrompt').value.trim();
                const newModel = document.getElementById('editRoleModel').value;
                
                if (!newName || !newPrompt || !newModel) {
                    alert('è¯·å¡«å†™å®Œæ•´çš„è§’è‰²ä¿¡æ¯ï¼');
                    return;
                }
                
                // ä¿å­˜å…³è”çš„ä¸–ç•Œä¹¦
                const associatedWorldbooks = [];
                const worldbookCheckboxes = document.querySelectorAll('#worldbookSelectorContainer input[type="checkbox"]');
                worldbookCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        associatedWorldbooks.push(checkbox.dataset.worldbookId);
                    }
                });

                // è¯»å–å¹¶ä¿å­˜å…¶ä»–è¿è¡Œè®¾å®š
                const enableIndependentBackground = !!document.getElementById('enableIndependentBackground').checked;
                const independentCooldown = parseInt(document.getElementById('independentCooldown').value) || 0;
                const shortTermMemoryCount = parseInt(document.getElementById('shortTermMemoryCount').value) || 0;
                const autoSummarizeLongTerm = !!document.getElementById('autoSummarizeLongTerm').checked;
                const autoSummarizeInterval = parseInt(document.getElementById('autoSummarizeInterval').value) || 0;

                const roleIndex = roles.findIndex(r => r.id === currentRoleId);
                if (roleIndex > -1) {
                    roles[roleIndex].name = newName;
                    roles[roleIndex].prompt = newPrompt;
                    roles[roleIndex].model = newModel;
                    roles[roleIndex].associatedWorldbooks = associatedWorldbooks;
                    roles[roleIndex].enableIndependentBackground = enableIndependentBackground;
                    roles[roleIndex].independentCooldown = independentCooldown;
                    roles[roleIndex].shortTermMemoryCount = shortTermMemoryCount;
                    roles[roleIndex].autoSummarizeLongTerm = autoSummarizeLongTerm;
                    roles[roleIndex].autoSummarizeInterval = autoSummarizeInterval;
                    
                    // ä¿å­˜æœ€å¤šå›å¤æ¡æ•°
                    const maxReplyMessages = parseInt(document.getElementById('maxReplyMessages')?.value || '1', 10);
                    roles[roleIndex].maxReplyMessages = Math.max(1, Math.min(10, maxReplyMessages));
                    
                    localStorage.setItem('roles', JSON.stringify(roles));
                    // å¦‚æœæœ‰æ˜µç§°åˆ™æ˜¾ç¤ºæ˜µç§°ï¼Œå¦åˆ™æ˜¾ç¤ºæ–°çš„è§’è‰²åç§°
                    const aiNickname = localStorage.getItem('chat_ai_nickname') || '';
                    const displayName = aiNickname || newName;
                    document.getElementById('chatDetailTitle').textContent = displayName;
                }
            }
            
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
            closeAvatarSettings();
            
            // åº”ç”¨èƒŒæ™¯
            applyChatsBackground();
            // åº”ç”¨æ°”æ³¡ä¸»é¢˜ä¸å­—ä½“
            applyChatTheme();
            applyChatFontSize();
            // åˆ·æ–°æ¶ˆæ¯æ˜¾ç¤º (åº”ç”¨æ–°çš„å¤´åƒ/æ˜µç§°)
            refreshChatMessages();
        }

        function applyChatsBackground() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const bgColor = localStorage.getItem('chat_bg_color') || '#f8f8f8';
            const bgImage = localStorage.getItem('chat_bg_image') || '';
            
            chatMessages.style.backgroundColor = bgColor;
            if (bgImage) {
                chatMessages.style.backgroundImage = `url(${bgImage})`;
                chatMessages.style.backgroundSize = 'cover';
                chatMessages.style.backgroundPosition = 'center';
            } else {
                chatMessages.style.backgroundImage = 'none';
            }
        }

        // åº”ç”¨èŠå¤©æ°”æ³¡ä¸»é¢˜ï¼ˆåŸºäºé¢„è®¾æˆ–è‡ªå®šä¹‰ CSSï¼‰
        function applyChatTheme() {
            // ç§»é™¤ä¹‹å‰æ³¨å…¥çš„è‡ªå®šä¹‰æ ·å¼æˆ–é¢„è§ˆæ ·å¼
            const existing = document.getElementById('customBubbleStyle');
            if (existing) existing.remove();
            const prevPreview = document.getElementById('previewBubbleStyle');
            if (prevPreview) prevPreview.remove();

            const theme = localStorage.getItem('chat_bubble_theme') || 'classic';
            const customCss = localStorage.getItem('chat_bubble_custom_css') || '';

            if (customCss && customCss.trim().length > 0) {
                const style = document.createElement('style');
                style.id = 'customBubbleStyle';
                style.textContent = customCss;
                document.head.appendChild(style);
                return;
            }

            // å¦åˆ™åº”ç”¨å†…ç½®ä¸»é¢˜
            let receivedBg = '#e5e5ea';
            let sentBg = '#007aff';
            let receivedColor = '#000';
            let sentColor = '#fff';

            if (theme === 'pink-yellow') {
                receivedBg = '#f8bbd0'; // pink
                sentBg = '#fff59d'; // yellow
                receivedColor = '#000';
                sentColor = '#000';
            } else if (theme === 'deep-blue') {
                receivedBg = '#d6e9ff';
                sentBg = '#1e3a8a';
                receivedColor = '#000';
                sentColor = '#fff';
            } else if (theme === 'green-gray') {
                receivedBg = '#dcedc8';
                sentBg = '#bdbdbd';
                receivedColor = '#000';
                sentColor = '#000';
            } else { // classic
                receivedBg = '#e5e5ea';
                sentBg = '#007aff';
                receivedColor = '#000';
                sentColor = '#fff';
            }

            // è®¾ç½® CSS å˜é‡æˆ–ç›´æ¥æ³¨å…¥æ ·å¼
            const style = document.createElement('style');
            style.id = 'customBubbleStyle';
            style.textContent = `
                .message.received { background: ${receivedBg} !important; color: ${receivedColor} !important; }
                .message.sent { background: ${sentBg} !important; color: ${sentColor} !important; }
            `;
            document.head.appendChild(style);
        }

        // åº”ç”¨èŠå¤©å­—ä½“å¤§å°
        function applyChatFontSize() {
            const size = parseInt(localStorage.getItem('chat_font_size') || '14', 10);
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.style.fontSize = size + 'px';
            }
            // ä¹Ÿæ›´æ–°ç°æœ‰æ¶ˆæ¯çš„æ ·å¼
            document.querySelectorAll('.message').forEach(m => m.style.fontSize = size + 'px');
        }

        // é¢„è§ˆï¼ˆåŸºäºå½“å‰è¡¨å•è¾“å…¥ï¼Œä¸å†™å…¥ localStorageï¼‰
        function previewBubbleAndFont() {
            // ç§»é™¤å·²æœ‰é¢„è§ˆæ ·å¼
            const prev = document.getElementById('previewBubbleStyle');
            if (prev) prev.remove();

            const cssArea = document.getElementById('customBubbleCss');
            const customCss = cssArea ? cssArea.value.trim() : '';
            const selected = document.querySelector('input[name="bubbleTheme"]:checked');
            const theme = selected ? selected.value : (localStorage.getItem('chat_bubble_theme') || 'classic');
            const fontSizeVal = parseInt(document.getElementById('chatFontSize').value || '14', 10);

            if (customCss) {
                const s = document.createElement('style');
                s.id = 'previewBubbleStyle';
                s.textContent = customCss;
                document.head.appendChild(s);
            } else {
                let receivedBg = '#e5e5ea';
                let sentBg = '#007aff';
                let receivedColor = '#000';
                let sentColor = '#fff';
                if (theme === 'pink-yellow') { receivedBg = '#f8bbd0'; sentBg = '#fff59d'; receivedColor = '#000'; sentColor = '#000'; }
                else if (theme === 'deep-blue') { receivedBg = '#d6e9ff'; sentBg = '#1e3a8a'; receivedColor = '#000'; sentColor = '#fff'; }
                else if (theme === 'green-gray') { receivedBg = '#dcedc8'; sentBg = '#bdbdbd'; receivedColor = '#000'; sentColor = '#000'; }
                const s = document.createElement('style');
                s.id = 'previewBubbleStyle';
                s.textContent = `.message.received{background:${receivedBg} !important; color:${receivedColor} !important;} .message.sent{background:${sentBg} !important; color:${sentColor} !important;} .message{font-size:${fontSizeVal}px !important;}`;
                document.head.appendChild(s);
            }

            // ä¹Ÿåº”ç”¨åˆ°æ¶ˆæ¯åŒºï¼ˆå®æ—¶ï¼‰
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) chatMessages.style.fontSize = fontSizeVal + 'px';
            document.querySelectorAll('.message').forEach(m => m.style.fontSize = fontSizeVal + 'px');
        }

        // åº”ç”¨è‡ªå®šä¹‰å­—ä½“ï¼ˆæŒä¹…åŒ–ï¼‰
        async function applyFont() {
            // ä¼˜å…ˆï¼šsession Blob URL -> session data/url -> IndexedDB blob -> localStorage data/url
            try {
                // 1) session in-memory blob URL
                if (window._sessionFontBlobUrl) {
                    const blobUrl = window._sessionFontBlobUrl;
                    await applyFontFromSource(blobUrl);
                    return;
                }

                // 2) session data/url
                if (window._sessionFontData) {
                    await applyFontFromSource(window._sessionFontData);
                    return;
                }
                if (window._sessionFontUrl) {
                    await applyFontFromSource(window._sessionFontUrl);
                    return;
                }

                // 3) try IndexedDB blob
                const idbBlob = await getFontBlobFromIDB('userfont');
                if (idbBlob) {
                    try {
                        const blobUrl = URL.createObjectURL(idbBlob);
                        // keep in session so subsequent calls reuse it
                        window._sessionFontBlobUrl = blobUrl;
                        await applyFontFromSource(blobUrl);
                        return;
                    } catch (e) { console.warn('apply from idb blob failed', e); }
                }

                // 4) fallback to localStorage (data or url)
                const data = localStorage.getItem('custom_font_data');
                const url = localStorage.getItem('custom_font_url');
                const source = data || url;
                if (source) {
                    await applyFontFromSource(source);
                }
            } catch (e) {
                console.warn('applyFont error', e);
            }
        }

        // helper that actually loads a font from a source (data/blob/http/url)
        async function applyFontFromSource(source) {
            const existing = document.getElementById('customFontStyle');
            if (existing) existing.remove();
            const applyStyleNode = () => {
                const style = document.createElement('style');
                style.id = 'customFontStyle';
                style.textContent = `
                    body, .phone-screen, .content,
                    .status-bar, .header, .back-btn, h1, h2, h3, h4, h5, h6,
                    .app-grid, .widget, .app-icon, .dock,
                    .api-settings, .api-content, .save-btn,
                    button, input, select, textarea, label,
                    .chat-container, .chat-messages, .chat-input-area, .message, .message-avatar,
                    .role-card, .role-info, .menu-content,
                    .avatar-modal-content, .settings-tab-btn,
                    #phoneAlert,
                    #roleActionMenu, #createWorldbookModal, #addWorldbookContentModal, #avatarSettingsModal
                { font-family: 'UserCustomFont', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important; }
                `;
                document.head.appendChild(style);
            };

            try {
                if (typeof source === 'string' && source.startsWith('data:')) {
                    const blob = dataURLToBlob(source);
                    const ab = await blob.arrayBuffer();
                    const ff = new FontFace('UserCustomFont', ab);
                    await ff.load();
                    try { document.fonts.add(ff); } catch (e) {}
                    applyStyleNode();
                } else if (typeof source === 'string' && source.startsWith('blob:')) {
                    const resp = await fetch(source);
                    if (!resp.ok) throw new Error('è¯»å–æœ¬åœ°å­—ä½“å¤±è´¥: ' + resp.status);
                    const ab = await resp.arrayBuffer();
                    const ff = new FontFace('UserCustomFont', ab);
                    await ff.load();
                    try { document.fonts.add(ff); } catch (e) {}
                    applyStyleNode();
                } else {
                    // http(s) url
                    const ff = new FontFace('UserCustomFont', `url(${source})`);
                    await ff.load();
                    try { document.fonts.add(ff); } catch (e) {}
                    applyStyleNode();
                }
            } catch (err) {
                console.warn('applyFontFromSource failed', err);
                const status = document.getElementById('fontStatus'); if (status) status.textContent = 'åº”ç”¨å­—ä½“å¤±è´¥ï¼ˆå¯èƒ½è¢« CORS é˜»æ­¢æˆ–æ–‡ä»¶æ— æ•ˆï¼‰ã€‚';
            }
        }

        // å¤„ç†æœ¬åœ°æ–‡ä»¶é€‰æ‹©ï¼šä½¿ç”¨ Blob URL å¿«é€Ÿé¢„è§ˆï¼ŒåŒæ—¶è¯»å– data:URL ä»¥ä¾¿ä¿å­˜
        function handleFontFileSelection(e) {
            const file = (e && e.target && e.target.files && e.target.files[0]) || null;
            if (!file) return;
            // é‡Šæ”¾ä¸Šä¸€ä¸ª blob URLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window._lastUploadedFontBlobUrl) {
                try { URL.revokeObjectURL(window._lastUploadedFontBlobUrl); } catch (e) { /* ignore */ }
                window._lastUploadedFontBlobUrl = null;
            }

            // ç«‹å³åˆ›å»º blob URL ç”¨äºé¢„è§ˆï¼ˆæ›´å¯é ã€é€Ÿåº¦æ›´å¿«ï¼Œé¿å…éƒ¨åˆ†æµè§ˆå™¨å¯¹ data: æœ‰é™æ”¯æŒï¼‰
            try {
                const blobUrl = URL.createObjectURL(file);
                window._lastUploadedFontBlobUrl = blobUrl;
                // æ¸…ç©º URL è¾“å…¥ï¼ˆä¼˜å…ˆä½¿ç”¨æœ¬åœ°ä¸Šä¼ ï¼‰
                const input = document.getElementById('fontUrlInput'); if (input) input.value = '';
                // å…ˆç”¨ blob URL é¢„è§ˆ
                previewFontWithSource(blobUrl, true);
            } catch (err) {
                console.warn('createObjectURL failed', err);
            }

            // åŒæ—¶è¯»å–ä¸º data URLï¼ˆç”¨äºæŒä¹…åŒ–ä¿å­˜åˆ° localStorageï¼‰
            const reader = new FileReader();
            reader.onload = function(ev) {
                try { window._lastUploadedFontDataUrl = ev.target.result; } catch (e) { window._lastUploadedFontDataUrl = null; }
            };
            reader.onerror = function() { console.warn('è¯»å–æœ¬åœ°å­—ä½“ä¸º dataURL å¤±è´¥'); window._lastUploadedFontDataUrl = null; };
            reader.readAsDataURL(file);
        }

        // é¢„è§ˆå­—ä½“ï¼ˆä¸ä¿å­˜ï¼‰
        function previewFont() {
            const input = document.getElementById('fontUrlInput');
            const url = input ? input.value.trim() : '';
            // ä¼˜å…ˆä½¿ç”¨ blob URLï¼ˆæœ¬åœ°ä¸Šä¼ ï¼‰ï¼Œç„¶å data URLï¼Œæœ€åä½¿ç”¨å·²ä¿å­˜çš„è®¾ç½®
            const source = url || window._lastUploadedFontBlobUrl || window._lastUploadedFontDataUrl || localStorage.getItem('custom_font_data') || localStorage.getItem('custom_font_url');
            if (!source) { showPhoneAlert('è¯·è¾“å…¥å­—ä½“ URL æˆ–é€‰æ‹©æœ¬åœ°å­—ä½“æ–‡ä»¶'); return; }
            previewFontWithSource(source, false);
        }

        async function previewFontWithSource(source, isLocalUploaded) {
            const status = document.getElementById('fontStatus'); if (status) status.textContent = 'åŠ è½½ä¸­...';
            const prevStyle = document.getElementById('previewFontStyle'); if (prevStyle) prevStyle.remove();
            const prevFace = document.getElementById('previewFontFace'); if (prevFace) prevFace.remove();
            const family = 'UserCustomFontPreview_' + Date.now();
            try {
                let ff;
                // å°è¯•é€šè¿‡ ArrayBuffer æ„é€ ï¼ˆå¯¹æœ¬åœ° blob/data æ›´å¯é ï¼‰
                if (typeof source === 'string' && source.startsWith('blob:')) {
                    const resp = await fetch(source);
                    if (!resp.ok) throw new Error('æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼ˆfetch è¿”å› ' + resp.status + ')' );
                    const ab = await resp.arrayBuffer();
                    ff = new FontFace(family, ab);
                } else if (typeof source === 'string' && source.startsWith('data:')) {
                    const comma = source.indexOf(',');
                    const header = source.slice(0, comma);
                    const isBase64 = header.indexOf(';base64') !== -1;
                    let ab;
                    if (isBase64) {
                        const b64 = source.slice(comma + 1);
                        const bin = atob(b64);
                        const len = bin.length;
                        const u8 = new Uint8Array(len);
                        for (let i = 0; i < len; i++) u8[i] = bin.charCodeAt(i);
                        ab = u8.buffer;
                    } else {
                        const raw = decodeURIComponent(source.slice(comma + 1));
                        const len = raw.length;
                        const u8 = new Uint8Array(len);
                        for (let i = 0; i < len; i++) u8[i] = raw.charCodeAt(i);
                        ab = u8.buffer;
                    }
                    ff = new FontFace(family, ab);
                } else if (typeof source === 'string' && (source.startsWith('http:') || source.startsWith('https:'))) {
                    // è¿œç¨‹ URLï¼Œç›´æ¥ä½¿ç”¨ url() æ–¹å¼ï¼ˆå¯èƒ½å— CORS é™åˆ¶ï¼‰
                    ff = new FontFace(family, `url(${source})`);
                } else {
                    // å…œåº•ï¼šå°è¯• url()
                    ff = new FontFace(family, `url(${source})`);
                }

                // å°è¯•åŠ è½½ FontFaceï¼ˆè‹¥å¤±è´¥åˆ™å›é€€åˆ°æ³¨å…¥ @font-faceï¼‰
                try {
                    await ff.load();
                    try { document.fonts.add(ff); } catch (e) { /* ignore */ }
                    const s = document.createElement('style'); s.id = 'previewFontStyle'; s.textContent = `#fontPreviewText { font-family: '${family}', sans-serif !important; }`;
                    document.head.appendChild(s);
                    if (status) status.textContent = 'é¢„è§ˆæˆåŠŸ';
                    return;
                } catch (innerErr) {
                    console.warn('FontFace load failed, falling back to @font-face injection', innerErr);
                    // å›é€€åˆ°æ³¨å…¥ @font-face ä½¿ç”¨åŸå§‹ URLï¼ˆblob/data/httpï¼‰
                    if (typeof source === 'string' && (source.startsWith('blob:') || source.startsWith('data:') || source.startsWith('http') || source.startsWith('https')) ) {
                        const style = document.createElement('style');
                        style.id = 'previewFontFace';
                        // åŒ…å« src: url(...)ï¼›å¯¹äº data: å’Œ blob: åº”å¯å·¥ä½œ
                        style.textContent = `@font-face{font-family: '${family}'; src: url(${source});}`;
                        document.head.appendChild(style);
                        const s2 = document.createElement('style'); s2.id = 'previewFontStyle'; s2.textContent = `#fontPreviewText { font-family: '${family}', sans-serif !important; }`;
                        document.head.appendChild(s2);
                        if (status) status.textContent = 'é¢„è§ˆæˆåŠŸï¼ˆä½¿ç”¨å›é€€æ–¹å¼ï¼‰';
                        return;
                    }
                    throw innerErr;
                }

            } catch (err) {
                console.error('preview failed', err);
                if (status) status.textContent = 'é¢„è§ˆå¤±è´¥ï¼ˆå¯èƒ½è¢« CORS é˜»æ­¢æˆ–æ–‡ä»¶æ— æ•ˆï¼‰ã€‚';
                showPhoneAlert('é¢„è§ˆå¤±è´¥ï¼š' + (err && err.message ? err.message : err));
                throw err;
            }
        }

        // æ¸…é™¤å¹¶å›æ”¶ä¸Šä¼  Blob URLï¼ˆåŒæ—¶ä» IDB åˆ é™¤ï¼‰
        async function clearFont() {
            try {
                if (window._lastUploadedFontBlobUrl) {
                    try { URL.revokeObjectURL(window._lastUploadedFontBlobUrl); } catch (e) { /* ignore */ }
                    window._lastUploadedFontBlobUrl = null;
                }
                if (window._sessionFontBlobUrl) {
                    try { URL.revokeObjectURL(window._sessionFontBlobUrl); } catch (e) { /* ignore */ }
                    window._sessionFontBlobUrl = null;
                }
            } catch (e) { /* ignore */ }
            window._lastUploadedFontDataUrl = null;
            window._sessionFontData = null;
            window._sessionFontUrl = null;
            localStorage.removeItem('custom_font_url');
            localStorage.removeItem('custom_font_data');
            // å°è¯•ä» IndexedDB åˆ é™¤æŒä¹…åŒ–å­—ä½“ï¼ˆå¿½ç•¥é”™è¯¯ï¼‰
            try { await deleteFontFromIDB('userfont'); } catch (e) { console.warn('IDB delete failed', e); }
            const prevPreview = document.getElementById('previewFontStyle'); if (prevPreview) prevPreview.remove();
            const prev = document.getElementById('customFontStyle'); if (prev) prev.remove();
            const status = document.getElementById('fontStatus'); if (status) status.textContent = 'å·²æ¸…é™¤è‡ªå®šä¹‰å­—ä½“';
            showPhoneAlert('å·²æ¸…é™¤è‡ªå®šä¹‰å­—ä½“ï¼Œæ¢å¤é»˜è®¤');
        }

        // ä¿å­˜å¹¶åº”ç”¨å­—ä½“
        async function saveFontAndApply() {
            const uploadedDataUrl = window._lastUploadedFontDataUrl || null;
            const blobUrl = window._lastUploadedFontBlobUrl || null;
            const url = document.getElementById('fontUrlInput') ? document.getElementById('fontUrlInput').value.trim() : '';

            // å¦‚æœç”¨æˆ·æä¾›äº†è¿œç¨‹ URLï¼ˆä¼˜å…ˆä»…ä¿å­˜ URLï¼‰
            if (url) {
                try {
                    await previewFontWithSource(url, false);
                    try { localStorage.setItem('custom_font_url', url); localStorage.removeItem('custom_font_data'); } catch (e) { console.warn('localStorage å†™å…¥å¤±è´¥', e); window._sessionFontUrl = url; showPhoneAlert('å·²ä¿å­˜è‡³æœ¬æ¬¡ä¼šè¯ï¼ŒlocalStorage å†™å…¥å¤±è´¥'); }
                    // åˆ é™¤ IDB ä¸­çš„æ—§ blobï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
                    try { await deleteFontFromIDB('userfont'); } catch (e) { console.warn('IDB delete failed', e); }
                    await applyFont();
                    showPhoneAlert('å­—ä½“ URL å·²ä¿å­˜å¹¶åº”ç”¨');
                    return;
                } catch (e) {
                    // preview å·²ç»™å‡ºæç¤º
                    return;
                }
            }

            // å¦‚æœæœ‰æœ¬åœ°ä¸Šä¼ ï¼ˆä¼˜å…ˆä½¿ç”¨ Blob URLï¼‰ï¼Œå°è¯•æŠŠ Blob å­˜å…¥ IndexedDB
            if (blobUrl || uploadedDataUrl) {
                // ä¼˜å…ˆä» blobUrl æ‹‰å– Blob
                try {
                    let blob = null;
                    if (blobUrl) {
                        try {
                            const resp = await fetch(blobUrl);
                            if (resp.ok) blob = await resp.blob();
                        } catch (e) { console.warn('ä» blobUrl fetch å¤±è´¥ï¼Œå°è¯• dataURL', e); }
                    }

                    if (!blob && uploadedDataUrl) {
                        try { blob = dataURLToBlob(uploadedDataUrl); } catch (e) { console.warn('dataURLToBlob å¤±è´¥', e); }
                    }

                    if (!blob) {
                        showPhoneAlert('æ— æ³•è¯»å–ä¸Šä¼ çš„å­—ä½“æ–‡ä»¶ï¼Œä¿å­˜å¤±è´¥');
                        return;
                    }

                    // å…ˆé¢„è§ˆï¼ˆä½¿ç”¨ä¸´æ—¶ ObjectURLï¼‰
                    let tempUrl = null;
                    try {
                        tempUrl = URL.createObjectURL(blob);
                        window._sessionFontBlobUrl = tempUrl;
                        await previewFontWithSource(tempUrl, true);
                    } catch (e) {
                        console.warn('é¢„è§ˆä¸Šä¼ å­—ä½“å¤±è´¥', e);
                        if (tempUrl) { try { URL.revokeObjectURL(tempUrl); } catch (er) {} }
                        throw e;
                    }

                    // å°è¯•å°† Blob ä¿å­˜åˆ° IndexedDB
                    try {
                        await saveFontBlobToIDB('userfont', blob);
                        // æ¸…ç† localStorage è·Ÿä¼šè¯ä¸­ä¸ URL ç›¸å…³çš„æ—§è®¾ç½®
                        localStorage.removeItem('custom_font_url');
                        localStorage.removeItem('custom_font_data');
                        window._lastUploadedFontDataUrl = null;
                        window._lastUploadedFontBlobUrl = null;
                        // ä¿æŒ session çš„ object URL ä¾› applyFont ä½¿ç”¨
                        window._sessionFontBlobUrl = tempUrl;
                        await applyFont();
                        showPhoneAlert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼ˆå·²ä¿å­˜åœ¨ IndexedDBï¼‰');
                        return;
                    } catch (idbErr) {
                        console.warn('IndexedDB ä¿å­˜å¤±è´¥ï¼Œå°è¯•å›é€€åˆ° localStorage', idbErr);
                        // å›é€€ï¼šæŠŠ blob è½¬ä¸º dataURL å†™å…¥ localStorageï¼ˆå¯èƒ½å¤±è´¥æˆ–è¶…é™ï¼‰
                        try {
                            const ab = await blob.arrayBuffer();
                            const u8 = new Uint8Array(ab);
                            let binary = '';
                            const chunk = 0x8000;
                            for (let i = 0; i < u8.length; i += chunk) {
                                binary += String.fromCharCode.apply(null, u8.subarray(i, i + chunk));
                            }
                            const b64 = btoa(binary);
                            const ct = blob.type || 'font/woff2';
                            const dataUrl = `data:${ct};base64,${b64}`;
                            try { localStorage.setItem('custom_font_data', dataUrl); localStorage.removeItem('custom_font_url'); }
                            catch (lsErr) { console.warn('localStorage å†™å…¥å¤±è´¥', lsErr); window._sessionFontData = dataUrl; showPhoneAlert('å·²ä¿å­˜è‡³æœ¬æ¬¡ä¼šè¯ï¼Œæµè§ˆå™¨å­˜å‚¨å—é™'); }
                            await applyFont();
                            showPhoneAlert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼ˆå·²ä¿å­˜è‡³ localStorage æˆ–æœ¬æ¬¡ä¼šè¯ï¼‰');
                            return;
                        } catch (convErr) {
                            console.warn('è½¬æ¢ä¸º dataURL å¤±è´¥', convErr);
                            showPhoneAlert('ä¿å­˜å¤±è´¥ï¼Œæ— æ³•æŒä¹…åŒ–å­—ä½“æ–‡ä»¶');
                            return;
                        }
                    }

                } catch (e) {
                    console.warn('ä¿å­˜æœ¬åœ°ä¸Šä¼ å­—ä½“æ—¶å‡ºé”™', e);
                    showPhoneAlert('ä¿å­˜å¤±è´¥ï¼š' + (e && e.message ? e.message : e));
                    return;
                }
            }

            // è‹¥æ— ä»»ä½•æ¥æºï¼Œåˆ™æç¤º
            showPhoneAlert('è¯·å…ˆé€‰æ‹©æœ¬åœ°å­—ä½“æ–‡ä»¶æˆ–è¾“å…¥å­—ä½“ URL');
        }

        function refreshChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages.children.length > 0) {
                // ä¿å­˜å½“å‰æ¶ˆæ¯å†…å®¹
                const messages = [];
                // éå†æ‰€æœ‰çš„ message-bubble
                for (let i = 0; i < chatMessages.children.length; i++) {
                    const bubble = chatMessages.children[i];
                    const messageEl = bubble.querySelector('.message');
                    // è·³è¿‡ "æ€è€ƒä¸­..." æ°”æ³¡
                    if (messageEl && !messageEl.classList.contains('thinking')) {
                        const sender = messageEl.classList.contains('sent') ? 'user' : 'ai';
                        messages.push({ sender, text: messageEl.textContent });
                    }
                }
                
                // æ¸…ç©ºå¹¶é‡æ–°æ˜¾ç¤º
                chatMessages.innerHTML = '';
                messages.forEach(msg => {
                    // ä½¿ç”¨ shouldSave=false é¿å…äºŒæ¬¡ä¿å­˜
                    appendMessage(msg.sender, msg.text, false); 
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            applyChatsBackground();
        }

        // ===== åŠ¨æ€/æœ‹å‹åœˆåŠŸèƒ½ =====
        
        // æ›´æ¢åŠ¨æ€èƒŒæ™¯
        function changeMomentBg() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const dataUrl = event.target.result;
                        localStorage.setItem('moment_bg', dataUrl);
                        document.getElementById('momentHeaderBg').style.backgroundImage = `url('${dataUrl}')`;
                        showPhoneAlert('èƒŒæ™¯å·²æ›´æ¢');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // æ›´æ¢åŠ¨æ€å¤´åƒ
        function changeMomentAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const dataUrl = event.target.result;
                        localStorage.setItem('moment_avatar', dataUrl);
                        document.getElementById('momentAvatar').style.backgroundImage = `url('${dataUrl}')`;
                        showPhoneAlert('å¤´åƒå·²æ›´æ¢');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // åŠ è½½åŠ¨æ€è®¾ç½®
        function loadMomentSettings() {
            const savedBg = localStorage.getItem('moment_bg');
            const savedAvatar = localStorage.getItem('moment_avatar');
            
            if (savedBg) {
                try {
                    document.getElementById('momentHeaderBg').style.backgroundImage = `url('${savedBg}')`;
                } catch (e) { console.warn('è®¾ç½® savedBg å¤±è´¥', e); }
            } else {
                // ä½¿ç”¨é»˜è®¤èƒŒæ™¯å›¾
                try {
                    document.getElementById('momentHeaderBg').style.backgroundImage = `url('https://i.postimg.cc/K8K84gkL/IMG-4887.jpg')`;
                } catch (e) { console.warn('è®¾ç½®é»˜è®¤èƒŒæ™¯å¤±è´¥', e); }
            }
            if (savedAvatar) {
                document.getElementById('momentAvatar').style.backgroundImage = `url('${savedAvatar}')`;
                document.getElementById('momentAvatar').textContent = '';
            }
            
            loadMomentList();
        }
        
        // æ˜¾ç¤ºå‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†
        function showPostMomentModal() {
            const modal = document.getElementById('postMomentModal');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.pointerEvents = 'auto';
            
            document.getElementById('momentContentInput').value = '';
            document.getElementById('momentWithImage').checked = false;
            document.getElementById('imageDescriptionInput').value = '';
            document.getElementById('imageDescriptionSection').style.display = 'none';
        }
        
        // å…³é—­å‘å¸ƒåŠ¨æ€æ¨¡æ€æ¡†
        function closePostMomentModal() {
            const modal = document.getElementById('postMomentModal');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.pointerEvents = 'none';
        }
        
        // åˆ‡æ¢å›¾ç‰‡æè¿°è¾“å…¥æ¡†
        function toggleImageDescription() {
            const checkbox = document.getElementById('momentWithImage');
            const section = document.getElementById('imageDescriptionSection');
            section.style.display = checkbox.checked ? 'block' : 'none';
        }
        
        // å‘å¸ƒåŠ¨æ€
        function postMoment() {
            const content = document.getElementById('momentContentInput').value.trim();
            const withImage = document.getElementById('momentWithImage').checked;
            const imageDesc = document.getElementById('imageDescriptionInput').value.trim();
            
            if (!content) {
                showPhoneAlert('è¯·è¾“å…¥åŠ¨æ€å†…å®¹');
                return;
            }
            
            if (withImage && !imageDesc) {
                showPhoneAlert('è¯·è¾“å…¥å›¾ç‰‡æè¿°');
                return;
            }
            
            const moment = {
                id: Date.now(),
                content: content,
                hasImage: withImage,
                imageDescription: withImage ? imageDesc : '',
                timestamp: Date.now(),
                userName: 'æˆ‘',
                userAvatar: localStorage.getItem('moment_avatar') || 'https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg',
                likes: [],
                comments: []
            };
            
            let moments = JSON.parse(localStorage.getItem('moments') || '[]');
            moments.unshift(moment);
            localStorage.setItem('moments', JSON.stringify(moments));
            
            closePostMomentModal();
            loadMomentList();
            showPhoneAlert('å‘å¸ƒæˆåŠŸ');
            
            // è§¦å‘è§’è‰²ååº”
            setTimeout(() => {
                triggerRoleReactions(moment.id);
            }, Math.random() * 3000 + 2000);
        }
        
        // åŠ è½½åŠ¨æ€åˆ—è¡¨
        function loadMomentList() {
            const moments = JSON.parse(localStorage.getItem('moments') || '[]');
            const listDiv = document.getElementById('momentList');
            const headerBg = document.getElementById('momentHeaderBg');
            const headerAvatar = document.getElementById('momentAvatar');

            // è®¾ç½® header èƒŒæ™¯å’Œå¤´åƒï¼šä¼˜å…ˆä½¿ç”¨ beautify èƒŒæ™¯å’Œä¸“ç”¨çš„ header èƒŒæ™¯è®¾ç½®
            const bg = localStorage.getItem('beautify_background') || localStorage.getItem('moment_bg') || '';
            const configuredAvatar = localStorage.getItem('moment_avatar') || '';
            if (headerBg) {
                if (bg) headerBg.style.backgroundImage = `url('${bg}')`;
                else headerBg.style.backgroundImage = `url('https://i.postimg.cc/K8K84gkL/IMG-4887.jpg')`;
            }
            if (headerAvatar) {
                const avatarToUse = configuredAvatar || (moments.length > 0 ? moments[0].userAvatar : '') || '';
                if (avatarToUse && (avatarToUse.startsWith('http') || avatarToUse.startsWith('data:'))) {
                    headerAvatar.style.backgroundImage = `url('${avatarToUse}')`;
                    headerAvatar.textContent = '';
                } else if (avatarToUse) {
                    // è§†ä¸º emoji/çŸ­æ–‡æœ¬
                    headerAvatar.style.backgroundImage = '';
                    headerAvatar.textContent = avatarToUse.substring(0,2);
                    headerAvatar.style.fontSize = '28px';
                    headerAvatar.style.display = 'flex';
                    headerAvatar.style.alignItems = 'center';
                    headerAvatar.style.justifyContent = 'center';
                } else {
                    headerAvatar.style.backgroundImage = `url('https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg')`;
                    headerAvatar.textContent = '';
                }
            }
            
            if (moments.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px 20px;">
                        <p>æš‚æ— åŠ¨æ€</p>
                        <p style="font-size: 13px; margin-top: 5px;">ç‚¹å‡»å³ä¸Šè§’ç›¸æœºå‘å¸ƒåŠ¨æ€</p>
                    </div>
                `;
                return;
            }
            
            listDiv.innerHTML = moments.map(moment => {
                const time = formatMomentTime(moment.timestamp);
                const imageHtml = moment.hasImage ? 
                    `<img src="https://i.postimg.cc/SNBXJgxF/IMG-4900.jpg" class="moment-image" onclick="viewMomentImage('${(moment.imageDescription||'').replace(/'/g, "\\'")}')" alt="${(moment.imageDescription||'å›¾ç‰‡').replace(/\"/g,'')}">` : '';
                
                // å¤„ç†ç‚¹èµ
                const likes = moment.likes || [];
                const isLiked = likes.includes('æˆ‘');
                const likesHtml = likes.length > 0 ? 
                    `<div class="moment-likes"><svg class="moment-action-icon" viewBox="0 0 24 24"><path d="M12 21s-7.5-4.35-10-7.2C-0.5 9.9 3 4 8 4c2.5 0 3.5 1.6 4 2.2C12.5 5.6 13.5 4 16 4c5 0 8.5 5.9 6 9.8C19.5 16.65 12 21 12 21z"/></svg> ${likes.join('ã€')}</div>` : '';
                
                // å¤„ç†è¯„è®º
                const comments = moment.comments || [];
                const commentsHtml = comments.length > 0 ? 
                    `<div class="moment-comments">
                        ${comments.map(c => `
                            <div class="moment-comment">
                                <span class="comment-user">${c.userName}</span>: 
                                <span class="comment-text">${c.text}</span>
                            </div>
                        `).join('')}
                    </div>` : '';
                
                return `
                    <div class="moment-item">
                        <div class="moment-user">
                            <div class="moment-user-avatar" style="background-image: url('${moment.userAvatar}');"></div>
                            <div class="moment-user-info">
                                <div class="moment-user-name">${moment.userName}</div>
                            </div>
                        </div>
                        <div class="moment-content">${moment.content}</div>
                        ${imageHtml}
                        <div class="moment-time">${time}</div>
                        <div class="moment-actions">
                            <div class="moment-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike(${moment.id})">
                                <svg class="moment-action-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M12 21s-7.5-4.35-10-7.2C-0.5 9.9 3 4 8 4c2.5 0 3.5 1.6 4 2.2C12.5 5.6 13.5 4 16 4c5 0 8.5 5.9 6 9.8C19.5 16.65 12 21 12 21z"/>
                                </svg>
                                <span class="moment-action-count">${likes.length > 0 ? likes.length : ''}</span>
                            </div>
                            <div class="moment-action-btn" onclick="showCommentInput(${moment.id})">
                                <svg class="moment-action-icon" viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M21 6h-18v9c0 1.1.9 2 2 2h3v3l4-3h9c1.1 0 2-.9 2-2v-9c0-1.1-.9-2-2-2z"/>
                                </svg>
                                <span class="moment-action-count">${comments.length > 0 ? comments.length : ''}</span>
                            </div>
                        </div>
                        ${likesHtml}
                        ${commentsHtml}
                    </div>
                `;
            }).join('');
            // ç¡®ä¿åˆ—è¡¨é¡¶éƒ¨æœ‰è¶³å¤Ÿç©ºé—´ï¼Œä¸é®ä½ header åº•éƒ¨å’Œæ‚¬æµ®å¤´åƒ
            if (listDiv) listDiv.style.paddingTop = '30px';
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatMomentTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'åˆšåˆš';
            if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            if (hours < 24) return `${hours}å°æ—¶å‰`;
            if (days < 7) return `${days}å¤©å‰`;
            
            const date = new Date(timestamp);
            return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }
        
        // æŸ¥çœ‹åŠ¨æ€å›¾ç‰‡
        function viewMomentImage(description) {
            const modal = document.getElementById('imageViewModal');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.pointerEvents = 'auto';
            // å¦‚æœ future æ‰©å±•æ”¯æŒçœŸå®å›¾ç‰‡ URLï¼Œå¯ä»¥æ›¿æ¢ä¸‹é¢çš„å ä½å›¾
            const placeholder = 'https://i.postimg.cc/SNBXJgxF/IMG-4900.jpg';
            document.getElementById('viewedImage').src = placeholder;
            document.getElementById('imageDescriptionView').textContent = description || 'å›¾ç‰‡æè¿°';
        }
        
        // å…³é—­å›¾ç‰‡æŸ¥çœ‹
        function closeImageView() {
            const modal = document.getElementById('imageViewModal');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.pointerEvents = 'none';
        }
        
        // ç‚¹èµåŠŸèƒ½
        function toggleLike(momentId) {
            let moments = JSON.parse(localStorage.getItem('moments') || '[]');
            const moment = moments.find(m => m.id === momentId);
            
            if (!moment) return;
            
            if (!moment.likes) moment.likes = [];
            
            const userName = 'æˆ‘';
            const index = moment.likes.indexOf(userName);
            
            if (index > -1) {
                // å–æ¶ˆç‚¹èµ
                moment.likes.splice(index, 1);
            } else {
                // ç‚¹èµ
                moment.likes.push(userName);
            }
            
            localStorage.setItem('moments', JSON.stringify(moments));
            loadMomentList();
        }
        
        // æ˜¾ç¤ºè¯„è®ºè¾“å…¥
        function showCommentInput(momentId) {
            const comment = prompt('è¾“å…¥è¯„è®ºå†…å®¹ï¼š');
            if (comment && comment.trim()) {
                addComment(momentId, 'æˆ‘', comment.trim());
            }
        }
        
        // æ·»åŠ è¯„è®º
        function addComment(momentId, userName, text) {
            let moments = JSON.parse(localStorage.getItem('moments') || '[]');
            const moment = moments.find(m => m.id === momentId);
            
            if (!moment) return;
            
            if (!moment.comments) moment.comments = [];
            
            moment.comments.push({
                userName: userName,
                text: text,
                timestamp: Date.now()
            });
            
            localStorage.setItem('moments', JSON.stringify(moments));
            loadMomentList();
        }
        
        // è§¦å‘è§’è‰²ååº”ï¼ˆç‚¹èµå’Œè¯„è®ºï¼‰
        async function triggerRoleReactions(momentId) {
            // æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è§’è‰²åå°æ´»åŠ¨
            const backgroundActivity = localStorage.getItem('background_activity') === 'true';
            if (!backgroundActivity) return;
            
            const roles = JSON.parse(localStorage.getItem('roles') || '[]');
            if (roles.length === 0) return;
            
            let moments = JSON.parse(localStorage.getItem('moments') || '[]');
            const moment = moments.find(m => m.id === momentId);
            if (!moment) return;
            
            // æ¯ä¸ªè§’è‰²ç‹¬ç«‹åˆ¤æ–­æ˜¯å¦ååº”ï¼ˆ30%æ¦‚ç‡ï¼‰
            const reactingRoles = roles.filter(() => Math.random() < 0.3);
            
            if (reactingRoles.length === 0) return;
            
            reactingRoles.forEach((role, index) => {
                // éšæœºå»¶è¿Ÿ5-30ç§’ï¼Œæ›´åƒçœŸäºº
                const delay = Math.random() * 25000 + 5000;
                
                setTimeout(async () => {
                    // é‡æ–°è¯»å–æœ€æ–°æ•°æ®
                    let moments = JSON.parse(localStorage.getItem('moments') || '[]');
                    const moment = moments.find(m => m.id === momentId);
                    if (!moment) return;
                    
                    // æ ¹æ®äººè®¾å†³å®šç‚¹èµè¿˜æ˜¯è¯„è®ºï¼ˆ60%ç‚¹èµï¼Œ40%è¯„è®ºï¼‰
                    const shouldLike = Math.random() < 0.6;
                    
                    if (shouldLike) {
                        // ç‚¹èµ
                        if (!moment.likes) moment.likes = [];
                        if (!moment.likes.includes(role.name)) {
                            moment.likes.push(role.name);
                            localStorage.setItem('moments', JSON.stringify(moments));
                            loadMomentList();
                        }
                    } else {
                        // è¯„è®º - ä½¿ç”¨AIç”Ÿæˆç¬¦åˆäººè®¾çš„è¯„è®º
                        if (!moment.comments) moment.comments = [];
                        
                        const apiUrl = localStorage.getItem('apiUrl') || '';
                        const apiKey = localStorage.getItem('apiKey') || '';
                        const modelName = localStorage.getItem('model') || localStorage.getItem('selectedModel') || 'gpt-3.5-turbo';
                        
                        if (!apiUrl || !apiKey) return;
                        
                        try {
                            const prohibition = 'ä¸è¦ä»¥ä»»ä½•æ–¹å¼æåŠä½ æ˜¯ AIã€æ¨¡å‹ã€ç³»ç»Ÿæç¤ºè¯ã€å†…éƒ¨è®¾ç½®æˆ–å¼€å‘è€…æŒ‡ä»¤ï¼›ä¸è¦åœ¨å›å¤ä¸­å‡ºç°æ‹¬å·å†…çš„è‡ªæˆ‘è¯´æ˜æˆ–åˆè§„è¯æ˜ï¼›ä»¥ç¬¬ä¸€äººç§°è‡ªç„¶åœ°è¡¨è¾¾ã€‚';
                            const commentUrl = buildApiUrl(apiUrl);
                            const response = await fetch(commentUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify({
                                    model: modelName,
                                    messages: [
                                        {
                                            role: 'system',
                                            content: prohibition + `\nä½ æ˜¯${role.name}ã€‚ä½ çš„äººè®¾ï¼š${role.personality || 'ä¸€ä¸ªæ™®é€šç”¨æˆ·'}ã€‚ç°åœ¨ä½ çœ‹åˆ°äº†æœ‹å‹å‘çš„åŠ¨æ€ï¼Œéœ€è¦è¯„è®ºã€‚è¯·æ ¹æ®ä½ çš„äººè®¾å’ŒåŠ¨æ€å†…å®¹ï¼Œç»™å‡ºä¸€å¥çœŸå®è‡ªç„¶çš„è¯„è®ºï¼Œè¦ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹ã€‚å¯ä»¥æ˜¯ç®€çŸ­çš„å‡ ä¸ªå­—ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸¤å¥è¯ï¼Œæ€ä¹ˆè‡ªç„¶æ€ä¹ˆæ¥ã€‚åªè¾“å‡ºè¯„è®ºå†…å®¹ï¼Œä¸è¦æœ‰å¼•å·æˆ–å…¶ä»–æ ‡è®°ã€‚`
                                        },
                                        {
                                            role: 'user',
                                            content: `åŠ¨æ€å†…å®¹ï¼š${moment.content}${moment.hasImage ? '\nï¼ˆå¸¦å›¾ç‰‡ï¼‰' : ''}`
                                        }
                                    ],
                                    temperature: 0.9,
                                    max_tokens: 80
                                })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                let comment = data.choices[0].message.content.trim();
                                comment = comment.replace(/\(.*?\)/g, '').replace(/\[.*?\]/g, '').trim();

                                // é‡æ–°è¯»å–æœ€æ–°æ•°æ®
                                moments = JSON.parse(localStorage.getItem('moments') || '[]');
                                const latestMoment = moments.find(m => m.id === momentId);
                                if (latestMoment) {
                                    if (!latestMoment.comments) latestMoment.comments = [];
                                    latestMoment.comments.push({
                                        userName: role.name,
                                        text: comment,
                                        timestamp: Date.now()
                                    });
                                    localStorage.setItem('moments', JSON.stringify(moments));
                                    loadMomentList();
                                }
                            } else {
                                const txt = await response.text().catch(() => '');
                                console.error('ç”Ÿæˆè¯„è®ºå¤±è´¥: HTTP', response.status, txt.substring(0,200));
                            }
                        } catch (error) {
                            console.error('ç”Ÿæˆè¯„è®ºå¤±è´¥:', error);
                        }
                    }
                }, delay);
            });
        }
        
        // è§’è‰²è‡ªåŠ¨å‘å¸ƒåŠ¨æ€
        async function rolePostMoment() {
            // æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è§’è‰²åå°æ´»åŠ¨
            const backgroundActivity = localStorage.getItem('background_activity') === 'true';
            if (!backgroundActivity) return;
            
            const roles = JSON.parse(localStorage.getItem('roles') || '[]');
            if (roles.length === 0) return;
            
            const role = roles[Math.floor(Math.random() * roles.length)];
            
            const apiUrl = localStorage.getItem('apiUrl') || '';
            const apiKey = localStorage.getItem('apiKey') || '';
            const modelName = localStorage.getItem('model') || localStorage.getItem('selectedModel') || 'gpt-3.5-turbo';
            
            if (!apiUrl || !apiKey) return;
            
            // è·å–è¯¥è§’è‰²æœ€è¿‘çš„èŠå¤©è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
            const chatHistory = JSON.parse(localStorage.getItem(`chat_${role.id}`) || '[]');
            const recentChats = chatHistory.slice(-5).map(msg => `${msg.sender}: ${msg.text}`).join('\n');
            const contextHint = recentChats ? `\n\næœ€è¿‘ä½ ä»¬çš„èŠå¤©å†…å®¹ï¼š\n${recentChats}\n\nä½ å¯ä»¥ç»“åˆæœ€è¿‘çš„èŠå¤©å†…å®¹å‘åŠ¨æ€ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ã€‚` : '';
            
            try {
                const postUrl = buildApiUrl(apiUrl);
                const response = await fetch(postUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelName,
                        messages: [
                            {
                                role: 'system',
                                content: `ä½ æ˜¯${role.name}ã€‚ä½ çš„äººè®¾ï¼š${role.personality || 'ä¸€ä¸ªæ™®é€šç”¨æˆ·'}ã€‚ç°åœ¨ä½ æƒ³å‘ä¸€æ¡æœ‹å‹åœˆåŠ¨æ€ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œåˆ›ä½œä¸€æ¡çœŸå®è‡ªç„¶çš„åŠ¨æ€å†…å®¹ï¼Œè¦ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹ã€‚å¯ä»¥æ˜¯åˆ†äº«å¿ƒæƒ…ã€æ—¥å¸¸ã€æ„Ÿæ‚Ÿç­‰ï¼Œé•¿çŸ­éšæ„ï¼Œæ€ä¹ˆè‡ªç„¶æ€ä¹ˆæ¥ã€‚åªè¾“å‡ºåŠ¨æ€å†…å®¹ï¼Œä¸è¦æœ‰å¼•å·æˆ–å…¶ä»–æ ‡è®°ã€‚${contextHint}`
                            },
                            {
                                role: 'user',
                                content: 'è¯·å‘å¸ƒä¸€æ¡åŠ¨æ€'
                            }
                        ],
                        temperature: 0.9,
                        max_tokens: 150
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = data.choices[0].message.content.trim();
                    const hasImage = Math.random() < 0.2; // 20%æ¦‚ç‡å¸¦å›¾

                    // åŠ¨æ€é»˜è®¤å¤´åƒï¼šä¼˜å…ˆä½¿ç”¨è¯¥è§’è‰²åœ¨èŠå¤©ä¸­çš„å¤´åƒè®¾ç½®ï¼ˆchat_ai_avatar_urlï¼‰ï¼Œå…¶æ¬¡ä½¿ç”¨ role.avatarï¼Œå†fallbackåˆ°é€šç”¨å›¾åƒ
                    const chatAvatar = localStorage.getItem('chat_ai_avatar_url') || '';
                    const momentAvatar = chatAvatar || role.avatar || 'https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg';
                    const moment = {
                        id: Date.now(),
                        content: content,
                        hasImage: hasImage,
                        imageDescription: hasImage ? `${role.name}çš„åˆ†äº«` : '',
                        timestamp: Date.now(),
                        userName: role.name,
                        userAvatar: momentAvatar,
                        likes: [],
                        comments: []
                    };

                    let moments = JSON.parse(localStorage.getItem('moments') || '[]');
                    moments.unshift(moment);
                    localStorage.setItem('moments', JSON.stringify(moments));

                    loadMomentList();

                    // æœ‰ä¸€å®šæ¦‚ç‡è·å¾—å…¶ä»–è§’è‰²çš„ååº”ï¼ˆ40%æ¦‚ç‡ï¼‰
                    if (Math.random() < 0.4) {
                        setTimeout(() => {
                            triggerRoleReactions(moment.id);
                        }, Math.random() * 10000 + 5000);
                    }
                } else {
                    const txt = await response.text().catch(() => '');
                    console.error('ç”ŸæˆåŠ¨æ€å¤±è´¥: HTTP', response.status, txt.substring(0,200));
                }
            } catch (error) {
                console.error('ç”ŸæˆåŠ¨æ€å¤±è´¥:', error);
            }
        }

        // æ ¹æ®è§’è‰²äººè®¾å’Œä¸Šä¸‹æ–‡åˆ›å»ºåŠ¨æ€ï¼ˆä¸ä¼šåœ¨èŠå¤©ä¸­ç›´æ¥æ˜¾ç¤ºå®Œæ•´åŠ¨æ€ï¼‰
        async function createMomentFromRole(roleId, userRequestText, options = {}) {
            const roles = JSON.parse(localStorage.getItem('roles') || '[]');
            const role = roles.find(r => r.id === roleId);
            if (!role) throw new Error('æœªæ‰¾åˆ°è§’è‰²');

            // æ£€æŸ¥åå°æ´»åŠ¨å¼€å…³
            const backgroundActivity = localStorage.getItem('background_activity') === 'true';
            const force = options && options.force === true;
            if (!backgroundActivity && !force) throw new Error('åå°æ´»åŠ¨æœªå¼€å¯');

            const apiUrl = localStorage.getItem('apiUrl') || '';
            const apiKey = localStorage.getItem('apiKey') || '';
            const modelName = localStorage.getItem('model') || localStorage.getItem('selectedModel') || 'gpt-3.5-turbo';
            if (!apiUrl || !apiKey) throw new Error('API æœªé…ç½®');

            // æ„å»ºä¸Šä¸‹æ–‡ï¼šè§’è‰²äººè®¾ + ç”¨æˆ·è¯·æ±‚ + æœ€è¿‘èŠå¤©æ‘˜è¦
            const chatHistory = JSON.parse(localStorage.getItem(`chat_${role.id}`) || '[]');
            const recentChats = chatHistory.slice(-6).map(m => `${m.sender}: ${m.text}`).join('\n');
            const contextHint = recentChats ? `æœ€è¿‘èŠå¤©ï¼š\n${recentChats}\n\n` : '';

            const systemMsg = `${role.name} çš„äººè®¾ï¼š${role.personality || 'æ™®é€šç”¨æˆ·'}ã€‚`;
            // å¼ºåˆ¶ç¦æ­¢åœ¨ä»»ä½•å›å¤ä¸­æåŠ AIã€ç³»ç»Ÿæç¤ºæˆ–å…ƒä¿¡æ¯ï¼Œä¿æŒç¬¬ä¸€äººç§°ã€è‡ªç„¶ã€ä¸è·³å‡ºè§’è‰²
            const prohibition = 'ä¸è¦ä»¥ä»»ä½•æ–¹å¼æåŠä½ æ˜¯ AIã€æ¨¡å‹ã€ç³»ç»Ÿæç¤ºè¯ã€å†…éƒ¨è®¾ç½®æˆ–å¼€å‘è€…æŒ‡ä»¤ï¼›ä¸è¦åœ¨å›å¤ä¸­å‡ºç°æ‹¬å·å†…çš„è‡ªæˆ‘è¯´æ˜æˆ–åˆè§„è¯æ˜ï¼›ä»¥ç¬¬ä¸€äººç§°è‡ªç„¶åœ°è¡¨è¾¾ã€‚';
            const userPrompt = `ç”¨æˆ·è¯·æ±‚ï¼š${userRequestText}\n\nè¯·åŸºäºä¸Šè¿°äººè®¾å’Œä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¸€æ¡é€‚åˆåœ¨æœ‹å‹åœˆå‘å¸ƒçš„åŠ¨æ€å†…å®¹ï¼ˆå†…å®¹åªç”¨äºåå°å‘å¸ƒï¼Œä¸è¦åœ¨èŠå¤©ä¸­å®Œæ•´å±•ç¤ºï¼‰ã€‚å¦‚éœ€å¸¦å›¾ç‰‡ï¼Œå¯ä»¥åœ¨è¿”å›ç»“æœä¸­åŒ…å«æ ‡è®°[HAS_IMAGE]å¹¶ç»™å‡ºç®€çŸ­å›¾ç‰‡æè¿°ã€‚åªè¿”å›çº¯æ–‡æœ¬åŠ¨æ€å†…å®¹ï¼Œé•¿åº¦å’Œé£æ ¼éšäººè®¾è€Œå®šã€‚`;

            function buildApiUrl(base) {
                if (!base) return base;
                // å¦‚æœå·²ç»åŒ…å« chat/completions æˆ– v1/chat/completionsï¼Œåˆ™ç›´æ¥ä½¿ç”¨
                const lower = base.toLowerCase();
                if (lower.includes('/chat/completions') || lower.includes('/v1/chat/completions')) return base;
                if (base.endsWith('/')) return base + 'chat/completions';
                return base + '/v1/chat/completions';
            }
            const fullUrl = buildApiUrl(apiUrl);

            const resp = await fetch(fullUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: modelName,
                    messages: [
                        { role: 'system', content: prohibition + '\n' + systemMsg + '\n' + contextHint },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: 0.9,
                    max_tokens: 200
                })
            });

            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                throw new Error(`ç”ŸæˆåŠ¨æ€å¤±è´¥ (çŠ¶æ€ ${resp.status}) ${text.substring(0,200)}`);
            }

            const data = await resp.json();
            let content = data.choices?.[0]?.message?.content || '';
            content = content.trim();
            // å…ˆå°è¯•è§£æ [HAS_IMAGE] æ ‡è®°ï¼ˆæ¨¡å‹çº¦å®šï¼‰
            let hasImage = content.includes('[HAS_IMAGE]');
            let imageDescription = '';
            if (hasImage) {
                const parts = content.split('[HAS_IMAGE]');
                content = parts[0].trim();
                imageDescription = (parts[1] || '').trim();
            }

            // æ¸…ç†å¯èƒ½çš„å…ƒä¿¡æ¯æˆ–æ‹¬å·æ³¨é‡Šï¼ˆåœ¨æå–å›¾ç‰‡æè¿°åæ‰§è¡Œï¼‰
            content = content.replace(/\(.*?\)/g, '').replace(/\[.*?\]/g, '').trim();

            // å¦‚æœç”¨æˆ·æ˜ç¡®è¦æ±‚å¸¦å›¾ï¼ˆforceImageï¼‰ï¼Œä½†æ¨¡å‹æ²¡æœ‰æä¾›å›¾ç‰‡æ ‡è®°ï¼Œåˆ™å¼ºåˆ¶å¸¦å›¾å¹¶æä¾›å ä½æè¿°
            const forceImage = options && options.forceImage === true;
            if (forceImage && !hasImage) {
                hasImage = true;
                imageDescription = imageDescription || `${role.name} çš„ç…§ç‰‡`;
            }

            // åŠ¨æ€é»˜è®¤å¤´åƒæ”¹ä¸ºä½¿ç”¨èŠå¤©ç•Œé¢å¤´åƒä¼˜å…ˆï¼Œå…¶æ¬¡ role.avatarï¼Œå† fallback
            const chatAvatar2 = localStorage.getItem('chat_ai_avatar_url') || '';
            const momentAvatar2 = chatAvatar2 || role.avatar || localStorage.getItem('moment_avatar') || 'https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg';
            const moment = {
                id: Date.now(),
                content: content,
                hasImage: hasImage,
                imageDescription: imageDescription || (hasImage ? 'åˆ†äº«å›¾ç‰‡' : ''),
                timestamp: Date.now(),
                userName: role.name,
                userAvatar: momentAvatar2,
                likes: [],
                comments: []
            };

            let moments = JSON.parse(localStorage.getItem('moments') || '[]');
            moments.unshift(moment);
            localStorage.setItem('moments', JSON.stringify(moments));

            // è§¦å‘åç»­ååº”ï¼ˆéå³æ—¶ï¼‰ï¼Œå¦‚ç‚¹èµå’Œè¯„è®º
            setTimeout(() => triggerRoleReactions(moment.id), Math.random() * 8000 + 3000);

            return moment;
        }
        
        // å°†æ¨¡å‹ç”Ÿæˆçš„æ–‡æœ¬ä¿å­˜ä¸ºåŠ¨æ€ï¼ˆç”¨äºæ‹¦æˆªæ¨¡å‹åœ¨èŠå¤©ä¸­è¾“å‡ºçš„â€œå·²å‘å¸ƒ/æˆ‘å‘äº†â€ä¹‹ç±»æ–‡æœ¬ï¼‰
        async function saveMomentFromGeneratedText(roleId, generatedText, options = {}) {
            const rolesList = JSON.parse(localStorage.getItem('roles') || '[]');
            const role = rolesList.find(r => r.id === roleId);
            if (!role) throw new Error('æœªæ‰¾åˆ°è§’è‰²');

            let content = (generatedText || '').trim();
            // ä¼˜å…ˆè§£ææ¨¡å‹çº¦å®šçš„ [HAS_IMAGE] æ ‡è®°ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            let hasImage = false;
            let imageDescription = '';
            const hasImageMatch = content.match(/\[has_image\](.*)$/i);
            if (hasImageMatch) {
                hasImage = true;
                imageDescription = (hasImageMatch[1] || '').trim();
                content = content.replace(/\[has_image\].*$/i, '').trim();
            }

            // æ¸…ç†å¯èƒ½çš„å…ƒä¿¡æ¯æˆ–æ‹¬å·æ³¨é‡Š
            content = content.replace(/\(.*?\)/g, '').replace(/\[.*?\]/g, '').trim();

            const forceImage = options && options.forceImage === true;
            if (forceImage && !hasImage) {
                hasImage = true;
                imageDescription = imageDescription || `${role.name} çš„ç…§ç‰‡`;
            }

            const chatAvatar = localStorage.getItem('chat_ai_avatar_url') || '';
            const momentAvatar = chatAvatar || role.avatar || localStorage.getItem('moment_avatar') || 'https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg';

            const moment = {
                id: Date.now(),
                content: content || 'åˆ†äº«ä¸€æ¡åŠ¨æ€',
                hasImage: !!hasImage,
                imageDescription: imageDescription || (hasImage ? 'åˆ†äº«å›¾ç‰‡' : ''),
                timestamp: Date.now(),
                userName: role.name,
                userAvatar: momentAvatar,
                likes: [],
                comments: []
            };

            let moments = JSON.parse(localStorage.getItem('moments') || '[]');
            moments.unshift(moment);
            localStorage.setItem('moments', JSON.stringify(moments));
            try { loadMomentList(); } catch (e) { /* ignore */ }

            // è§¦å‘å…¶ä»–è§’è‰²çš„ååº”
            setTimeout(() => triggerRoleReactions(moment.id), Math.random() * 8000 + 3000);
            return moment;
        }
        
        // å®šæœŸè®©è§’è‰²å‘å¸ƒåŠ¨æ€
        setInterval(() => {
            // æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è§’è‰²åå°æ´»åŠ¨
            const backgroundActivity = localStorage.getItem('background_activity') === 'true';
            if (!backgroundActivity) return;
            
            const roles = JSON.parse(localStorage.getItem('roles') || '[]');
            if (roles.length > 0 && Math.random() < 0.15) { // 15%æ¦‚ç‡å‘å¸ƒï¼Œæ›´çœŸå®
                rolePostMoment();
            }
        }, 120000); // æ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

        // ===== è®°å¿†æ€»ç»“åŠŸèƒ½ =====
        
        // æ˜¾ç¤ºè®°å¿†æ€»ç»“æ¨¡æ€æ¡†
        function showMemorySummary() {
            if (!currentRoleId) {
                showPhoneAlert('è¯·å…ˆè¿›å…¥èŠå¤©');
                return;
            }
            
            const modal = document.getElementById('memorySummaryModal');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.pointerEvents = 'auto';
            
            // åŠ è½½å·²æœ‰çš„è®°å¿†æ€»ç»“æˆ–ç”Ÿæˆæ–°çš„
            loadMemorySummary();
        }
        
        // å…³é—­è®°å¿†æ€»ç»“æ¨¡æ€æ¡†
        function closeMemorySummary() {
            const modal = document.getElementById('memorySummaryModal');
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            modal.style.pointerEvents = 'none';
        }
        
        // åŠ è½½è®°å¿†æ€»ç»“
        function loadMemorySummary() {
            if (!currentRoleId) return;
            
            const role = roles.find(r => r.id === currentRoleId);
            if (!role) return;
            
            const summaryKey = `memory_summary_${currentRoleId}`;
            const savedSummary = localStorage.getItem(summaryKey);
            const contentDiv = document.getElementById('memorySummaryContent');
            
            if (savedSummary) {
                contentDiv.innerHTML = `<p style="white-space: pre-wrap;">${savedSummary}</p>`;
            } else {
                contentDiv.innerHTML = '<p style="text-align: center; color: #999;">æš‚æ— è®°å¿†æ€»ç»“ï¼Œç‚¹å‡»"é‡æ–°ç”Ÿæˆ"åˆ›å»º</p>';
            }
        }
        
        // ç”Ÿæˆè®°å¿†æ€»ç»“
        async function generateMemorySummary() {
            if (!currentRoleId) {
                showPhoneAlert('è¯·å…ˆè¿›å…¥èŠå¤©');
                return;
            }
            
            const role = roles.find(r => r.id === currentRoleId);
            if (!role) {
                showPhoneAlert('è§’è‰²ä¸å­˜åœ¨');
                return;
            }
            
            const apiUrl = localStorage.getItem('apiUrl');
            const apiKey = localStorage.getItem('apiKey');
            
            if (!apiUrl || !apiKey) {
                showPhoneAlert('è¯·å…ˆé…ç½®APIè®¾ç½®');
                return;
            }
            
            // è·å–èŠå¤©å†å²
            const historyKey = `chat_history_${currentRoleId}`;
            const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
            
            if (history.length === 0) {
                showPhoneAlert('æš‚æ— èŠå¤©è®°å½•');
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·è®¾ç½®çš„è‡ªåŠ¨æ€»ç»“é—´éš”æ¥å†³å®šæ€»ç»“å¤šå°‘æ¡æ¶ˆæ¯
            const summaryInterval = role.autoSummarizeInterval || 20;
            const messagesToSummarize = history.slice(-summaryInterval);
            
            // æ„å»ºå¯¹è¯æ–‡æœ¬
            const conversationText = messagesToSummarize.map(msg => {
                const sender = msg.sender === 'user' ? 'ç”¨æˆ·' : role.name;
                return `${sender}: ${msg.text}`;
            }).join('\n');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const contentDiv = document.getElementById('memorySummaryContent');
            contentDiv.innerHTML = '<p style="text-align: center; color: #007aff;">â³ æ­£åœ¨ç”Ÿæˆè®°å¿†æ€»ç»“...</p>';
            
            try {
                const fullUrl = (apiUrl.endsWith('/')) ? `${apiUrl}chat/completions` : `${apiUrl}/v1/chat/completions`;
                
                const summaryPrompt = `è¯·å¯¹ä»¥ä¸‹å¯¹è¯è¿›è¡Œç®€æ˜æ‰¼è¦çš„æ€»ç»“ï¼Œæå–å…³é”®ä¿¡æ¯å’Œé‡è¦ç»†èŠ‚ï¼š\n\n${conversationText}\n\nè¯·ç”¨2-3æ®µè¯æ€»ç»“å¯¹è¯çš„ä¸»è¦å†…å®¹ã€æƒ…æ„ŸåŸºè°ƒå’Œé‡è¦ä¿¡æ¯ç‚¹ã€‚`;
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: role.model,
                        messages: [
                            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¯¹è¯æ€»ç»“åŠ©æ‰‹ï¼Œæ“…é•¿æå–å¯¹è¯çš„æ ¸å¿ƒä¿¡æ¯ã€‚' },
                            { role: 'user', content: summaryPrompt }
                        ],
                        temperature: 0.5
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                const summary = result.choices?.[0]?.message?.content || 'æ€»ç»“ç”Ÿæˆå¤±è´¥';
                
                // ä¿å­˜æ€»ç»“
                const summaryKey = `memory_summary_${currentRoleId}`;
                localStorage.setItem(summaryKey, summary);
                
                // æ˜¾ç¤ºæ€»ç»“
                contentDiv.innerHTML = `<p style="white-space: pre-wrap;">${summary}</p>`;
                showPhoneAlert('è®°å¿†æ€»ç»“å·²ç”Ÿæˆ');
                
            } catch (error) {
                console.error('ç”Ÿæˆè®°å¿†æ€»ç»“å¤±è´¥:', error);
                contentDiv.innerHTML = '<p style="text-align: center; color: #dc3545;">âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIè®¾ç½®</p>';
                showPhoneAlert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ===== ä¸–ç•Œä¹¦åŠŸèƒ½ =====
        
        // æ˜¾ç¤ºåˆ›å»ºä¸–ç•Œä¹¦æ¨¡æ€æ¡†
        function showCreateWorldbookModal() {
            const modal = document.getElementById('createWorldbookModal');
            document.getElementById('worldbookNameInput').value = '';
            modal.style.display = 'flex';
            modal.classList.add('is-active');
        }

        // å…³é—­åˆ›å»ºä¸–ç•Œä¹¦æ¨¡æ€æ¡†
        function closeCreateWorldbookModal() {
            const modal = document.getElementById('createWorldbookModal');
            modal.classList.remove('is-active');
            setTimeout(() => {
                if (!modal.classList.contains('is-active')) {
                    modal.style.display = 'none';
                }
            }, 100);
        }

        // åˆ›å»ºä¸–ç•Œä¹¦
        function createWorldbook() {
            const name = document.getElementById('worldbookNameInput').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥ä¸–ç•Œä¹¦åç§°ï¼');
                return;
            }

            const newWorldbook = {
                id: Date.now(),
                name: name,
                content: []
            };

            worldbooks.push(newWorldbook);
            localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
            alert(`ä¸–ç•Œä¹¦ "${name}" å·²åˆ›å»ºï¼`);
            closeCreateWorldbookModal();
            loadWorldbookList();
        }

        // åŠ è½½ä¸–ç•Œä¹¦åˆ—è¡¨
        function loadWorldbookList() {
            const listDiv = document.getElementById('worldbookList');
            worldbooks = JSON.parse(localStorage.getItem('worldbooks') || '[]');
            listDiv.innerHTML = '';

            if (worldbooks.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #888; margin-top: 50px;">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• åˆ›å»ºã€‚</div>';
                return;
            }

            worldbooks.forEach(worldbook => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.style.cursor = 'pointer';
                card.onclick = function() {
                    currentWorldbookId = worldbook.id;
                    showApp('worldbookDetail');
                };

                const avatar = document.createElement('div');
                avatar.className = 'role-avatar';
                avatar.textContent = worldbook.name[0].toUpperCase();

                const info = document.createElement('div');
                info.className = 'role-info';
                info.innerHTML = `<h3>${worldbook.name}</h3>
                                  <p>${worldbook.content.length} æ¡å†…å®¹</p>`;

                card.appendChild(avatar);
                card.appendChild(info);
                listDiv.appendChild(card);
            });
        }

        // åŠ è½½ä¸–ç•Œä¹¦è¯¦æƒ…
        function loadWorldbookDetail() {
            const worldbook = worldbooks.find(w => w.id === currentWorldbookId);
            if (!worldbook) {
                alert('ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼');
                showApp('worldbook');
                return;
            }

            document.getElementById('worldbookDetailTitle').textContent = worldbook.name;
            const contentDiv = document.getElementById('worldbookContentList');
            contentDiv.innerHTML = '';

            if (worldbook.content.length === 0) {
                contentDiv.innerHTML = '<p style="text-align: center; color: #999; margin-top: 20px;">æš‚æ— å†…å®¹ï¼Œç‚¹å‡»ä¸‹æ–¹"æ·»åŠ å†…å®¹"æŒ‰é’®æ·»åŠ ã€‚</p>';
                return;
            }

            worldbook.content.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'background-color: #f8f8f8; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #007aff; position: relative;';
                itemDiv.innerHTML = `<p style="margin: 0; white-space: pre-wrap; word-wrap: break-word; line-height: 1.5;">${item}</p>
                    <button onclick="deleteWorldbookContent(${index})" style="position: absolute; top: 8px; right: 8px; background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;">åˆ é™¤</button>`;
                contentDiv.appendChild(itemDiv);
            });
        }

        // æ˜¾ç¤ºæ·»åŠ å†…å®¹æ¨¡æ€æ¡†
        function showAddWorldbookContentModal() {
            const modal = document.getElementById('addWorldbookContentModal');
            document.getElementById('worldbookContentInput').value = '';
            modal.style.display = 'flex';
            modal.classList.add('is-active');
        }

        // å…³é—­æ·»åŠ å†…å®¹æ¨¡æ€æ¡†
        function closeAddWorldbookContentModal() {
            const modal = document.getElementById('addWorldbookContentModal');
            modal.classList.remove('is-active');
            setTimeout(() => {
                if (!modal.classList.contains('is-active')) {
                    modal.style.display = 'none';
                }
            }, 100);
        }

        // æ·»åŠ ä¸–ç•Œä¹¦å†…å®¹
        function addWorldbookContent() {
            const contentText = document.getElementById('worldbookContentInput').value.trim();
            if (!contentText) {
                alert('è¯·è¾“å…¥å†…å®¹ï¼');
                return;
            }

            const worldbook = worldbooks.find(w => w.id === currentWorldbookId);
            if (!worldbook) {
                alert('ä¸–ç•Œä¹¦ä¸å­˜åœ¨ï¼');
                return;
            }

            worldbook.content.push(contentText);
            localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
            alert('å†…å®¹å·²æ·»åŠ ï¼');
            closeAddWorldbookContentModal();
            loadWorldbookDetail();
        }

        // åˆ é™¤ä¸–ç•Œä¹¦å†…å®¹
        function deleteWorldbookContent(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†…å®¹å—ï¼Ÿ')) {
                const worldbook = worldbooks.find(w => w.id === currentWorldbookId);
                if (worldbook) {
                    worldbook.content.splice(index, 1);
                    localStorage.setItem('worldbooks', JSON.stringify(worldbooks));
                    loadWorldbookDetail();
                }
            }
        }

    </script>
</body>
</html>
