<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/Gh23VcVK/IMG-4878.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8f8f8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°æ‰‹æœº - AI èŠå¤©æ¨¡æ‹Ÿå™¨</title>
    
    <style>
        /* 1. æ‰‹æœºå¤–å£³å’Œå±…ä¸­ */
        body {
            display: flex; 
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 100vw;
        }

        /* 2. æ¨¡æ‹Ÿæ‰‹æœºå±å¹• */
        .phone-screen {
            width: 375px;
            height: 667px; 
            background-color: #f8f8f8;
            border: 1px solid #333; 
            border-radius: 40px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.2); 
            position: relative; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* åª’ä½“æŸ¥è¯¢ï¼šåœ¨å°å±å¹•ï¼ˆæ‰‹æœºï¼‰ä¸Šåº”ç”¨å…¨å±æ ·å¼ */
        @media screen and (max-width: 768px) {
            .phone-screen {
                width: 100vw;
                height: 100vh; 
                border: none; 
                border-radius: 0; 
                box-shadow: none; 
            }
        }

        /* éšè—çŠ¶æ€æ  */
        .status-bar.hidden {
            display: none;
        }

        /* 3. é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 30px;
            background-color: #f8f8f8;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            color: #333;
            border-bottom: 1px solid #ddd;
        }

        /* 4. å¤´éƒ¨å¯¼èˆª (Home/è¿”å›) */
        .header {
            height: 44px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
            z-index: 10;
            position: relative; 
            width: 100%;
            box-sizing: border-box;
        }
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            flex-grow: 1;
            text-align: center;
            margin: 0;
            padding: 0 50px;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .back-btn, .home-btn {
            font-size: 16px;
            color: #007aff;
            cursor: pointer;
            z-index: 20; 
            position: absolute; 
            left: 15px; 
            font-weight: 400;
        }
        
        /* 5. æ ¸å¿ƒå†…å®¹åŒºåŸŸ (appContainer) */
        .content {
            flex-grow: 1; 
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
            position: relative;
        }

        /* APPå±å¹•æ— paddingï¼Œé“ºæ»¡å°æ‰‹æœºå±å¹• */
        .content.app-mode {
            padding: 0;
            overflow: hidden;
        }

        /* ä¸»å±å¹•å›åˆ°æ­£å¸¸padding */
        .content.home-mode {
            padding: 20px;
            overflow-y: auto;
        }

        /* 6. ä¸»é¡µå›¾æ ‡ç½‘æ ¼ */
        .app-grid {
            display: flex;
            flex-wrap: wrap;
            padding-top: 20px;
        }
        .app-icon {
            width: 80px;
            height: 80px;
            margin: 10px;
            text-align: center;
            cursor: pointer;
        }
        .app-icon img {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .app-icon p {
            margin: 5px 0 0;
            font-size: 12px;
            color: #333;
        }

        /* 7. API è®¾ç½®é¡µé¢æ ·å¼ */
        .api-settings {
            flex-grow: 1;
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        .api-settings label {
            display: block;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        /* æ–°å¢/ä¿®å¤ï¼šAPI å†…å®¹åŒºåŸŸæ ·å¼ */
        .api-content {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 20px;
            background-color: #fff; 
        }
        .api-settings input[type="text"], .api-settings input[type="password"], .api-settings select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .save-btn {
            width: 100%;
            padding: 12px;
            margin-top: 25px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .save-btn:hover {
            background-color: #0056b3;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            background-color: #f0f0f0;
        }
        .api-content textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            resize: none;
        }
        
        /* 8. èŠå¤©/è§’è‰²åˆ—è¡¨é¡µé¢æ ·å¼ */
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column; 
            overflow: hidden;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f8f8;
        }
        .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #fff;
        }
        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 16px;
        }
        .chat-input-area button {
            padding: 10px 20px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        .chat-input-area button:disabled {
            background-color: #a0c4ff;
            cursor: default;
        }

        /* 9. æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
        .message-bubble {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        
        .message-bubble.sent {
            justify-content: flex-end;
        }
        
        .message-bubble.received {
            justify-content: flex-start;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message {
            max-width: 65%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message.sent {
            background-color: #007aff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            background-color: #e5e5ea;
            color: black;
            border-bottom-left-radius: 4px;
        }
        .message.thinking {
            background-color: #ffe0b2;
            color: #333;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1.0; }
            100% { opacity: 0.6; }
        }
        
        /* 10. è§’è‰²åˆ—è¡¨å’ŒæŒ‰é’®æ ·å¼ */
        .add-model-btn {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .add-role-btn {
            font-size: 24px;
            color: #007aff;
            cursor: pointer;
            z-index: 20;
            position: absolute;
            right: 15px;
            font-weight: 400;
        }
        .role-list-content {
            padding: 0;
            background-color: #fff;
        }
        .role-card {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .role-card:active {
            background-color: #f0f0f0;
        }
        .role-avatar {
            width: 45px;
            height: 45px;
            background-color: #007aff;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin-right: 15px;
        }
        .role-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .role-info p {
            margin: 2px 0 0;
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }

        /* 11. è§’è‰²æ“ä½œå¼¹å‡ºèœå•æ ·å¼ (ä¿®å¤ Z-Index å’Œå®šä½) */
        #roleActionMenu {
            position: absolute; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            /* å…³é”®ä¿®å¤ï¼šé»˜è®¤éšè—ï¼Œä¸å“åº”ç‚¹å‡» */
            visibility: hidden;
            pointer-events: none; 
            background: rgba(0, 0, 0, 0.4); 
        }
        /* å½“ JS æ¿€æ´»æ—¶ï¼Œæ¢å¤å¯è§æ€§å’Œç‚¹å‡» */
        #roleActionMenu.is-active {
            visibility: visible !important;
            pointer-events: auto !important; 
        }

        .menu-content {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 15px;
            z-index: 1001;
            transition: bottom 0.3s ease-out;
            margin-bottom: 20px;
        }
        .menu-content button {
            width: 100%;
            padding: 15px;
            margin-bottom: 8px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: white;
            color: #007aff;
        }
        .menu-content button#deleteRoleBtn {
            color: #dc3545;
        }
        .menu-content button#clearHistoryBtn {
            color: #ff9500;
        }

        /* 12. èŠå¤©è®¾ç½®æ¨¡æ€æ¡† */
        #avatarSettingsModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            pointer-events: none;
        }

        #avatarSettingsModal.is-active {
            display: flex !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        .avatar-modal-content {
            background: white;
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 320px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 5px 40px rgba(0, 0, 0, 0.3);
        }

        .avatar-modal-content h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .settings-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .settings-tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: color 0.3s;
        }

        .settings-tab-btn.active {
            color: #007aff;
            border-bottom-color: #007aff;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        .avatar-section {
            margin-bottom: 20px;
        }

        .avatar-section label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ddd;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            overflow: hidden;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-section input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .avatar-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .avatar-modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .avatar-modal-buttons button.save {
            background-color: #007aff;
            color: white;
        }

        .avatar-modal-buttons button.cancel {
            background-color: #f0f0f0;
            color: #333;
        }
    </style>
</head>
<body>

    <div class="phone-screen">
        <div class="status-bar">
            <span id="statusTime">9:41 AM</span>
            <span>LTE</span>
            <span>ğŸ”‹ 100%</span>
        </div>

        <div id="appContainer" class="content">
            
            <div id="homeScreen">
                <div class="app-grid">
                    <div class="app-icon" onclick="showApp('api')">
                        <img src="https://img.icons8.com/color/96/key.png" alt="API Key Icon" data-app="api">
                        <p>API</p>
                    </div>
                    <div class="app-icon" onclick="showApp('chat')">
                        <img src="https://img.icons8.com/color/96/speech-bubble--v1.png" alt="èŠå¤©å›¾æ ‡" data-app="chat">
                        <p>èŠå¤©</p>
                    </div>
                    <div class="app-icon" onclick="showApp('beautify')">
                        <img src="https://img.icons8.com/color/96/paint-palette.png" alt="ç¾åŒ–å›¾æ ‡" data-app="beautifyApp">
                        <p>ç¾åŒ–</p>
                    </div>
                </div>
            </div>

            <div id="apiScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>API è®¾ç½®</h1>
                </div>
                <div class="api-content"> 
                    <label for="apiUrl">åä»£åœ°å€ (URL):</label>
                    <input type="text" id="apiUrl" placeholder="ä¾‹å¦‚: https://gcli.ggchan.dev">

                    <label for="apiKey">API å¯†é’¥ (Key):</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„ Key">
                    
                    <button class="save-btn" onclick="fetchModelsAndSave()">æ‹‰å–æ¨¡å‹å¹¶ä¿å­˜</button> 

                    <div id="modelSelectionArea" style="display: none; margin-top: 20px;">
                        <label for="modelSelect">é€‰æ‹©æ¨¡å‹:</label>
                        <select id="modelSelect">
                            <option value="">è¯·å…ˆæ‹‰å–æ¨¡å‹...</option>
                        </select>
                        
                        <label for="customModelInput" style="margin-top: 20px;">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°:</label>
                        <input type="text" id="customModelInput" placeholder="ä¾‹å¦‚: gemini-2.5-flash">
                        <button class="add-model-btn" onclick="addCustomModel()">æ·»åŠ å¹¶ä½¿ç”¨</button>
                    </div>

                    <div id="apiStatus" class="status-message" style="margin-top: 20px;">
                        å½“å‰çŠ¶æ€: æœªé…ç½®
                    </div>
                </div>
            </div>

            <div id="beautifyScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>ç¾åŒ–</h1>
                </div>
                <div class="api-content">
                    <label for="backgroundUrl">æ‰‹æœºèƒŒæ™¯å›¾ç‰‡ URL:</label>
                    <input type="text" id="backgroundUrl" placeholder="ä¾‹å¦‚: https://example.com/bg.jpg">

                    <label for="targetAppSelect">é€‰æ‹©è¦æ›¿æ¢çš„å›¾æ ‡:</label>
                    <select id="targetAppSelect">
                        <option value="home-bg">æ‰‹æœºèƒŒæ™¯</option>
                        <option value="api">API å›¾æ ‡</option>
                        <option value="chat">èŠå¤© å›¾æ ‡</option>
                        <option value="beautifyApp">ç¾åŒ– APP å›¾æ ‡</option>
                    </select>

                    <label for="iconUrl" style="margin-top: 15px;">å›¾æ ‡å›¾ç‰‡ URL:</label>
                    <input type="text" id="iconUrl" placeholder="ä¾‹å¦‚: https://example.com/icon.png">

                    <div style="margin-top: 15px; display:flex; gap:10px; align-items:center;">
                        <button class="save-btn" onclick="applyAndSaveBeautify()">åº”ç”¨å¹¶ä¿å­˜</button>
                        <button class="save-btn" style="background:#6c757d;" onclick="previewBeautify(true)">é¢„è§ˆ</button>
                        <button class="save-btn" style="background:#adb5bd;" onclick="previewBeautify(false)">å–æ¶ˆé¢„è§ˆ</button>
                    </div>

                    <div id="beautifyPreview" style="margin-top:20px; display:flex; gap:12px; align-items:center;">
                        <div style="flex:1">
                            <div style="font-weight:600; margin-bottom:6px;">é¢„è§ˆ</div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <img id="previewIcon" src="" style="width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid #ddd;display:none;">
                                <div id="previewText" style="color:#666;">åœ¨æ­¤æ˜¾ç¤ºé¢„è§ˆ</div>
                            </div>
                        </div>
                    </div>
                    <div id="beautifyStatus" class="status-message" style="margin-top:20px;">å½“å‰çŠ¶æ€: æœªä¿å­˜</div>
                </div>
            </div>

            <div id="roleListScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showHomeScreen()">è¿”å›</span>
                    <h1>æ¶ˆæ¯</h1>
                    <span class="add-role-btn" onclick="showApp('roleManager')">â•</span> </div>
                
                <div id="roleList" class="content role-list-content">
                    <div style="text-align: center; color: #888; margin-top: 50px;">
                        æš‚æ— è§’è‰²ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ã€‚ </div>
                </div>
            </div>

            <div id="roleManagerScreen" class="api-settings" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1>ç®¡ç†è§’è‰²</h1>
                </div>
                <div class="api-content">
                    <label for="roleName">è§’è‰²åç§°:</label>
                    <input type="text" id="roleName" placeholder="ä¾‹å¦‚: å†·é™çš„å®¢æœæœºå™¨äºº">

                    <label for="systemPrompt">ç³»ç»Ÿæç¤ºè¯ (Prompt):</label>
                    <textarea id="systemPrompt" rows="5" placeholder="ä¾‹å¦‚: ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€å†·é™çš„å®¢æœã€‚è¯·ç®€æ´åœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚"></textarea>

                    <label for="roleModelSelect">é€‰æ‹©æ¨¡å‹:</label>
                    <select id="roleModelSelect">
                        </select>
                    
                    <button class="save-btn" onclick="saveRole()">ä¿å­˜è§’è‰²</button> 
                    <button class="delete-btn" onclick="deleteRole()" style="margin-top: 10px; background-color: #dc3545;">åˆ é™¤è§’è‰²</button> 
                </div>
            </div>

            <div id="chatDetailScreen" class="chat-container" style="display:none;">
                <div class="header">
                    <span class="back-btn" onclick="showApp('roleList')">è¿”å›</span>
                    <h1 id="chatDetailTitle">è§’è‰²åç§°</h1>
                    <span style="font-size: 20px; color: #007aff; cursor: pointer; z-index: 20; position: absolute; right: 15px; font-weight: 400;" onclick="showAvatarSettings()">âš™ï¸</span> </div>
                <div id="chatMessages" class="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="text" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯...">
                    <button id="sendBtn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>

        </div> <div id="roleActionMenu" style="display: none;">
            <div id="menuContent" class="menu-content">
                <button id="clearHistoryBtn" onclick="confirmClearHistory()" style="color: #ff9500;">æ¸…ç©ºèŠå¤©è®°å½•</button>
                <button id="deleteRoleBtn" onclick="confirmDeleteRole()">åˆ é™¤è§’è‰²</button>
                <button onclick="hideRoleActionMenu()">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="avatarSettingsModal" style="display: none;">
            <div class="avatar-modal-content">
                <h3>èŠå¤©è®¾ç½®</h3>
                
                <div class="settings-tabs">
                    <button class="settings-tab-btn active" onclick="switchSettingsTab('avatar')">å¤´åƒ</button>
                    <button class="settings-tab-btn" onclick="switchSettingsTab('nickname')">æ˜µç§°</button>
                    <button class="settings-tab-btn" onclick="switchSettingsTab('background')">èƒŒæ™¯</button>
                    <button class="settings-tab-btn" onclick="switchSettingsTab('role')">è§’è‰²</button>
                </div>

                <div id="avatarTab" class="settings-tab-content active">
                    <div class="avatar-section">
                        <label>æˆ‘çš„å¤´åƒ</label>
                        <div class="avatar-preview" id="userAvatarPreview"></div>
                        <input type="text" id="userAvatarUrl" placeholder="è¾“å…¥å¤´åƒ URL æˆ–è¾“å…¥Emoji..." oninput="updateAvatarPreview('user')" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;">æˆ–é€‰æ‹©æœ¬åœ°å›¾ç‰‡ï¼š</div>
                        <input type="file" id="userAvatarFile" accept="image/*" onchange="handleAvatarFileUpload('user')" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 12px;">
                    </div>

                    <div class="avatar-section">
                        <label>å¯¹æ–¹å¤´åƒ</label>
                        <div class="avatar-preview" id="aiAvatarPreview"></div>
                        <input type="text" id="aiAvatarUrl" placeholder="è¾“å…¥å¤´åƒ URL æˆ–è¾“å…¥Emoji..." oninput="updateAvatarPreview('ai')" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-bottom: 8px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;">æˆ–é€‰æ‹©æœ¬åœ°å›¾ç‰‡ï¼š</div>
                        <input type="file" id="aiAvatarFile" accept="image/*" onchange="handleAvatarFileUpload('ai')" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 12px;">
                    </div>
                </div>

                <div id="nicknameTab" class="settings-tab-content">
                    <div class="avatar-section">
                        <label>æˆ‘çš„æ˜µç§°</label>
                        <input type="text" id="userNickname" placeholder="è¾“å…¥æ‚¨çš„æ˜µç§°..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section">
                        <label>å¯¹æ–¹æ˜µç§°</label>
                        <input type="text" id="aiNickname" placeholder="è¾“å…¥AIçš„æ˜µç§°..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>
                </div>

                <div id="backgroundTab" class="settings-tab-content">
                    <div class="avatar-section">
                        <label>èŠå¤©èƒŒæ™¯é¢œè‰²</label>
                        <input type="color" id="chatBgColor" style="width: 100%; height: 40px; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section">
                        <label>èƒŒæ™¯å›¾ç‰‡ URL</label>
                        <input type="text" id="chatBgImage" placeholder="è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section" style="font-size: 12px; color: #999;">
                        æç¤ºï¼šé¢œè‰²å’Œå›¾ç‰‡éƒ½è®¾ç½®æ—¶ï¼Œå›¾ç‰‡ä¼˜å…ˆæ˜¾ç¤º
                    </div>
                </div>

                <div id="roleTab" class="settings-tab-content">
                    <div class="avatar-section">
                        <label>è§’è‰²åç§°</label>
                        <input type="text" id="editRoleName" placeholder="è§’è‰²åç§°" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;">
                    </div>

                    <div class="avatar-section">
                        <label>ç³»ç»Ÿæç¤ºè¯</label>
                        <textarea id="editSystemPrompt" placeholder="ç³»ç»Ÿæç¤ºè¯..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 12px; height: 100px; resize: none; margin-bottom: 8px;"></textarea>
                    </div>

                    <div class="avatar-section">
                        <label>æ¨¡å‹</label>
                        <select id="editRoleModel" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px;"></select>
                    </div>
                </div>

                <div class="avatar-modal-buttons">
                    <button class="save" onclick="saveAllSettings()">ä¿å­˜</button>
                    <button class="cancel" onclick="closeAvatarSettings()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
    </div> <script>
        // 1. å…¨å±€å˜é‡å’Œåˆå§‹åŒ–
        let currentScreen = 'home';
        const screens = {
            home: document.getElementById('homeScreen'),
            api: document.getElementById('apiScreen'),
            beautify: document.getElementById('beautifyScreen'),
            roleList: document.getElementById('roleListScreen'),
            roleManager: document.getElementById('roleManagerScreen'),
            chatDetail: document.getElementById('chatDetailScreen')
        };
        let roles = [];
        let currentRoleId = null;
        
        // åˆå§‹åŠ è½½ï¼šè¯»å–æœ¬åœ°å­˜å‚¨
        window.onload = function() {
            document.getElementById('apiUrl').value = localStorage.getItem('apiUrl') || '';
            document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
            
            if (localStorage.getItem('apiUrl') && localStorage.getItem('apiKey')) {
                useHardcodedModels();
                const selectedModel = localStorage.getItem('selectedModel');
                if (selectedModel) {
                    const modelSelect = document.getElementById('modelSelect');
                    if (modelSelect.querySelector(`option[value="${selectedModel}"]`)) {
                        modelSelect.value = selectedModel;
                    } else {
                        const option = document.createElement('option');
                        option.value = selectedModel;
                        option.textContent = selectedModel;
                        modelSelect.appendChild(option);
                        modelSelect.value = selectedModel;
                    }
                }
                document.getElementById('modelSelectionArea').style.display = 'block';
                document.getElementById('apiStatus').style.color = 'gray';
                document.getElementById('apiStatus').textContent = 'å½“å‰çŠ¶æ€: å·²åŠ è½½ä¸Šæ¬¡é…ç½®ï¼Œè¯·ç‚¹å‡»â€œæ‹‰å–æ¨¡å‹â€éªŒè¯ã€‚';
            }
            
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            loadRoleList(); 
            loadBeautifySettings();
            // åˆå§‹åŒ–ï¼šä¸»å±å¹•æ·»åŠ  home-mode class
            document.getElementById('appContainer').classList.add('home-mode');
            // å¯åŠ¨æ—¶é’Ÿå¹¶æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            updateClock();
            setInterval(updateClock, 60000);
        };

        // 2. å±å¹•åˆ‡æ¢å‡½æ•°
        function showScreen(screenName) {
            for (let key in screens) {
                screens[key].style.display = 'none';
            }
            screens[screenName].style.display = 'flex'; 
            currentScreen = screenName;
        }

        function showHomeScreen() {
            // æ¢å¤ä¸ºä¸»å±å¹•å¹¶æ˜¾ç¤ºçŠ¶æ€æ 
            document.getElementById('homeScreen').style.display = 'flex';
            screens['api'].style.display = 'none';
            screens['roleList'].style.display = 'none';
            screens['roleManager'].style.display = 'none';
            screens['chatDetail'].style.display = 'none';
            screens['beautify'].style.display = 'none';
            document.querySelector('.status-bar').classList.remove('hidden');
            document.getElementById('appContainer').classList.remove('app-mode');
            document.getElementById('appContainer').classList.add('home-mode');
            currentScreen = 'home';
        }
        
        function showApp(appName) {
            // è¿›å…¥ APP æ—¶éšè—çŠ¶æ€æ ï¼Œè®©APPå†…å®¹é“ºæ»¡å°æ‰‹æœºå±å¹•
            if (appName && appName !== 'home') {
                document.querySelector('.status-bar').classList.add('hidden');
                document.getElementById('appContainer').classList.add('app-mode');
                document.getElementById('appContainer').classList.remove('home-mode');
            }

            screens['home'].style.display = 'none';
            screens['api'].style.display = 'none';
            screens['roleList'].style.display = 'none';
            screens['roleManager'].style.display = 'none';
            screens['chatDetail'].style.display = 'none';
            screens['beautify'].style.display = 'none';
            
            if (appName === 'roleList') {
                screens['roleList'].style.display = 'flex';
                loadRoleList(); 
            } else if (appName === 'roleManager') {
                screens['roleManager'].style.display = 'flex';
                loadModelSelectForRole(); 
            } else if (appName === 'chatDetail') {
                screens['chatDetail'].style.display = 'flex';
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                // ç¡®ä¿èŠå¤©èƒŒæ™¯åœ¨åŠ è½½å®Œæˆååº”ç”¨
                setTimeout(() => applyChatsBackground(), 50);
            } else if (appName === 'beautify') {
                screens['beautify'].style.display = 'flex';
                // å°†å·²ä¿å­˜å€¼å¡«å……åˆ°è¾“å…¥æ¡†
                const bg = localStorage.getItem('beautify_background') || '';
                const iconApi = localStorage.getItem('beautify_icon_api') || '';
                const iconChat = localStorage.getItem('beautify_icon_chat') || '';
                const iconBeautify = localStorage.getItem('beautify_icon_beautifyApp') || '';
                document.getElementById('backgroundUrl').value = bg;
                document.getElementById('iconUrl').value = '';
                document.getElementById('beautifyStatus').textContent = 'å½“å‰çŠ¶æ€: æœªä¿å­˜';
            } else if (appName === 'api') {
                screens['api'].style.display = 'flex';
            } else if (appName === 'chat') { 
                showApp('roleList');
            }
        }
        
        // --- API è®¾ç½®æ ¸å¿ƒé€»è¾‘ ---

        // 3. è¾…åŠ©å‡½æ•°ï¼šæä¾›ç¡¬ç¼–ç çš„æ¨¡å‹åˆ—è¡¨ (ä½œä¸ºæ‹‰å–å¤±è´¥çš„å¤‡ç”¨)
        function getHardcodedModels() {
            return {
                provider: "å†…ç½®é€šç”¨æœåŠ¡",
                models: [
                    'gemini-2.5-flash', 
                    'gemini-2.5-pro',
                    'gpt-4o',
                    'gpt-3.5-turbo',
                    'claude-3-sonnet'
                ]
            };
        }
        
        // 4. æ–°å¢ï¼šä½¿ç”¨ç¡¬ç¼–ç æ¨¡å‹åˆ—è¡¨ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
        function useHardcodedModels() {
            const modelSelect = document.getElementById('modelSelect');
            const statusElement = document.getElementById('apiStatus');
            const { models, provider } = getHardcodedModels();
            
            modelSelect.innerHTML = '';
            models.forEach((model, index) => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
                if (index === 0) {
                    modelSelect.value = model;
                    localStorage.setItem('selectedModel', model); 
                }
            });
            document.getElementById('modelSelectionArea').style.display = 'block';
            statusElement.style.color = 'red';
            statusElement.textContent = `ğŸš¨ è­¦å‘Š: æ— æ³•æ‹‰å–æ¨¡å‹ï¼Œå·²ä½¿ç”¨å†…ç½®åˆ—è¡¨ã€‚`;
        }

        // 5. å®šåˆ¶åŒ–å‡½æ•°ï¼šæ‹‰å–æ¨¡å‹å¹¶ä¿å­˜é…ç½®
        async function fetchModelsAndSave() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusElement = document.getElementById('apiStatus');
            const modelSelect = document.getElementById('modelSelect');

            if (!apiUrl || !apiKey) {
                statusElement.style.color = 'red';
                statusElement.textContent = 'å½“å‰çŠ¶æ€: è¯·å¡«å†™ URL å’Œ Keyï¼';
                document.getElementById('modelSelectionArea').style.display = 'none';
                return;
            }
            
            statusElement.style.color = 'orange';
            statusElement.textContent = 'å½“å‰çŠ¶æ€: æ­£åœ¨å‘åä»£æœåŠ¡è¯·æ±‚æ¨¡å‹åˆ—è¡¨...';
            document.getElementById('modelSelectionArea').style.display = 'none'; 
            
            localStorage.setItem('apiUrl', apiUrl);
            localStorage.setItem('apiKey', apiKey);

            try {
                const base = (apiUrl.endsWith('/')) ? apiUrl.slice(0, -1) : apiUrl;
                const testUrls = [`${base}/models`, `${base}/v1/models`];
                let modelsResult = null;
                
                for (const url of testUrls) {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {'Authorization': `Bearer ${apiKey}`}
                    });
                    
                    if (response.ok) {
                        modelsResult = await response.json();
                        break; 
                    }
                }

                if (modelsResult && modelsResult.data && Array.isArray(modelsResult.data)) {
                    
                    const models = modelsResult.data.map(m => m.id);
                    if (models.length === 0) { throw new Error("APIæ¥å£è¿”å›çš„æ¨¡å‹åˆ—è¡¨ä¸ºç©ºã€‚"); }

                    modelSelect.innerHTML = '';
                    models.forEach((model, index) => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                        
                        if (index === 0) {
                            modelSelect.value = model;
                            localStorage.setItem('selectedModel', model); 
                        }
                    });

                    document.getElementById('modelSelectionArea').style.display = 'block';
                    document.getElementById('apiStatus').style.color = 'green';
                    statusElement.textContent = `å½“å‰çŠ¶æ€: æ¨¡å‹åˆ—è¡¨æ‹‰å–æˆåŠŸ (å…± ${models.length} ä¸ª)ï¼`;

                    modelSelect.onchange = function() {
                        localStorage.setItem('selectedModel', modelSelect.value);
                        document.getElementById('apiStatus').textContent = `å½“å‰çŠ¶æ€: å·²é€‰æ‹©æ¨¡å‹ [${modelSelect.value}]ã€‚`;
                    };

                } else {
                    throw new Error("æ¨¡å‹æ¥å£è¿”å›æ ¼å¼éæ ‡å‡†ï¼Œå›é€€åˆ°å†…ç½®åˆ—è¡¨ã€‚");
                }

            } catch (error) {
                useHardcodedModels(); 
                statusElement.style.color = 'red';
                statusElement.textContent = `ğŸš¨ é”™è¯¯: æ— æ³•æ‹‰å–çœŸå®æ¨¡å‹ã€‚å·²å›é€€åˆ°å†…ç½®åˆ—è¡¨ã€‚`;
                console.error("æ¨¡å‹æ‹‰å–å¤±è´¥ï¼ŒåŸå› ï¼š", error);
            }
        }
        
        // 6. æ–°å¢å‡½æ•°ï¼šæ‰‹åŠ¨æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹
        function addCustomModel() {
            const customInput = document.getElementById('customModelInput');
            const modelSelect = document.getElementById('modelSelect');
            const newModelName = customInput.value.trim();
            const statusElement = document.getElementById('apiStatus');

            if (newModelName) {
                let optionExists = false;
                for (let i = 0; i < modelSelect.options.length; i++) {
                    if (modelSelect.options[i].value === newModelName) {
                        optionExists = true;
                        break;
                    }
                }

                if (!optionExists) {
                    const newOption = document.createElement('option');
                    newOption.value = newModelName;
                    newOption.textContent = newModelName;
                    modelSelect.appendChild(newOption);
                }
                
                modelSelect.value = newModelName;
                localStorage.setItem('selectedModel', newModelName);
                statusElement.style.color = 'green';
                statusElement.textContent = `å½“å‰çŠ¶æ€: å·²æ·»åŠ å¹¶é€‰æ‹©äº†è‡ªå®šä¹‰æ¨¡å‹ [${newModelName}]ã€‚`;
                customInput.value = ''; 
                
            } else {
                alert('è¯·è¾“å…¥è¦æ·»åŠ çš„æ¨¡å‹åç§°ï¼');
            }
        }

        // 6.1 ç¾åŒ–åŠŸèƒ½ï¼šåŠ è½½/åº”ç”¨/é¢„è§ˆ/ä¿å­˜è®¾ç½®
        function loadBeautifySettings() {
            const phone = document.querySelector('.phone-screen');
            const bg = localStorage.getItem('beautify_background');
            if (bg) {
                phone.style.backgroundImage = `url(${bg})`;
                phone.style.backgroundSize = 'cover';
                phone.style.backgroundPosition = 'center';
            } else {
                phone.style.backgroundImage = '';
            }

            // å¦‚æœè®¾ç½®äº†èƒŒæ™¯ï¼Œåˆ™å°†å†…éƒ¨ content åŒºåŸŸèƒŒæ™¯è®¾ä¸ºé€æ˜ä»¥æ˜¾ç¤ºèƒŒæ™¯å›¾
            const contents = document.querySelectorAll('.content');
            if (bg) {
                contents.forEach(c => c.style.background = 'transparent');
            } else {
                contents.forEach(c => c.style.background = '#fff');
            }

            const applyIcon = (dataApp, key) => {
                const img = document.querySelector(`.app-icon img[data-app="${dataApp}"]`);
                const saved = localStorage.getItem(key);
                if (img && saved) img.src = saved;
            };

            applyIcon('api', 'beautify_icon_api');
            applyIcon('chat', 'beautify_icon_chat');
            applyIcon('beautifyApp', 'beautify_icon_beautifyApp');
        }

        // 6.2 çŠ¶æ€æ æ—¶é’Ÿï¼šæ›´æ–°ä¸»å±å¹•å·¦ä¸Šè§’æ—¶é—´
        function updateClock() {
            const el = document.getElementById('statusTime');
            if (!el) return;
            const now = new Date();
            let h = now.getHours();
            const m = now.getMinutes();
            const ampm = h >= 12 ? 'PM' : 'AM';
            let displayH = h % 12;
            if (displayH === 0) displayH = 12;
            el.textContent = `${displayH}:${m.toString().padStart(2,'0')} ${ampm}`;
        }

        function previewBeautify(isPreview) {
            const target = document.getElementById('targetAppSelect').value;
            const iconUrl = document.getElementById('iconUrl').value.trim();
            const bgUrl = document.getElementById('backgroundUrl').value.trim();

            if (isPreview) {
                if (target === 'home-bg') {
                    if (!bgUrl) { alert('è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL ä»¥é¢„è§ˆ'); return; }
                    document.querySelector('.phone-screen').style.backgroundImage = `url(${bgUrl})`;
                    document.querySelector('.phone-screen').style.backgroundSize = 'cover';
                    document.querySelectorAll('.content').forEach(c => c.style.background = 'transparent');
                    document.getElementById('beautifyStatus').textContent = 'å·²é¢„è§ˆèƒŒæ™¯ï¼ˆæœªä¿å­˜ï¼‰';
                } else {
                    if (!iconUrl) { alert('è¯·è¾“å…¥å›¾æ ‡å›¾ç‰‡ URL ä»¥é¢„è§ˆ'); return; }
                    const targetImg = document.querySelector(`.app-icon img[data-app="${target}"]`);
                    if (targetImg) targetImg.src = iconUrl;
                    const previewIcon = document.getElementById('previewIcon');
                    previewIcon.src = iconUrl;
                    previewIcon.style.display = 'block';
                    document.getElementById('previewText').textContent = '';
                    document.getElementById('beautifyStatus').textContent = 'å·²é¢„è§ˆå›¾æ ‡ï¼ˆæœªä¿å­˜ï¼‰';
                }
            } else {
                loadBeautifySettings();
                const previewIcon = document.getElementById('previewIcon');
                previewIcon.style.display = 'none';
                document.getElementById('previewText').textContent = 'åœ¨æ­¤æ˜¾ç¤ºé¢„è§ˆ';
                document.getElementById('beautifyStatus').textContent = 'é¢„è§ˆå·²å–æ¶ˆ';
            }
        }

        function applyAndSaveBeautify() {
            const target = document.getElementById('targetAppSelect').value;
            const iconUrl = document.getElementById('iconUrl').value.trim();
            const bgUrl = document.getElementById('backgroundUrl').value.trim();

            if (target === 'home-bg') {
                if (!bgUrl) { alert('è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL'); return; }
                localStorage.setItem('beautify_background', bgUrl);
                document.querySelectorAll('.content').forEach(c => c.style.background = 'transparent');
            } else {
                if (!iconUrl) { alert('è¯·è¾“å…¥å›¾æ ‡å›¾ç‰‡ URL'); return; }
                const key = `beautify_icon_${target}`;
                localStorage.setItem(key, iconUrl);
            }

            loadBeautifySettings();
            document.getElementById('beautifyStatus').style.color = 'green';
            document.getElementById('beautifyStatus').textContent = 'å½“å‰çŠ¶æ€: ä¿å­˜æˆåŠŸï¼';
            alert('å·²ä¿å­˜ç¾åŒ–è®¾ç½®');
        }
        
        // --- è§’è‰²ç®¡ç†é€»è¾‘ ---
        
        // 9. è¾…åŠ©å‡½æ•°ï¼šåŠ è½½è§’è‰²ç®¡ç†é¡µé¢çš„æ¨¡å‹ä¸‹æ‹‰æ¡†
        function loadModelSelectForRole() {
            const roleModelSelect = document.getElementById('roleModelSelect');
            const apiModelSelect = document.getElementById('modelSelect');
            roleModelSelect.innerHTML = ''; 

            let modelOptions = [];
            if (apiModelSelect && apiModelSelect.options.length > 0) {
                 for (let i = 0; i < apiModelSelect.options.length; i++) {
                    if (apiModelSelect.options[i].value) { 
                        modelOptions.push({
                            value: apiModelSelect.options[i].value,
                            text: apiModelSelect.options[i].textContent
                        });
                    }
                }
            } 
            
            if (modelOptions.length === 0) {
                const hardcoded = getHardcodedModels().models; 
                hardcoded.forEach(model => {
                    modelOptions.push({ value: model, text: model });
                });
            }

            modelOptions.forEach(m => {
                const option = document.createElement('option');
                option.value = m.value;
                option.textContent = m.text;
                roleModelSelect.appendChild(option);
            });
            
            if (roleModelSelect.options.length > 0) {
                 roleModelSelect.value = roleModelSelect.options[0].value;
            }
        }

        // 10. ä¿å­˜è§’è‰²å‡½æ•°
        function saveRole() {
            const name = document.getElementById('roleName').value.trim();
            const prompt = document.getElementById('systemPrompt').value.trim();
            const model = document.getElementById('roleModelSelect').value;

            if (!name || !prompt || !model) {
                alert("è¯·å¡«å†™å®Œæ•´çš„è§’è‰²ä¿¡æ¯!");
                return;
            }

            const newRole = {
                id: Date.now(),
                name: name,
                prompt: prompt,
                model: model,
                history: [] 
            };
            
            roles.push(newRole);
            localStorage.setItem('roles', JSON.stringify(roles));
            
            alert(`è§’è‰² "${name}" å·²ä¿å­˜ï¼`);
            showApp('roleList');
        }
        
        // 11. åŠ è½½è§’è‰²åˆ—è¡¨ (ä¿®å¤ï¼šç¡®ä¿çŸ­æŒ‰å¯ä»¥è¿›å…¥èŠå¤©)
        function loadRoleList() {
            const roleListDiv = document.getElementById('roleList');
            roles = JSON.parse(localStorage.getItem('roles') || '[]');
            roleListDiv.innerHTML = '';
            
            if (roles.length === 0) {
                 roleListDiv.innerHTML = '<div style="text-align: center; color: #888; margin-top: 50px;">æš‚æ— è§’è‰²ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’ â• æ·»åŠ ã€‚</div>';
                 return;
            }

            roles.forEach(role => {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.setAttribute('data-id', role.id);
                
                let pressTimer;
                let isLongPress = false; // æ–°å¢æ ‡è®°ï¼Œç”¨äºåŒºåˆ†æ˜¯é•¿æŒ‰è¿˜æ˜¯çŸ­æŒ‰

                // ç§»é™¤ card.onclickï¼Œæˆ‘ä»¬ä½¿ç”¨ touchend/mouseup æ¥è§¦å‘çŸ­æŒ‰
                
                // å¼€å§‹æŒ‰ä¸‹è®¡æ—¶
                const startPress = (e) => {
                    // âš ï¸ å…³é”®ä¿®æ”¹ 1: ç§»é™¤ e.preventDefault()ï¼Œç¡®ä¿ click äº‹ä»¶å¯ä»¥æ­£å¸¸è§¦å‘
                    isLongPress = false;
                    clearTimeout(pressTimer); 
                    pressTimer = setTimeout(() => {
                        isLongPress = true; // è¾¾åˆ° 500msï¼Œæ ‡è®°ä¸ºé•¿æŒ‰
                        showRoleActionMenu(role.id);
                        // âš ï¸ å…³é”®ï¼šè¿™é‡Œä¸éœ€è¦é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè®©é•¿æŒ‰èœå•æ˜¾ç¤ºå³å¯
                    }, 500); 
                };

                // ç»“æŸæŒ‰ä¸‹ï¼šåˆ¤æ–­æ˜¯çŸ­æŒ‰è¿˜æ˜¯é•¿æŒ‰
                const endPress = () => {
                    clearTimeout(pressTimer);
                    if (!isLongPress) {
                        // å¦‚æœè®¡æ—¶å™¨è¢«æ¸…é™¤äº†ï¼Œä¸”ä¸æ˜¯é•¿æŒ‰ï¼Œåˆ™è®¤ä¸ºæ˜¯çŸ­æŒ‰
                        // âš ï¸ å…³é”®ä¿®æ”¹ 2: çŸ­æŒ‰æ—¶ç›´æ¥è°ƒç”¨ startChatï¼Œä¸ä¾èµ– click äº‹ä»¶ç±»å‹
                        startChat(role.id);
                    }
                    isLongPress = false; // é‡ç½®
                };
                
                const cancelPress = () => {
                    clearTimeout(pressTimer);
                    isLongPress = false;
                }

                // ç»Ÿä¸€å¤„ç†è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
                card.addEventListener('touchstart', startPress, false);
                card.addEventListener('touchend', endPress, false); // æŠ¬èµ·æ—¶è§¦å‘çŸ­æŒ‰é€»è¾‘
                card.addEventListener('mousedown', startPress, false);
                card.addEventListener('mouseup', endPress, false); // æŠ¬èµ·æ—¶è§¦å‘çŸ­æŒ‰é€»è¾‘
                card.addEventListener('mouseleave', cancelPress, false); 
                card.addEventListener('click', (e) => e.preventDefault(), false); // é˜»æ­¢å¯èƒ½æ®‹ç•™çš„ click è¡Œä¸º

                const avatar = document.createElement('div');
                avatar.className = 'role-avatar';
                avatar.textContent = role.name[0].toUpperCase();

                const info = document.createElement('div');
                info.className = 'role-info';
                info.innerHTML = `<h3>${role.name}</h3>
                                  <p>æ¨¡å‹: ${role.model} - ${role.prompt.substring(0, 30)}...</p>`;

                card.appendChild(avatar);
                card.appendChild(info);
                roleListDiv.appendChild(card);
            });
        }
        
       // 12. å¼€å§‹èŠå¤© (ç§»é™¤äº‹ä»¶æ£€æŸ¥ï¼Œè¢« loadRoleList ç›´æ¥è°ƒç”¨)
        function startChat(roleId) {
            currentRoleId = roleId;
            const role = roles.find(r => r.id === roleId);
            
            if (!role) {
                 alert("è§’è‰²ä¸å­˜åœ¨ï¼");
                 return;
            }

            // ä½¿ç”¨å¯¹æ–¹æ˜µç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è§’è‰²åç§°
            const aiNickname = localStorage.getItem('chat_ai_nickname') || '';
            const displayName = aiNickname || role.name;
            document.getElementById('chatDetailTitle').textContent = displayName;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            // åŠ è½½èŠå¤©å†å²è®°å½•
            loadChatHistory(roleId); 
            
            showApp('chatDetail');
        }
        
        // 13. æ˜¾ç¤ºè§’è‰²æ“ä½œèœå• (ä¿®å¤ Z-Index é®æŒ¡)
        let roleIdToDelete = null; 
        const menuElement = document.getElementById('roleActionMenu'); 

        function showRoleActionMenu(roleId) {
            roleIdToDelete = roleId;
            menuElement.style.display = 'block'; 
            menuElement.classList.add('is-active'); 
        }

        // 14. éšè—è§’è‰²æ“ä½œèœå•
        function hideRoleActionMenu() {
            menuElement.classList.remove('is-active');
            
            setTimeout(() => {
                menuElement.style.display = 'none'; 
            }, 100); 
            
            roleIdToDelete = null;
        }

        // 15. ç¡®è®¤åˆ é™¤è§’è‰²
        function confirmDeleteRole() {
            if (roleIdToDelete === null) return;
            
            const roleIndex = roles.findIndex(r => r.id === roleIdToDelete);
            if (roleIndex > -1) {
                const roleName = roles[roleIndex].name;
                
                roles.splice(roleIndex, 1);
                localStorage.setItem('roles', JSON.stringify(roles));
                
                // åŒæ—¶åˆ é™¤èŠå¤©è®°å½•
                localStorage.removeItem(`chat_history_${roleIdToDelete}`); 
                
                alert(`è§’è‰² "${roleName}" å·²åˆ é™¤ã€‚`);
                hideRoleActionMenu();
                loadRoleList(); 
            }
        }
        
        // 15.1 ç¡®è®¤æ¸…ç©ºèŠå¤©è®°å½•
        function confirmClearHistory() {
            if (roleIdToDelete === null) return;
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥è§’è‰²çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                clearChatHistory(roleIdToDelete);
                hideRoleActionMenu();
            }
        }


        // --- èŠå¤©æ ¸å¿ƒé€»è¾‘ ---

        // 7. åŠ¨æ€æ·»åŠ æ¶ˆæ¯æ°”æ³¡ï¼ˆå¸¦å¤´åƒï¼‰
        function appendMessage(sender, text, shouldSave = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡å®¹å™¨
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${sender === 'user' ? 'sent' : 'received'}`;
            
            // åˆ›å»ºå¤´åƒ
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            if (sender === 'user') {
                const userAvatarUrl = localStorage.getItem('chat_user_avatar_url') || '';
                const userAvatarEmoji = localStorage.getItem('chat_user_avatar_emoji') || 'ğŸ‘¤'; // é»˜è®¤emoji
                
                if (userAvatarUrl && (userAvatarUrl.startsWith('http') || userAvatarUrl.startsWith('data:'))) {
                    const img = document.createElement('img');
                    img.src = userAvatarUrl;
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = userAvatarEmoji.substring(0,2); // ç¡®ä¿åªæ˜¾ç¤ºå°‘é‡æ–‡å­—/emoji
                }
            } else {
                const aiAvatarUrl = localStorage.getItem('chat_ai_avatar_url') || '';
                const aiAvatarEmoji = localStorage.getItem('chat_ai_avatar_emoji') || 'ğŸ¤–'; // é»˜è®¤emoji
                
                if (aiAvatarUrl && (aiAvatarUrl.startsWith('http') || aiAvatarUrl.startsWith('data:'))) {
                    const img = document.createElement('img');
                    img.src = aiAvatarUrl;
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = aiAvatarEmoji.substring(0,2);
                }
            }
            
            // åˆ›å»ºæ¶ˆæ¯å†…å®¹
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === 'user' ? 'sent' : 'received'}`;
            messageDiv.textContent = text;
            
            // ç»„è£…æ°”æ³¡
            if (sender === 'user') {
                bubbleDiv.appendChild(messageDiv);
                bubbleDiv.appendChild(avatarDiv);
            } else {
                bubbleDiv.appendChild(avatarDiv);
                bubbleDiv.appendChild(messageDiv);
            }
            
            chatMessages.appendChild(bubbleDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // ä¿å­˜æ¶ˆæ¯åˆ° localStorageï¼ˆå¦‚æœshouldSaveä¸ºtrueï¼‰
            if (shouldSave && currentRoleId) {
                saveChatMessage(currentRoleId, sender, text);
            }
        }


        // 7.1 ä¿å­˜èŠå¤©æ¶ˆæ¯åˆ° localStorage
        function saveChatMessage(roleId, sender, text) {
            const key = `chat_history_${roleId}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.push({
                sender: sender,
                text: text,
                timestamp: Date.now()
            });
            localStorage.setItem(key, JSON.stringify(history));
        }
        
        // 7.2 åŠ è½½èŠå¤©å†å²è®°å½•
        function loadChatHistory(roleId) {
            const key = `chat_history_${roleId}`;
            const history = JSON.parse(localStorage.getItem(key) || '[]');
            const chatMessages = document.getElementById('chatMessages');

            if (history.length === 0) {
                // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                const role = roles.find(r => r.id === roleId);
                if (role) {
                    appendMessage('ai', `ğŸ‘‹ æ‚¨å¥½ï¼Œæˆ‘æ˜¯ ${role.name}ã€‚æˆ‘çš„ç³»ç»Ÿæç¤ºè¯æ˜¯ï¼šâ€œ${role.prompt}â€`, false);
                }
            } else {
                // åŠ è½½æ‰€æœ‰å†å²æ¶ˆæ¯
                history.forEach(msg => {
                    appendMessage(msg.sender, msg.text, false);
                });
            }
        }
        
        // 7.3 æ¸…ç©ºèŠå¤©è®°å½•
        function clearChatHistory(roleId) {
            if (!roleId) return;
            const key = `chat_history_${roleId}`;
            localStorage.removeItem(key);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            const role = roles.find(r => r.id === roleId);
            if (role) {
                appendMessage('ai', `ğŸ’¬ èŠå¤©è®°å½•å·²æ¸…ç©ºã€‚æˆ‘æ˜¯ ${role.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼`, false);
            }
        }

        // 8. èŠå¤©æ¶ˆæ¯å‘é€å‡½æ•° (è¿æ¥çœŸå® API)
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const messageText = input.value.trim();
            
            if (!messageText) return; 

            const apiUrl = localStorage.getItem('apiUrl');
            const apiKey = localStorage.getItem('apiKey');
            const role = roles.find(r => r.id === currentRoleId);
            
            if (!apiUrl || !apiKey || !role) {
                 appendMessage('ai', 'âŒ é”™è¯¯ï¼šè¯·å…ˆåœ¨ API APP é…ç½®å¯†é’¥ï¼Œå¹¶åˆ›å»º/é€‰æ‹©ä¸€ä¸ªè§’è‰²ã€‚');
                 return;
            }
            const model = role.model; 
            const systemPrompt = role.prompt;
            
            appendMessage('user', messageText);
            input.value = '';
            
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            // --- æ·»åŠ  "æ€è€ƒä¸­" æ¶ˆæ¯æ°”æ³¡ ---
            const thinkingBubbleDiv = document.createElement('div');
            thinkingBubbleDiv.className = 'message-bubble received thinking-bubble';
            
            const thinkingAvatarDiv = document.createElement('div');
            thinkingAvatarDiv.className = 'message-avatar';
            const aiAvatarUrl = localStorage.getItem('chat_ai_avatar_url') || '';
            const aiAvatarEmoji = localStorage.getItem('chat_ai_avatar_emoji') || 'ğŸ¤–';
            if (aiAvatarUrl && (aiAvatarUrl.startsWith('http') || aiAvatarUrl.startsWith('data:'))) {
                const img = document.createElement('img');
                img.src = aiAvatarUrl;
                thinkingAvatarDiv.appendChild(img);
            } else {
                thinkingAvatarDiv.textContent = aiAvatarEmoji.substring(0,2);
            }
            
            const thinkingMessageDiv = document.createElement('div');
            thinkingMessageDiv.className = 'message received thinking';
            thinkingMessageDiv.textContent = 'æ€è€ƒä¸­...';
            
            thinkingBubbleDiv.appendChild(thinkingAvatarDiv);
            thinkingBubbleDiv.appendChild(thinkingMessageDiv);
            document.getElementById('chatMessages').appendChild(thinkingBubbleDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const fullUrl = (apiUrl.endsWith('/')) ? `${apiUrl}chat/completions` : `${apiUrl}/v1/chat/completions`;
                
                // ä»å†å²è®°å½•ä¸­æ„å»ºæ¶ˆæ¯ä½“
                const historyKey = `chat_history_${currentRoleId}`;
                const history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                // ä»…å‘é€æœ€è¿‘çš„å‡ æ¡å†å²è®°å½• + å½“å‰æ¶ˆæ¯ï¼Œä»¥é˜²æ­¢è¯·æ±‚ä½“è¿‡å¤§
                let messages = history.slice(-10).map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: msg.text
                }));

                // ç¡®ä¿ç³»ç»Ÿæç¤ºè¯åœ¨æœ€å‰é¢
                messages.unshift({ role: "system", content: systemPrompt });

                // ç§»é™¤æ€è€ƒä¸­æ¶ˆæ¯
                const removeThinking = () => {
                    const thinkingBubble = chatMessages.querySelector('.thinking-bubble');
                    if (thinkingBubble) {
                        chatMessages.removeChild(thinkingBubble);
                    }
                };
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages, 
                        stream: false
                    })
                });

                removeThinking();

                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({error: {message: 'APIè¿”å›äº†éJSONé”™è¯¯ä¿¡æ¯ã€‚'}}));
                    const errorMessage = errorJson.error?.message || `API é”™è¯¯ (çŠ¶æ€ç : ${response.status})ã€‚è¯·æ£€æŸ¥ Key æˆ– URLã€‚`;
                    appendMessage('ai', `âŒ API è°ƒç”¨å¤±è´¥: ${errorMessage.substring(0, 150)}`);
                    return;
                }

                const result = await response.json();
                
                const aiResponseText = result.choices?.[0]?.message?.content || "AIæœªè¿”å›æœ‰æ•ˆå†…å®¹ã€‚";
                appendMessage('ai', aiResponseText);

            } catch (error) {
                const thinkingBubble = chatMessages.querySelector('.thinking-bubble');
                if (thinkingBubble) {
                    chatMessages.removeChild(thinkingBubble);
                }
                appendMessage('ai', `ğŸš¨ è¿æ¥å¤±è´¥ï¼šç½‘ç»œæˆ–è·¨åŸŸ(CORS)é”™è¯¯ã€‚è¯·ç¡®è®¤åä»£æœåŠ¡å·²å¼€å¯ CORSï¼ (${error.message.substring(0, 100)})`);

            } finally {
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                input.focus();
            }
        }

        // 16. èŠå¤©è®¾ç½®åŠŸèƒ½ï¼ˆå¤´åƒã€æ˜µç§°ã€èƒŒæ™¯ã€è§’è‰²ï¼‰
        function showAvatarSettings() {
            const modal = document.getElementById('avatarSettingsModal');
            // åŠ è½½å¤´åƒè®¾ç½®
            const userAvatarUrl = localStorage.getItem('chat_user_avatar_url') || '';
            const userAvatarEmoji = localStorage.getItem('chat_user_avatar_emoji') || '';
            const aiAvatarUrl = localStorage.getItem('chat_ai_avatar_url') || '';
            const aiAvatarEmoji = localStorage.getItem('chat_ai_avatar_emoji') || '';
            document.getElementById('userAvatarUrl').value = userAvatarUrl || userAvatarEmoji;
            document.getElementById('aiAvatarUrl').value = aiAvatarUrl || aiAvatarEmoji;
            updateAvatarPreview('user');
            updateAvatarPreview('ai');
            // åŠ è½½æ˜µç§°è®¾ç½®
            const userNickname = localStorage.getItem('chat_user_nickname') || '';
            const aiNickname = localStorage.getItem('chat_ai_nickname') || '';
            document.getElementById('userNickname').value = userNickname;
            document.getElementById('aiNickname').value = aiNickname;
            // åŠ è½½èƒŒæ™¯è®¾ç½®
            const chatBgColor = localStorage.getItem('chat_bg_color') || '#f8f8f8';
            const chatBgImage = localStorage.getItem('chat_bg_image') || '';
            document.getElementById('chatBgColor').value = chatBgColor;
            document.getElementById('chatBgImage').value = chatBgImage;
            // åŠ è½½è§’è‰²è®¾ç½®
            if (currentRoleId) {
                const role = roles.find(r => r.id === currentRoleId);
                if (role) {
                    document.getElementById('editRoleName').value = role.name;
                    document.getElementById('editSystemPrompt').value = role.prompt;
                    
                    // åŠ è½½æ¨¡å‹é€‰æ‹©
                    const editRoleModel = document.getElementById('editRoleModel');
                    const apiModelSelect = document.getElementById('modelSelect');
                    editRoleModel.innerHTML = '';
                    
                    // ä¼˜å…ˆä» API APP çš„ä¸‹æ‹‰æ¡†ä¸­å¤åˆ¶é€‰é¡¹
                    if (apiModelSelect && apiModelSelect.options.length > 0) {
                        for (let i = 0; i < apiModelSelect.options.length; i++) {
                            if (apiModelSelect.options[i].value) {
                                const option = document.createElement('option');
                                option.value = apiModelSelect.options[i].value;
                                option.textContent = apiModelSelect.options[i].textContent;
                                editRoleModel.appendChild(option);
                            }
                        }
                    } else {
                        const hardcoded = getHardcodedModels().models;
                        hardcoded.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            editRoleModel.appendChild(option);
                        });
                    }
                    
                    editRoleModel.value = role.model;
                }
            }
            
            modal.style.display = 'flex';
            modal.classList.add('is-active');
        }

        function switchSettingsTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // å–æ¶ˆæ¿€æ´»æ‰€æœ‰æ ‡ç­¾æŒ‰é’®
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            const tabId = {
                'avatar': 'avatarTab',
                'nickname': 'nicknameTab',
                'background': 'backgroundTab',
                'role': 'roleTab'
            }[tabName];
            if (tabId) {
                document.getElementById(tabId).classList.add('active');
                // ç¡®ä¿ç‚¹å‡»çš„æŒ‰é’®è¢«æ¿€æ´»
                if(event.target.classList.contains('settings-tab-btn')) {
                    event.target.classList.add('active');
                } else {
                    document.querySelector(`.settings-tabs button[onclick*="${tabName}"]`).classList.add('active');
                }
            }
        }

        function closeAvatarSettings() {
            const modal = document.getElementById('avatarSettingsModal');
            modal.classList.remove('is-active');
            // ä¸ç«‹å³éšè—displayï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                if (!modal.classList.contains('is-active')) {
                    modal.style.display = 'none';
                }
            }, 300);
        }

        function handleAvatarFileUpload(type) {
            const fileInputId = type === 'user' ? 'userAvatarFile' : 'aiAvatarFile';
            const inputId = type === 'user' ? 'userAvatarUrl' : 'aiAvatarUrl';
            
            const fileInput = document.getElementById(fileInputId);
            const file = fileInput.files[0];
            
            if (!file) return;
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º 1MBï¼‰
            if (file.size > 1024 * 1024) {
                alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 1MB çš„å›¾ç‰‡');
                fileInput.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                // å°† Data URL ä¿å­˜åˆ°è¾“å…¥æ¡†
                document.getElementById(inputId).value = dataUrl;
                // æ›´æ–°é¢„è§ˆ
                updateAvatarPreview(type);
            };
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        function updateAvatarPreview(type) {
            const inputId = type === 'user' ? 'userAvatarUrl' : 'aiAvatarUrl';
            const previewId = type === 'user' ? 'userAvatarPreview' : 'aiAvatarPreview';
            
            const value = document.getElementById(inputId).value.trim();
            const preview = document.getElementById(previewId);
            
            preview.innerHTML = '';
            
            if (value && (value.startsWith('http') || value.startsWith('data:'))) {
                const img = document.createElement('img');
                img.src = value;
                img.onerror = function() {
                    preview.textContent = 'âŒ'; 
                };
                preview.appendChild(img);
            } else if (value) {
                preview.textContent = value.substring(0,2);
                preview.style.fontSize = '32px';
            } else {
                preview.textContent = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
                preview.style.fontSize = '32px';
            }
        }

        function saveAllSettings() {
            // ä¿å­˜å¤´åƒ
            const userValue = document.getElementById('userAvatarUrl').value.trim();
            const aiValue = document.getElementById('aiAvatarUrl').value.trim();
            
            if (!userValue || !aiValue) {
                alert('è¯·å¡«å†™å®Œæ•´çš„å¤´åƒä¿¡æ¯ï¼');
                return;
            }
            
            // åŒºåˆ†URLã€Data URLï¼ˆæœ¬åœ°ä¸Šä¼ ï¼‰å’ŒEmoji
            if (userValue.startsWith('http') || userValue.startsWith('data:')) {
                localStorage.setItem('chat_user_avatar_url', userValue);
                localStorage.removeItem('chat_user_avatar_emoji');
            } else {
                localStorage.setItem('chat_user_avatar_emoji', userValue);
                localStorage.removeItem('chat_user_avatar_url');
            }
            
            if (aiValue.startsWith('http') || aiValue.startsWith('data:')) {
                localStorage.setItem('chat_ai_avatar_url', aiValue);
                localStorage.removeItem('chat_ai_avatar_emoji');
            } else {
                localStorage.setItem('chat_ai_avatar_emoji', aiValue);
                localStorage.removeItem('chat_ai_avatar_url');
            }
            
            // ä¿å­˜æ˜µç§°
            const userNickname = document.getElementById('userNickname').value.trim();
            const aiNickname = document.getElementById('aiNickname').value.trim();
            localStorage.setItem('chat_user_nickname', userNickname);
            localStorage.setItem('chat_ai_nickname', aiNickname);
            
            // å¦‚æœåœ¨èŠå¤©ç•Œé¢ï¼Œæ›´æ–°é¡¶éƒ¨æ˜¾ç¤ºçš„æ˜µç§°
            if (currentRoleId && currentScreen === 'chatDetail') {
                const displayName = aiNickname || document.getElementById('chatDetailTitle').textContent;
                document.getElementById('chatDetailTitle').textContent = displayName;
            }
            
            // ä¿å­˜èƒŒæ™¯
            const chatBgColor = document.getElementById('chatBgColor').value;
            const chatBgImage = document.getElementById('chatBgImage').value.trim();
            localStorage.setItem('chat_bg_color', chatBgColor);
            localStorage.setItem('chat_bg_image', chatBgImage);
            
            // ä¿å­˜è§’è‰²è®¾ç½®
            if (currentRoleId) {
                const newName = document.getElementById('editRoleName').value.trim();
                const newPrompt = document.getElementById('editSystemPrompt').value.trim();
                const newModel = document.getElementById('editRoleModel').value;
                
                if (!newName || !newPrompt || !newModel) {
                    alert('è¯·å¡«å†™å®Œæ•´çš„è§’è‰²ä¿¡æ¯ï¼');
                    return;
                }
                
                const roleIndex = roles.findIndex(r => r.id === currentRoleId);
                if (roleIndex > -1) {
                    roles[roleIndex].name = newName;
                    roles[roleIndex].prompt = newPrompt;
                    roles[roleIndex].model = newModel;
                    localStorage.setItem('roles', JSON.stringify(roles));
                    // å¦‚æœæœ‰æ˜µç§°åˆ™æ˜¾ç¤ºæ˜µç§°ï¼Œå¦åˆ™æ˜¾ç¤ºæ–°çš„è§’è‰²åç§°
                    const aiNickname = localStorage.getItem('chat_ai_nickname') || '';
                    const displayName = aiNickname || newName;
                    document.getElementById('chatDetailTitle').textContent = displayName;
                }
            }
            
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
            closeAvatarSettings();
            
            // åº”ç”¨èƒŒæ™¯
            applyChatsBackground();
            // åˆ·æ–°æ¶ˆæ¯æ˜¾ç¤º (åº”ç”¨æ–°çš„å¤´åƒ/æ˜µç§°)
            refreshChatMessages();
        }

        function applyChatsBackground() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            const bgColor = localStorage.getItem('chat_bg_color') || '#f8f8f8';
            const bgImage = localStorage.getItem('chat_bg_image') || '';
            
            chatMessages.style.backgroundColor = bgColor;
            if (bgImage) {
                chatMessages.style.backgroundImage = `url(${bgImage})`;
                chatMessages.style.backgroundSize = 'cover';
                chatMessages.style.backgroundPosition = 'center';
            } else {
                chatMessages.style.backgroundImage = 'none';
            }
        }

        function refreshChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages.children.length > 0) {
                // ä¿å­˜å½“å‰æ¶ˆæ¯å†…å®¹
                const messages = [];
                // éå†æ‰€æœ‰çš„ message-bubble
                for (let i = 0; i < chatMessages.children.length; i++) {
                    const bubble = chatMessages.children[i];
                    const messageEl = bubble.querySelector('.message');
                    // è·³è¿‡ "æ€è€ƒä¸­..." æ°”æ³¡
                    if (messageEl && !messageEl.classList.contains('thinking')) {
                        const sender = messageEl.classList.contains('sent') ? 'user' : 'ai';
                        messages.push({ sender, text: messageEl.textContent });
                    }
                }
                
                // æ¸…ç©ºå¹¶é‡æ–°æ˜¾ç¤º
                chatMessages.innerHTML = '';
                messages.forEach(msg => {
                    // ä½¿ç”¨ shouldSave=false é¿å…äºŒæ¬¡ä¿å­˜
                    appendMessage(msg.sender, msg.text, false); 
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            applyChatsBackground();
        }

    </script>
</body>
</html>
